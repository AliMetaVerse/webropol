<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Email Campaign Creator</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50 min-h-screen">
        <div class="container mx-auto px-4 py-8 max-w-8xl">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Email Campaign Creator</h1>
                        <p class="text-gray-600 mt-1">Create and send professional email campaigns</p>
                    </div>                    <div class="flex items-center space-x-2">
                        <button onclick="openSettingsModal()" class="flex items-center space-x-2 px-3 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition duration-200">
                            <i class="fas fa-cog text-sm"></i>
                            <span class="text-sm font-medium">Settings</span>
                        </button>
                        <div id="connectionStatus" class="flex items-center space-x-2 px-3 py-1 rounded-full bg-yellow-100 text-yellow-800">
                            <i class="fas fa-spinner fa-spin text-sm"></i>
                            <span class="text-sm font-medium">Connecting...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Email Configuration Panel -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-envelope mr-2 text-blue-600"></i>
                            Campaign Details
                        </h2>
                        <!-- Email Details -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Name</label>
                            <input
                                type="text"
                                id="campaignName"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter campaign name"
                            >
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">From Name</label>
                            <input
                                type="text"
                                id="fromName"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Your Name"
                            >
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">From Email</label>
                            <input
                                type="email"
                                id="fromEmail"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="your@email.com"
                            >
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subject Line</label>
                            <input
                                type="text"
                                id="emailSubject"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter email subject"
                            >
                        </div>
                        <!-- Recipients -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Recipients</label>
                            <div class="space-y-2">
                                <textarea
                                    id="recipients"
                                    rows="4"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter email addresses (one per line)&#10;example1@email.com&#10;example2@email.com"
                                ></textarea>
                                <div class="flex items-center space-x-2">
                                    <input
                                        type="email"
                                        id="singleRecipient"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Add recipient"
                                    >
                                    <button onclick="addRecipient()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">
                                Total recipients:
                                <span id="recipientCount">0</span>
                            </p>
                        </div>
                        <!-- Test Email -->
                        <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                            <h3 class="text-sm font-medium text-yellow-800 mb-2">Send Test Email</h3>
                            <div class="flex space-x-2">
                                <input
                                    type="email"
                                    id="testEmail"
                                    class="flex-1 px-3 py-2 border border-yellow-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    placeholder="test@email.com"
                                >
                                <button onclick="sendTestEmail()" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                                    Test
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Campaign Stats -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Campaign Stats</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Recipients:</span>
                                <span id="statsRecipients" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Emails Sent:</span>
                                <span id="statsSent" class="font-semibold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Failed:</span>
                                <span id="statsFailed" class="font-semibold text-red-600">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Success Rate:</span>
                                <span id="statsRate" class="font-semibold">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Email Editor -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                                <i class="fas fa-edit mr-2 text-blue-600"></i>
                                Email Content Editor
                            </h2>                            <div class="flex space-x-2">
                                <button onclick="loadTemplate('newsletter')" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition duration-200 text-sm">
                                    Newsletter Template
                                </button>
                                <button onclick="loadTemplate('promotional')" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition duration-200 text-sm">
                                    Promotional Template
                                </button>
                                <button onclick="loadTemplate('webropol')" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition duration-200 text-sm">
                                    Webropol Template
                                </button>
                                <button onclick="clearEditor()" class="px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition duration-200 text-sm">
                                    Clear
                                </button>
                            </div>
                        </div>
                        <!-- CKEditor Container -->
                        <div id="editor" class="min-h-96"></div>
                    </div>
                    <!-- Send Campaign -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Ready to Send?</h3>
                                <p class="text-gray-600 text-sm">Review your campaign and send to all recipients</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="previewEmail()" class="px-6 py-3 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition duration-200 flex items-center">
                                    <i class="fas fa-eye mr-2"></i>
                                    Preview
                                </button>
                                <button onclick="sendCampaign()" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200 flex items-center">
                                    <i class="fas fa-paper-plane mr-2"></i>
                                    Send Campaign
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Progress Modal -->
            <div id="progressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <i class="fas fa-paper-plane text-4xl text-blue-600 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Sending Campaign</h3>
                        <p class="text-gray-600 mb-4">Please wait while we send your emails...</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="text-sm text-gray-600">
                            <span id="progressText">Preparing to send...</span>
                        </div>
                    </div>
                </div>
            </div>            <!-- Settings Modal -->
            <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-cog mr-2 text-blue-600"></i>
                            Configuration Settings
                        </h3>
                        <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="max-h-[70vh] overflow-y-auto">
                        <!-- Service Configuration -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">EmailJS Service ID</label>
                            <input
                                type="text"
                                id="modalServiceId"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="your_service_id"
                            >
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">EmailJS Template ID</label>
                            <input
                                type="text"
                                id="modalTemplateId"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="your_template_id"
                            >
                        </div>
                        
                        <!-- HTML Template Setup -->
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                            <h3 class="text-sm font-medium text-blue-800 mb-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                HTML Template Setup Required
                            </h3>
                            <p class="text-xs text-blue-700 mb-2">
                                Create a simple EmailJS template with this content to enable HTML email sending:
                            </p>
                            <div class="text-xs bg-white p-2 rounded border font-mono">
                                <strong>EmailJS Template Settings:</strong><br>
                                To: {{user_email}}<br>
                                From: {{from_name}} &lt;{{reply_to}}&gt;<br>
                                Subject: {{subject}}<br><br>
                                <strong>Template Content:</strong><br>
                                {{{html_content}}}
                            </div>
                            <p class="text-xs text-blue-600 mt-2">
                                <strong>Critical:</strong> Set the "To" field in EmailJS dashboard to: <code>{{user_email}}</code> or <code>{{to}}</code><br>
                                The triple braces {{{html_content}}} allow raw HTML injection from your CKEditor content.<br>
                                Parameters: to, user_email, user_name, from_name, reply_to, subject, message, html_content
                            </p>
                        </div>

                        <!-- Configuration Test -->
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                            <h3 class="text-sm font-medium text-blue-800 mb-2">Test Configuration</h3>
                            <button onclick="testEmailJSConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 text-sm">
                                <i class="fas fa-check-circle mr-1"></i>
                                Test EmailJS Setup
                            </button>
                            <p class="text-xs text-blue-600 mt-1">Verify your EmailJS service and template configuration</p>
                        </div>

                        <!-- Debug Console -->
                        <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-md">
                            <h3 class="text-sm font-medium text-gray-800 mb-2">
                                <i class="fas fa-bug mr-1"></i>
                                Debug Console
                            </h3>
                            <div class="flex space-x-2 mb-2">
                                <button onclick="toggleDebugConsole()" class="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">
                                    Show/Hide Debug
                                </button>
                                <button onclick="clearFormData()" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                                    Clear Session
                                </button>
                            </div>
                            <div id="debugConsole" class="hidden mt-3 p-3 bg-black text-green-400 rounded text-xs font-mono max-h-32 overflow-y-auto">
                                <div id="debugOutput"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                        <button onclick="closeSettingsModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200">
                            Cancel
                        </button>
                        <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Modal -->
            <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-96 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Email Preview</h3>
                        <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="border border-gray-300 rounded-md p-4 max-h-80 overflow-y-auto">
                        <div class="mb-4 p-3 bg-gray-50 border-l-4 border-blue-500">
                            <div class="text-sm text-gray-600">
                                <strong>Subject:</strong>
                                <span id="previewSubject"></span>
                            </div>
                            <div class="text-sm text-gray-600">
                                <strong>From:</strong>
                                <span id="previewFrom"></span>
                            </div>
                        </div>
                        <div id="previewContent" class="prose max-w-none"></div>
                    </div>
                </div>
            </div>
        </div>
        <script>
        let editor;
        let emailJSInitialized = false;
        const PUBLIC_KEY = 'WkloAEeQols8UpWuh';

        // Initialize EmailJS
        function initializeEmailJS() {
            try {
                if (typeof emailjs === 'undefined') {
                    throw new Error('EmailJS library not loaded');
                }
                
                emailjs.init(PUBLIC_KEY);
                emailJSInitialized = true;
                updateConnectionStatus('connected', 'Connected to EmailJS');
                console.log('EmailJS initialized successfully');
                logToDebugConsole('EmailJS initialized successfully with public key: ' + PUBLIC_KEY);
            } catch (error) {
                console.error('Failed to initialize EmailJS:', error);
                updateConnectionStatus('error', 'Connection failed');
                logToDebugConsole('Failed to initialize EmailJS: ' + error.message);
            }
        }        // Validate EmailJS configuration
        async function validateEmailJSConfig() {
            const serviceId = document.getElementById('serviceId').value;
            const templateId = document.getElementById('templateId').value;

            if (!serviceId || !templateId) {
                return { valid: false, message: 'Please enter Service ID and Template ID' };
            }

            if (!emailJSInitialized) {
                return { valid: false, message: 'EmailJS not initialized' };
            }            try {
                // Test the configuration with HTML template parameters
                const testParams = {
                    to: 'test@example.com',         // Alternative: try 'to' instead of 'user_email'
                    user_email: 'test@example.com', // Keep both for compatibility
                    user_name: 'Test Recipient',
                    from_name: 'Test Sender',
                    reply_to: 'test@example.com',
                    subject: 'Configuration Test',
                    message: '<p>This is a configuration test for HTML email template.</p>',
                    html_content: '<p>This is a configuration test for HTML email template.</p>'
                };
                
                // This will fail due to invalid recipient, but will validate the service and template IDs
                await emailjs.send(serviceId, templateId, testParams);
                return { valid: true, message: 'Configuration valid' };
            } catch (error) {
                if (error.status === 400) {
                    return { valid: false, message: 'Invalid service or template ID' };
                } else if (error.status === 401) {
                    return { valid: false, message: 'Invalid public key or unauthorized' };
                } else if (error.status === 404) {
                    return { valid: false, message: 'Service or template not found' };
                } else {
                    // Other errors might still mean the config is valid (e.g., bad recipient)
                    return { valid: true, message: 'Configuration appears valid' };
                }
            }
        }// Test EmailJS configuration
        async function testEmailJSConfig() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            button.disabled = true;

            try {
                const result = await validateEmailJSConfig();                if (result.valid) {
                    alert('‚úÖ Configuration test passed!\n\n' + result.message + '\n\nYou can now send HTML emails using your template.');
                    logToDebugConsole('Configuration test passed: ' + result.message);
                } else {
                    alert('‚ùå Configuration test failed!\n\n' + result.message + '\n\nPlease check your EmailJS settings.');
                    logToDebugConsole('Configuration test failed: ' + result.message);
                }
            } catch (error) {
                console.error('Configuration test error:', error);
                logToDebugConsole('Configuration test error: ' + error.message);
                alert('‚ùå Configuration test failed!\n\nError: ' + (error.message || 'Unknown error'));
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }        // Note: testTemplateParameters function removed as we now use direct HTML email sending
        // No longer need to test template parameters since we bypass templates entirely

        // Update connection status
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            const statusClasses = {
                'connecting': 'bg-yellow-100 text-yellow-800',
                'connected': 'bg-green-100 text-green-800',
                'error': 'bg-red-100 text-red-800'
            };
            
            const statusIcons = {
                'connecting': 'fas fa-spinner fa-spin',
                'connected': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle'
            };

            statusElement.className = `flex items-center space-x-2 px-3 py-1 rounded-full ${statusClasses[status]}`;
            statusElement.innerHTML = `
                <i class="${statusIcons[status]} text-sm"></i>
                <span class="text-sm font-medium">${message}</span>
            `;
        }

        // Initialize CKEditor
        ClassicEditor
            .create(document.querySelector('#editor'), {
                toolbar: [
                    'heading', '|',
                    'bold', 'italic', 'underline', 'strikethrough', '|',
                    'link', 'bulletedList', 'numberedList', '|',
                    'alignment', 'indent', 'outdent', '|',
                    'insertTable', 'blockQuote', 'horizontalLine', '|',
                    'fontSize', 'fontColor', 'fontBackgroundColor', '|',
                    'imageInsert', '|',
                    'undo', 'redo'
                ],
                fontSize: {
                    options: [9, 11, 13, 'default', 17, 19, 21, 24, 27, 30, 35]
                },
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                    ]
                },
                image: {
                    toolbar: ['imageStyle:full', 'imageStyle:side', '|', 'imageTextAlternative']
                },
                table: {
                    contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                }
            })            .then(createdEditor => {
                editor = createdEditor;
                
                // Set default content initially
                editor.setData(`
                    <h2>Welcome to Our Newsletter</h2>
                    <p>Dear Subscriber,</p>
                    <p>Thank you for your interest in our updates. Here's what's new:</p>
                    <ul>
                        <li>Feature 1: Amazing new functionality</li>
                        <li>Feature 2: Improved user experience</li>
                        <li>Feature 3: Enhanced security</li>
                    </ul>
                    <p>Best regards,<br>Your Team</p>
                `);
                
                // Load saved form data after editor is ready
                setTimeout(() => {
                    loadFormData();
                }, 100);
                
                // Set up auto-save for editor content
                editor.model.document.on('change:data', debounce(saveFormData, 1000));
                
                console.log('CKEditor initialized successfully');
                logToDebugConsole('CKEditor initialized successfully with auto-save enabled');
            })
            .catch(error => {
                console.error('Error initializing CKEditor:', error);
                logToDebugConsole('Error initializing CKEditor: ' + error.message);
            });

        // Add recipient function
        function addRecipient() {
            const singleRecipient = document.getElementById('singleRecipient');
            const recipients = document.getElementById('recipients');
            
            if (singleRecipient.value && singleRecipient.value.includes('@')) {
                const currentRecipients = recipients.value ? recipients.value + '\n' : '';
                recipients.value = currentRecipients + singleRecipient.value;
                singleRecipient.value = '';
                updateRecipientCount();
                logToDebugConsole('Added recipient: ' + singleRecipient.value);
            } else {
                alert('Please enter a valid email address');
            }
        }

        // Update recipient count
        function updateRecipientCount() {
            const recipients = document.getElementById('recipients').value;
            const emails = recipients.split('\n').filter(email => email.trim() && email.includes('@'));
            const count = emails.length;
            
            document.getElementById('recipientCount').textContent = count;
            document.getElementById('statsRecipients').textContent = count;
            logToDebugConsole('Updated recipient count: ' + count);
        }

        // Load email templates
        function loadTemplate(type) {
            let templateContent = '';
            
            if (type === 'newsletter') {
                templateContent = `
                    <div style="max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif;">
                        <div style="background-color: #f8f9fa; padding: 20px; text-align: center;">
                            <h1 style="color: #333; margin: 0;">Company Newsletter</h1>
                            <p style="color: #666; margin: 5px 0 0 0;">Monthly Updates & News</p>
                        </div>
                        
                        <div style="background-color: white; padding: 30px;">
                            <h2 style="color: #333;">Hello [Name],</h2>
                            
                            <p>We're excited to share our latest updates and news with you.</p>
                            
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3 style="color: #333; margin-top: 0;">Featured Article</h3>
                                <p>This month we're highlighting our new features and improvements.</p>
                                <a href="#" style="display: inline-block; background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">Read More</a>
                            </div>
                            
                            <h3>What's New</h3>
                            <ul>
                                <li>New dashboard interface</li>
                                <li>Enhanced security features</li>
                                <li>Mobile app improvements</li>
                            </ul>
                            
                            <p>Thank you for being a valued subscriber!</p>
                            
                            <p>Best regards,<br>The Team</p>
                        </div>
                        
                        <div style="background-color: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666;">
                            <p>¬© 2025 Company Name. All rights reserved.</p>
                            <p><a href="#" style="color: #666;">Unsubscribe</a> | <a href="#" style="color: #666;">Update Preferences</a></p>
                        </div>
                    </div>
                `;
            } else if (type === 'promotional') {
                templateContent = `
                    <div style="max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif;">
                        <div style="background-color: #dc3545; padding: 30px; text-align: center; color: white;">
                            <h1 style="margin: 0; font-size: 36px;">LIMITED TIME OFFER!</h1>
                            <p style="font-size: 18px; margin: 10px 0 0 0;">Save up to 50% on all products</p>
                        </div>
                        
                        <div style="background-color: white; padding: 30px;">
                            <h2 style="color: #333;">Don't Miss Out!</h2>
                            
                            <p>This is a limited-time promotion that ends soon. Take advantage of our biggest sale of the year!</p>
                            
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
                                <h3 style="color: #dc3545; margin-top: 0;">FLASH SALE</h3>
                                <p style="font-size: 24px; font-weight: bold; color: #333;">50% OFF</p>
                                <p>Use code: <strong>SAVE50</strong></p>
                                <a href="#" style="display: inline-block; background-color: #dc3545; color: white; padding: 15px 30px; text-decoration: none; border-radius: 4px; font-weight: bold;">SHOP NOW</a>
                            </div>
                            
                            <p style="text-align: center; color: #666; font-size: 14px;">
                                *Offer valid until midnight. Terms and conditions apply.
                            </p>
                        </div>                    </div>
                `;            } else if (type === 'webropol') {
                templateContent = `
<h1 style="color: #1e6880; text-align: center; background-color: #f0f8ff; padding: 20px; margin: 0 0 30px 0; border-radius: 8px;">üìß Webropol Weekly Update</h1>

<p style="font-size: 16px; color: #333; margin-bottom: 20px;"><strong>Hi all, and greetings from the marketing department!</strong></p>

<p style="line-height: 1.6; margin-bottom: 20px;">This week, we have posted a new customer case story based on our last week's webinar: <strong style="color: #1e6880;">Turku University of Applied Sciences (Turun AMK)</strong> has been Webropol's customer for over a decade, and they have been among the first ones to implement our AI Text Analysis.</p>

<p style="font-weight: 600; color: #1e6880; margin-bottom: 15px;">üìñ Go read the stories and like the LinkedIn posts:</p>

<h2 style="color: #1e6880; border-left: 4px solid #1e6880; padding-left: 15px; margin: 30px 0 20px 0;">üåç Customer Case Studies by Region</h2>

<table style="width: 100%; border-collapse: collapse; margin: 20px 0; background-color: #f8fcff; border: 2px solid #e1f0ff;">
    <tr style="background-color: #1e6880; color: white;">
        <th style="padding: 12px; text-align: left; font-weight: bold;">Country</th>
        <th style="padding: 12px; text-align: left; font-weight: bold;">Case Study</th>
        <th style="padding: 12px; text-align: left; font-weight: bold;">LinkedIn Post</th>
    </tr>
    <tr style="border-bottom: 1px solid #ddd;">
        <td style="padding: 15px; font-weight: bold; color: #1e6880;">üá´üáÆ Finland</td>
        <td style="padding: 15px;">
            <a href="https://webropol.fi/asiakastarinat/case-turun-amk/" 
               style="background-color: #1e6880; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">
                üìã Read Case Study
            </a>
        </td>
        <td style="padding: 15px;">
            <a href="https://www.linkedin.com/feed/update/urn:li:activity:7331222961888169985" 
               style="background-color: #0077b5; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">
                üëç Like & Share
            </a>
        </td>
    </tr>
    <tr style="border-bottom: 1px solid #ddd; background-color: #ffffff;">
        <td style="padding: 15px; font-weight: bold; color: #1e6880;">üá¨üáß United Kingdom</td>
        <td style="padding: 15px;">
            <a href="https://webropol.co.uk/case-studies/case-study-turku-university-of-applied-sciences/" 
               style="background-color: #1e6880; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">
                üìã Read Case Study
            </a>
        </td>
        <td style="padding: 15px;">
            <a href="https://www.linkedin.com/feed/update/urn:li:activity:7331223395465871362" 
               style="background-color: #0077b5; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">
                üëç Like & Share
            </a>
        </td>
    </tr>
    <tr style="border-bottom: 1px solid #ddd;">
        <td style="padding: 15px; font-weight: bold; color: #1e6880;">üá©üá™ Germany</td>
        <td style="padding: 15px;">
            <a href="https://webropol.de/fall-studien/case-turku-university-of-applied-sciences/" 
               style="background-color: #1e6880; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">
                üìã Read Case Study
            </a>
        </td>
        <td style="padding: 15px;">
            <a href="https://www.linkedin.com/feed/update/urn:li:activity:7331223778103857152" 
               style="background-color: #0077b5; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">
                üëç Like & Share
            </a>
        </td>
    </tr>
    <tr style="background-color: #ffffff;">
        <td style="padding: 15px; font-weight: bold; color: #1e6880;">üá∏üá™ Sweden</td>
        <td style="padding: 15px;">
            <a href="https://webropol.se/kundcase/kundcase-yrkeshogskolan-i-abo/" 
               style="background-color: #1e6880; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">
                üìã Read Case Study
            </a>
        </td>
        <td style="padding: 15px;">
            <a href="https://www.linkedin.com/feed/update/urn:li:activity:7331224179058413569" 
               style="background-color: #0077b5; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">
                üëç Like & Share
            </a>
        </td>
    </tr>
</table>

<h2 style="color: #e67e00; border-left: 4px solid #ffd700; padding-left: 15px; margin: 40px 0 20px 0;">üöÄ Special Campaign Alert</h2>

<blockquote style="background-color: #fff9e6; border-left: 6px solid #ffd700; padding: 20px; margin: 20px 0; font-style: italic; border-radius: 0 8px 8px 0;">
    <p style="margin: 0 0 15px 0; font-size: 16px; line-height: 1.6;">Currently, we are running a campaign for <strong style="color: #e67e00;">AI Text Analysis module</strong> with a special discount and a free training of AI Text Analysis after the summer.</p>
    
    <p style="margin: 0 0 15px 0; font-weight: bold; color: #d35400;">üìÖ Campaign Details:</p>
    <ul style="margin: 0; padding-left: 20px;">
        <li style="margin-bottom: 8px;">üí∞ <strong>Special discount</strong> on AI Text Analysis module</li>
        <li style="margin-bottom: 8px;">üéì <strong>Free training</strong> included after summer</li>
        <li style="margin-bottom: 8px;">‚è∞ Campaign open until <strong style="color: #d35400;">June 19th</strong></li>
        <li style="margin-bottom: 8px;">üì∫ Open demo on <strong style="color: #d35400;">June 4th</strong></li>
    </ul>
    
    <p style="margin: 15px 0 0 0; font-weight: bold; color: #1e6880;">Feel free to ask for more information and share with your customers!</p>
</blockquote>

<hr style="border: none; height: 2px; background-color: #e1f0ff; margin: 40px 0;">

<p style="font-size: 16px; line-height: 1.6; color: #333;">That's it for now, have a great weekend! üåü</p>

<p style="margin-top: 30px; padding: 15px; background-color: #f8fcff; border-radius: 8px; border-left: 4px solid #1e6880;">
    <strong style="color: #1e6880;">Best regards,</strong><br>
    <strong style="color: #1e6880; font-size: 18px;">Webropol Marketing Team</strong> üìß
</p>`;
            }
              if (editor && templateContent) {
                editor.setData(templateContent);
                logToDebugConsole('Loaded template: ' + type);
                // Save the template content
                setTimeout(saveFormData, 500);
            }
        }        // Clear editor
        function clearEditor() {
            if (editor) {
                editor.setData('');
                logToDebugConsole('Editor cleared');
                // Save the cleared state
                setTimeout(saveFormData, 500);
            }
        }

        // Preview email
        function previewEmail() {
            const subject = document.getElementById('emailSubject').value || 'No Subject';
            const fromName = document.getElementById('fromName').value || 'Sender';
            const fromEmail = document.getElementById('fromEmail').value || 'sender@email.com';
            const content = editor ? editor.getData() : '';

            document.getElementById('previewSubject').textContent = subject;
            document.getElementById('previewFrom').textContent = `${fromName} <${fromEmail}>`;
            document.getElementById('previewContent').innerHTML = content;
            
            document.getElementById('previewModal').classList.remove('hidden');
            document.getElementById('previewModal').classList.add('flex');
            
            logToDebugConsole('Preview opened for: ' + subject);
        }

        // Close preview
        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
            document.getElementById('previewModal').classList.remove('flex');
        }

        // Send test email
        async function sendTestEmail() {
            const testEmail = document.getElementById('testEmail').value;
            
            if (!testEmail || !testEmail.includes('@')) {
                alert('Please enter a valid test email address');
                return;
            }

            if (!emailJSInitialized) {
                alert('EmailJS is not initialized. Please check your connection.');
                return;
            }            const serviceId = document.getElementById('serviceId').value;
            const templateId = document.getElementById('templateId').value;

            if (!serviceId || !templateId) {
                alert('Please enter your EmailJS Service ID and Template ID');
                return;
            }

            // Show loading state
            const testButton = event.target;
            const originalText = testButton.innerHTML;
            testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            testButton.disabled = true;            try {                // HTML template email parameters for EmailJS
                const emailParams = {
                    to: testEmail,              // Alternative: try 'to' instead of 'user_email'
                    user_email: testEmail,      // Keep both for compatibility
                    user_name: 'Test Recipient',
                    from_name: document.getElementById('fromName').value || 'Test Sender',
                    reply_to: document.getElementById('fromEmail').value || 'test@email.com',
                    subject: '[TEST] ' + (document.getElementById('emailSubject').value || 'Test Email'),
                    message: editor ? editor.getData() : '<p>Test email content from HTML Template Mode</p>',
                    html_content: editor ? editor.getData() : '<p>Test email content from HTML Template Mode</p>'
                };

                console.log('Sending test email with HTML template params:', emailParams);
                logToDebugConsole('Sending test email to: ' + testEmail + ' using service: ' + serviceId + ' template: ' + templateId + ' (HTML Template Mode)');
                logToDebugConsole('Email parameters: ' + JSON.stringify(emailParams, null, 2));
                
                // Send using EmailJS with HTML template
                const response = await emailjs.send(serviceId, templateId, emailParams);
                console.log('EmailJS response:', response);
                logToDebugConsole('Test email sent successfully! Response status: ' + response.status);
                
                alert('‚úÖ Test email sent successfully!');
            } catch (error) {
                console.error('Failed to send test email:', error);
                let errorMessage = 'Failed to send test email. ';                if (error.status === 400) {
                    errorMessage += 'Check your EmailJS service and template configuration for HTML support.';
                } else if (error.status === 401) {
                    errorMessage += 'Invalid EmailJS public key or unauthorized.';
                } else if (error.status === 404) {
                    errorMessage += 'EmailJS service or template not found.';
                } else if (error.status === 429) {
                    errorMessage += 'Rate limit exceeded. Please try again later.';
                } else {
                    errorMessage += `Error: ${error.text || error.message || 'Unknown error'}`;
                }
                
                logToDebugConsole('Test email failed: ' + errorMessage + ' | Status: ' + (error.status || 'unknown') + ' | Details: ' + (error.text || error.message || 'No details'));
                alert('‚ùå ' + errorMessage);
            } finally {
                // Restore button state
                testButton.innerHTML = originalText;
                testButton.disabled = false;
            }
        }        // Send campaign
        async function sendCampaign() {            // Validation
            const serviceId = document.getElementById('serviceId').value;
            const templateId = document.getElementById('templateId').value;
            const subject = document.getElementById('emailSubject').value;
            const recipients = document.getElementById('recipients').value;
            const fromName = document.getElementById('fromName').value;
            const fromEmail = document.getElementById('fromEmail').value;

            if (!serviceId || !templateId) {
                alert('Please enter your EmailJS Service ID and Template ID');
                return;
            }

            if (!subject) {
                alert('Please enter an email subject');
                return;
            }

            if (!recipients) {
                alert('Please add at least one recipient');
                return;
            }

            if (!fromName || !fromEmail) {
                alert('Please enter sender name and email');
                return;
            }

            if (!editor || !editor.getData().trim()) {
                alert('Please create email content');
                return;
            }

            if (!emailJSInitialized) {
                alert('EmailJS is not initialized. Please check your connection.');
                return;
            }

            // Get recipient list
            const emailList = recipients.split('\n')
                .map(email => email.trim())
                .filter(email => email && email.includes('@'));

            if (emailList.length === 0) {
                alert('No valid email addresses found');
                return;
            }

            // Confirm sending
            if (!confirm(`Are you sure you want to send this campaign to ${emailList.length} recipients?`)) {
                return;
            }

            logToDebugConsole('Starting campaign send to ' + emailList.length + ' recipients');

            // Show progress modal
            showProgressModal();

            let sentCount = 0;
            let failedCount = 0;
            let failedEmails = []; // Track failed emails with error details
            const total = emailList.length;

            // Send emails
            for (let i = 0; i < emailList.length; i++) {
                const email = emailList[i];                  try {
                    updateProgress(i, total, `Sending to ${email}...`);                    // HTML template email parameters for EmailJS
                    const emailParams = {
                        to: email,                      // Alternative: try 'to' instead of 'user_email'
                        user_email: email,              // Keep both for compatibility
                        user_name: email.split('@')[0], // Use email prefix as name
                        from_name: fromName,
                        reply_to: fromEmail,
                        subject: subject,
                        message: editor.getData(),      // Alternative parameter name
                        html_content: editor.getData()  // Keep both for compatibility
                    };

                    console.log(`Sending email ${i + 1}/${total} to ${email}`);
                    logToDebugConsole(`Sending email ${i + 1}/${total} to ${email} with service: ${serviceId} template: ${templateId} (HTML Template Mode)`);
                    logToDebugConsole('Email parameters: ' + JSON.stringify(emailParams, null, 2));
                    
                    const response = await emailjs.send(serviceId, templateId, emailParams);
                    console.log(`Email sent successfully to ${email}:`, response);
                    logToDebugConsole(`Email sent successfully to ${email}. Response status: ${response.status}`);
                    
                    sentCount++;
                    
                    // Update stats
                    updateStats(sentCount, failedCount, total);

                    // Delay to avoid rate limiting - increase delay for better reliability
                    await new Promise(resolve => setTimeout(resolve, 2000));

                } catch (error) {
                    console.error(`Failed to send email to ${email}:`, error);
                    failedCount++;
                      // Collect failed email details
                    let errorMessage = 'Unknown error';
                    if (error.status === 400) {
                        errorMessage = 'Invalid service configuration or direct HTML email not supported';
                    } else if (error.status === 401) {
                        errorMessage = 'Unauthorized - check public key';
                    } else if (error.status === 404) {
                        errorMessage = 'Service not found';
                    } else if (error.status === 429) {
                        errorMessage = 'Rate limit exceeded';
                    } else if (error.text) {
                        errorMessage = error.text;
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    failedEmails.push({
                        email: email,
                        error: errorMessage
                    });
                    
                    updateStats(sentCount, failedCount, total);
                    
                    // Log detailed error for debugging
                    console.error('Error details:', {
                        status: error.status,
                        text: error.text,
                        message: error.message,
                        email: email
                    });
                    
                    logToDebugConsole(`Failed to send to ${email}: ${errorMessage} (Status: ${error.status || 'unknown'})`);
                    
                    // If we hit rate limits, wait longer
                    if (error.status === 429) {
                        console.log('Rate limit hit, waiting 5 seconds...');
                        logToDebugConsole('Rate limit hit, waiting 5 seconds...');
                        await new Promise(resolve => setTimeout(resolve, 5000));
                    }
                }
            }

            // Complete
            updateProgress(total, total, 'Campaign completed!');
            
            setTimeout(() => {
                hideProgressModal();
                
                const successRate = total > 0 ? Math.round((sentCount / total) * 100) : 0;
                let summary = `Campaign completed!\n\nSent: ${sentCount}\nFailed: ${failedCount}\nSuccess Rate: ${successRate}%`;
                
                // Add details about failed emails if any
                if (failedEmails && failedEmails.length > 0) {
                    summary += '\n\nFailed emails:\n';
                    failedEmails.slice(0, 5).forEach(failed => {
                        summary += `‚Ä¢ ${failed.email}: ${failed.error}\n`;
                    });
                    if (failedEmails.length > 5) {
                        summary += `... and ${failedEmails.length - 5} more`;
                    }
                }
                
                logToDebugConsole('Campaign completed: ' + sentCount + ' sent, ' + failedCount + ' failed');
                alert(summary);
            }, 1500);
        }

        // Progress modal functions
        function showProgressModal() {
            document.getElementById('progressModal').classList.remove('hidden');
            document.getElementById('progressModal').classList.add('flex');
        }

        function hideProgressModal() {
            document.getElementById('progressModal').classList.add('hidden');
            document.getElementById('progressModal').classList.remove('flex');
        }

        function updateProgress(current, total, message) {
            const percentage = total > 0 ? (current / total) * 100 : 0;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = message;
        }

        // Update stats
        function updateStats(sent, failed, total) {
            document.getElementById('statsSent').textContent = sent;
            document.getElementById('statsFailed').textContent = failed;
            
            const successRate = total > 0 ? Math.round((sent / total) * 100) : 0;
            document.getElementById('statsRate').textContent = successRate + '%';
        }

        // Toggle debug console visibility
        function toggleDebugConsole() {
            const debugConsole = document.getElementById('debugConsole');
            const isVisible = !debugConsole.classList.contains('hidden');
            
            if (isVisible) {
                debugConsole.classList.add('hidden');
            } else {
                debugConsole.classList.remove('hidden');
            }
            
            // Clear console when hiding
            if (!isVisible) {
                console.clear();
                document.getElementById('debugOutput').innerHTML = '';
            }
        }        // Log to debug console
        function logToDebugConsole(message) {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.innerHTML += `[${timestamp}] ${message}<br>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }        // Local Storage Functions
        function saveFormData() {
            // Get service and template IDs from modal or hidden fields
            const serviceIdField = document.getElementById('serviceId');
            const templateIdField = document.getElementById('templateId');
            const modalServiceId = document.getElementById('modalServiceId');
            const modalTemplateId = document.getElementById('modalTemplateId');
            
            const formData = {
                serviceId: (modalServiceId?.value) || (serviceIdField?.value) || '',
                templateId: (modalTemplateId?.value) || (templateIdField?.value) || '',
                campaignName: document.getElementById('campaignName').value,
                fromName: document.getElementById('fromName').value,
                fromEmail: document.getElementById('fromEmail').value,
                emailSubject: document.getElementById('emailSubject').value,
                recipients: document.getElementById('recipients').value,
                testEmail: document.getElementById('testEmail').value,
                editorContent: editor ? editor.getData() : '',
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('emailCampaignData', JSON.stringify(formData));
                logToDebugConsole('Form data saved to local storage');
            } catch (error) {
                console.error('Failed to save form data:', error);
                logToDebugConsole('Failed to save form data: ' + error.message);
            }
        }        function loadFormData() {
            try {
                const savedData = localStorage.getItem('emailCampaignData');
                if (savedData) {
                    const formData = JSON.parse(savedData);
                    
                    // Restore form fields
                    const campaignName = document.getElementById('campaignName');
                    const fromName = document.getElementById('fromName');
                    const fromEmail = document.getElementById('fromEmail');
                    const emailSubject = document.getElementById('emailSubject');
                    const recipients = document.getElementById('recipients');
                    const testEmail = document.getElementById('testEmail');
                    
                    if (campaignName) campaignName.value = formData.campaignName || '';
                    if (fromName) fromName.value = formData.fromName || '';
                    if (fromEmail) fromEmail.value = formData.fromEmail || '';
                    if (emailSubject) emailSubject.value = formData.emailSubject || '';
                    if (recipients) recipients.value = formData.recipients || '';
                    if (testEmail) testEmail.value = formData.testEmail || '';
                    
                    // Restore configuration values to modal fields (they may not exist yet)
                    const modalServiceId = document.getElementById('modalServiceId');
                    const modalTemplateId = document.getElementById('modalTemplateId');
                    if (modalServiceId) modalServiceId.value = formData.serviceId || '';
                    if (modalTemplateId) modalTemplateId.value = formData.templateId || '';
                    
                    // Also create/update hidden fields for compatibility
                    let serviceIdField = document.getElementById('serviceId');
                    if (!serviceIdField && formData.serviceId) {
                        serviceIdField = document.createElement('input');
                        serviceIdField.type = 'hidden';
                        serviceIdField.id = 'serviceId';
                        serviceIdField.value = formData.serviceId;
                        document.body.appendChild(serviceIdField);
                    } else if (serviceIdField) {
                        serviceIdField.value = formData.serviceId || '';
                    }
                    
                    let templateIdField = document.getElementById('templateId');
                    if (!templateIdField && formData.templateId) {
                        templateIdField = document.createElement('input');
                        templateIdField.type = 'hidden';
                        templateIdField.id = 'templateId';
                        templateIdField.value = formData.templateId;
                        document.body.appendChild(templateIdField);
                    } else if (templateIdField) {
                        templateIdField.value = formData.templateId || '';
                    }
                    
                    // Restore editor content when editor is ready
                    if (editor && formData.editorContent) {
                        editor.setData(formData.editorContent);
                    }
                    
                    // Update recipient count
                    updateRecipientCount();
                    
                    logToDebugConsole('Form data restored from local storage (saved: ' + new Date(formData.timestamp).toLocaleString() + ')');
                    
                    // Show restoration notification
                    showNotification('Previous session restored', 'info');
                }
            } catch (error) {
                console.error('Failed to load form data:', error);
                logToDebugConsole('Failed to load form data: ' + error.message);
            }
        }

        function clearFormData() {
            try {
                localStorage.removeItem('emailCampaignData');
                logToDebugConsole('Form data cleared from local storage');
                showNotification('Session data cleared', 'info');
            } catch (error) {
                console.error('Failed to clear form data:', error);
            }
        }        // Auto-save form data
        function setupAutoSave() {
            const formFields = [
                'campaignName', 'fromName', 'fromEmail', 'emailSubject', 'recipients', 'testEmail'
            ];

            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', debounce(saveFormData, 1000));
                    field.addEventListener('change', saveFormData);
                }
            });
            
            // Set up auto-save for modal fields
            const modalFields = ['modalServiceId', 'modalTemplateId'];
            modalFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', debounce(saveFormData, 1000));
                    field.addEventListener('change', saveFormData);
                }
            });
            
            logToDebugConsole('Auto-save enabled for form fields and modal fields');
        }

        // Debounce function to limit auto-save frequency
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md shadow-lg transition-all duration-300 transform translate-x-full`;
            
            // Set styles based on type
            const styles = {
                'info': 'bg-blue-100 text-blue-800 border border-blue-200',
                'success': 'bg-green-100 text-green-800 border border-green-200',
                'warning': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
                'error': 'bg-red-100 text-red-800 border border-red-200'
            };
            
            notification.className += ` ${styles[type] || styles.info}`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-sm opacity-60 hover:opacity-100">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);        }

        // Settings Modal Functions
        function openSettingsModal() {
            // Sync values from main form to modal
            const serviceId = document.getElementById('serviceId');
            const templateId = document.getElementById('templateId');
            const modalServiceId = document.getElementById('modalServiceId');
            const modalTemplateId = document.getElementById('modalTemplateId');
            
            if (serviceId && modalServiceId) {
                modalServiceId.value = serviceId.value;
            }
            if (templateId && modalTemplateId) {
                modalTemplateId.value = templateId.value;
            }
            
            // Show modal
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
            
            logToDebugConsole('Settings modal opened');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
            
            logToDebugConsole('Settings modal closed');
        }

        function saveSettings() {
            // Sync values from modal back to main form (create hidden inputs if needed)
            const modalServiceId = document.getElementById('modalServiceId');
            const modalTemplateId = document.getElementById('modalTemplateId');
            
            // Create or update hidden service ID field
            let serviceIdField = document.getElementById('serviceId');
            if (!serviceIdField) {
                serviceIdField = document.createElement('input');
                serviceIdField.type = 'hidden';
                serviceIdField.id = 'serviceId';
                document.body.appendChild(serviceIdField);
            }
            serviceIdField.value = modalServiceId.value;
            
            // Create or update hidden template ID field
            let templateIdField = document.getElementById('templateId');
            if (!templateIdField) {
                templateIdField = document.createElement('input');
                templateIdField.type = 'hidden';
                templateIdField.id = 'templateId';
                document.body.appendChild(templateIdField);
            }
            templateIdField.value = modalTemplateId.value;
            
            // Save to localStorage
            saveFormData();
            
            // Close modal
            closeSettingsModal();
            
            // Show notification
            showNotification('Settings saved successfully', 'success');
            
            logToDebugConsole('Settings saved: Service ID: ' + modalServiceId.value + ', Template ID: ' + modalTemplateId.value);
        }

        // Event listeners
        document.getElementById('recipients').addEventListener('input', updateRecipientCount);
        document.getElementById('singleRecipient').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addRecipient();
            }
        });        // Close modals when clicking outside
        document.getElementById('progressModal').addEventListener('click', function(e) {
            if (e.target === this) {
                // Don't close progress modal by clicking outside
            }
        });

        document.getElementById('previewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePreview();
            }
        });

        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettingsModal();
            }
        });// Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('connecting', 'Initializing...');
            initializeEmailJS();
            setupAutoSave();
            loadFormData();
        });
        </script>
    </body>
</html>
