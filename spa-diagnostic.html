<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPA Analytics Diagnostic Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry { font-family: monospace; font-size: 12px; padding: 8px; margin: 4px 0; border-radius: 4px; }
        .log-info { background: #e0f2fe; border-left: 4px solid #0ea5e9; }
        .log-success { background: #dcfce7; border-left: 4px solid #22c55e; }
        .log-warning { background: #fef3c7; border-left: 4px solid #f59e0b; }
        .log-error { background: #fee2e2; border-left: 4px solid #ef4444; }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üîç SPA Analytics Diagnostic Tool</h1>
            <p class="text-gray-600 mb-6">This tool checks what's being tracked in your SPA analytics.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm text-blue-600 font-semibold">Total Pages</div>
                    <div id="stat-pages" class="text-3xl font-bold text-blue-900">-</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-sm text-green-600 font-semibold">SPA Routes</div>
                    <div id="stat-routes" class="text-3xl font-bold text-green-900">-</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-sm text-purple-600 font-semibold">Unique Visitors</div>
                    <div id="stat-visitors" class="text-3xl font-bold text-purple-900">-</div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="runDiagnostic()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                    üîç Run Diagnostic
                </button>
                <button onclick="testSPANavigation()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    üß™ Test SPA Navigation
                </button>
                <button onclick="clearLogs()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold">
                    üóëÔ∏è Clear Logs
                </button>
            </div>
        </div>

        <!-- Diagnostic Logs -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üìã Diagnostic Logs</h2>
            <div id="logs" class="space-y-2 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- Data Display -->
        <div class="bg-white rounded-lg shadow-lg p-8 mt-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üìä Tracked Data</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-3">Pages Tracked:</h3>
                    <div id="pages-list" class="text-sm space-y-1"></div>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-3">SPA Routes Tracked:</h3>
                    <div id="routes-list" class="text-sm space-y-1"></div>
                </div>
            </div>
        </div>

        <!-- Raw Data -->
        <div class="bg-white rounded-lg shadow-lg p-8 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900">üóÇÔ∏è Raw Analytics Data</h2>
                <button onclick="copyRawData()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">
                    Copy to Clipboard
                </button>
            </div>
            <pre id="raw-data" class="bg-gray-900 text-gray-100 p-4 rounded text-xs overflow-auto max-h-96"></pre>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('Logs cleared', 'info');
        }

        function runDiagnostic() {
            clearLogs();
            log('üîç Starting diagnostic...', 'info');
            
            // Check 1: localStorage availability
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                log('‚úÖ localStorage is available', 'success');
            } catch (e) {
                log('‚ùå localStorage is NOT available: ' + e.message, 'error');
                return;
            }
            
            // Check 2: Analytics data exists
            const analyticsKey = 'webropolGlobalAnalytics';
            const rawData = localStorage.getItem(analyticsKey);
            
            if (!rawData) {
                log('‚ö†Ô∏è No analytics data found in localStorage', 'warning');
                log('This means either:', 'warning');
                log('  1. You haven\'t visited any pages yet', 'warning');
                log('  2. The analytics tracker isn\'t running', 'warning');
                log('  3. Data was cleared', 'warning');
                document.getElementById('raw-data').textContent = 'No data found';
                return;
            }
            
            log('‚úÖ Analytics data found in localStorage', 'success');
            
            // Parse and analyze data
            try {
                const data = JSON.parse(rawData);
                log('‚úÖ Data parsed successfully', 'success');
                
                // Display stats
                const totalPages = Object.keys(data.pages || {}).length;
                const totalRoutes = Object.keys(data.spaSections || {}).length;
                const totalVisitors = (data.visitors || []).length;
                
                document.getElementById('stat-pages').textContent = totalPages;
                document.getElementById('stat-routes').textContent = totalRoutes;
                document.getElementById('stat-visitors').textContent = totalVisitors;
                
                log(`üìä Statistics:`, 'info');
                log(`   - Pages tracked: ${totalPages}`, 'info');
                log(`   - SPA routes tracked: ${totalRoutes}`, 'info');
                log(`   - Unique visitors: ${totalVisitors}`, 'info');
                log(`   - Sessions: ${(data.sessions || []).length}`, 'info');
                
                // List pages
                const pagesList = document.getElementById('pages-list');
                pagesList.innerHTML = '';
                Object.entries(data.pages || {}).forEach(([path, pageData]) => {
                    const div = document.createElement('div');
                    div.className = 'py-2 px-3 bg-blue-50 rounded flex justify-between';
                    div.innerHTML = `
                        <span class="font-mono text-blue-900">${path}</span>
                        <span class="text-blue-600">${pageData.totalViews} views</span>
                    `;
                    pagesList.appendChild(div);
                    log(`üìÑ Page: ${path} - ${pageData.totalViews} views`, 'info');
                });
                
                // List SPA routes
                const routesList = document.getElementById('routes-list');
                routesList.innerHTML = '';
                Object.entries(data.spaSections || {}).forEach(([route, routeData]) => {
                    const div = document.createElement('div');
                    div.className = 'py-2 px-3 bg-green-50 rounded flex justify-between';
                    div.innerHTML = `
                        <span class="font-mono text-green-900">${route}</span>
                        <span class="text-green-600">${routeData.totalViews} views</span>
                    `;
                    routesList.appendChild(div);
                    log(`üîó Route: ${route} - ${routeData.totalViews} views`, 'success');
                });
                
                // Show raw data
                document.getElementById('raw-data').textContent = JSON.stringify(data, null, 2);
                
                // Analysis
                if (totalRoutes === 0) {
                    log('‚ö†Ô∏è NO SPA ROUTES TRACKED!', 'error');
                    log('This means SPA navigation is not being tracked', 'error');
                    log('Possible issues:', 'warning');
                    log('  1. Analytics not listening to SPA events', 'warning');
                    log('  2. Hash navigation not working', 'warning');
                    log('  3. Users not navigating within the SPA', 'warning');
                } else {
                    log('‚úÖ SPA routes are being tracked!', 'success');
                }
                
                if (totalRoutes === 1 && data.spaSections['/home']) {
                    log('‚ö†Ô∏è Only /home route tracked', 'warning');
                    log('This suggests users are not navigating to other sections', 'warning');
                }
                
                log('‚úÖ Diagnostic complete!', 'success');
                
            } catch (e) {
                log('‚ùå Error parsing analytics data: ' + e.message, 'error');
                document.getElementById('raw-data').textContent = rawData;
            }
        }

        function testSPANavigation() {
            log('üß™ Testing SPA navigation...', 'info');
            
            const testRoutes = ['/surveys', '/events', '/shop', '/home'];
            let currentIndex = 0;
            
            const navigate = () => {
                if (currentIndex < testRoutes.length) {
                    const route = testRoutes[currentIndex];
                    log(`üìç Navigating to ${route}...`, 'info');
                    
                    // Try to navigate via SPA router
                    if (window.WebropolSPA && typeof window.WebropolSPA.navigate === 'function') {
                        window.WebropolSPA.navigate(route);
                        log(`‚úÖ SPA router navigation triggered for ${route}`, 'success');
                    } else {
                        // Fallback to hash change
                        window.location.hash = route;
                        log(`‚ö†Ô∏è Using hash navigation fallback for ${route}`, 'warning');
                    }
                    
                    currentIndex++;
                    setTimeout(navigate, 2000);
                } else {
                    log('‚úÖ Navigation test complete!', 'success');
                    log('Check analytics-monitor.html to see if routes were tracked', 'info');
                }
            };
            
            navigate();
        }

        function copyRawData() {
            const rawData = document.getElementById('raw-data').textContent;
            navigator.clipboard.writeText(rawData).then(() => {
                log('‚úÖ Raw data copied to clipboard!', 'success');
            }).catch(err => {
                log('‚ùå Failed to copy: ' + err.message, 'error');
            });
        }

        // Auto-run diagnostic on load
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Diagnostic tool loaded', 'info');
            log('Click "Run Diagnostic" to analyze your analytics data', 'info');
        });
    </script>
</body>
</html>
