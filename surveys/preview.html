<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Preview | Webropol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/50ef2d3cf8.js" crossorigin="anonymous"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script type="module" src="../preview/questions/index.js"></script>
    <script src="./components/questions/NumericSlider.js" type="module"></script>
    <script src="./components/questions/NPS.js" type="module"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'webropol-primary': { 50: '#f0fdff', 100: '#ccf7fe', 200: '#99effd', 300: '#66e0fa', 400: '#22ccf1', 500: '#06b6d4', 600: '#0891b2', 700: '#0e7490', 800: '#155e75', 900: '#164e63' },
                        'webropol-gray': { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            min-height: 100vh;
        }
        .survey-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .question-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .question-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 16px;
        }
        .input-text {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            outline: none;
            transition: all 0.2s;
        }
        .input-text:focus {
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        /* Page styling */
        .page-break {
            margin: 30px 0;
            border-top: 1px dashed #cbd5e1;
            position: relative;
        }
        .page-break::after {
            content: "Next Page";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #f8fafc;
            padding: 0 10px;
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body x-data="previewApp()">
    <div class="survey-container">
        <!-- Survey Title/Description (Optional) -->
        <div class="mb-8 text-center" x-show="surveyData.title">
            <h1 class="text-3xl font-bold text-gray-900 mb-2" x-text="surveyData.title"></h1>
            <p class="text-gray-600" x-text="surveyData.description"></p>
        </div>

        <!-- Questions Rendering -->
        <template x-for="(page, pageIndex) in surveyData.pages" :key="pageIndex">
            <div>
                <!-- Page Break Indicator (if not first page) -->
                <div class="page-break" x-show="pageIndex > 0"></div>
                
                <template x-for="(question, qIndex) in page.questions" :key="question.id || qIndex">
                    <div class="question-card">
                        <div class="question-text" x-show="question.type !== 'numeric-slider' && question.type !== 'nps'">
                            <span x-text="getQuestionNumber(pageIndex, qIndex) + '.'"></span>
                            <span x-text="question.text"></span>
                            <span x-show="question.required" class="text-red-500 ml-1">*</span>
                        </div>

                        <!-- Render based on question type -->
                        
                        <!-- Text Input -->
                        <div x-show="['text', 'email', 'phone'].includes(question.type)">
                            <input type="text" class="input-text" :placeholder="question.placeholder || 'Your answer'">
                        </div>

                        <!-- Contact -->
                        <div x-show="question.type === 'contact'" class="space-y-3">
                            <template x-for="(field, fieldIndex) in (question.fields || [])" :key="field.key || fieldIndex">
                                <div class="flex items-center gap-3">
                                    <label class="text-sm text-webropol-gray-700 w-28" x-text="field.label || 'Field'"></label>
                                    <input :type="field.type || 'text'" class="input-text" :placeholder="field.placeholder || 'Your answer'">
                                </div>
                            </template>
                        </div>

                        <!-- Textarea -->
                        <div x-show="question.type === 'textarea' || question.type === 'openended'">
                            <textarea class="input-text" rows="4" :placeholder="question.placeholder || 'Your answer'"></textarea>
                        </div>

                        <!-- Radio / Choice -->
                        <div x-show="question.type === 'radio' || question.type === 'single-choice'" class="space-y-2">
                            <template x-for="(option, oIndex) in question.options" :key="oIndex">
                                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-50">
                                    <input type="radio" :name="'q_' + question.id" class="w-4 h-4 text-webropol-primary-600 border-gray-300 focus:ring-webropol-primary-500">
                                    <span class="text-gray-700" x-text="option.text || option"></span>
                                </label>
                            </template>
                        </div>

                        <!-- Checkbox / Multiple Choice -->
                        <div x-show="question.type === 'checkbox' || question.type === 'multi-choice'" class="space-y-2">
                            <template x-for="(option, oIndex) in question.options" :key="oIndex">
                                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-50">
                                    <input type="checkbox" :name="'q_' + question.id" class="w-4 h-4 text-webropol-primary-600 border-gray-300 rounded focus:ring-webropol-primary-500">
                                    <span class="text-gray-700" x-text="option.text || option"></span>
                                </label>
                            </template>
                        </div>

                        <!-- NPS (real component) -->
                        <div x-show="question.type === 'nps'" class="mt-3" x-init="$nextTick(() => applyNPSPreview($el, question, getQuestionNumber(pageIndex, qIndex)))">
                            <webropol-nps mode="respond" class="block"></webropol-nps>
                        </div>

                        <!-- Numeric Slider (full respond component) -->
                        <div x-show="question.type === 'numeric-slider'" class="mt-3" x-init="$nextTick(() => applyNumericSliderPreview($el, question, getQuestionNumber(pageIndex, qIndex)))">
                            <webropol-numeric-slider mode="respond" class="block"></webropol-numeric-slider>
                        </div>

                        <!-- Autosuggest -->
                        <div x-show="question.type === 'autosuggest'">
                            <input type="text" class="input-text" :placeholder="question.placeholder || 'Type to see suggestions...'">
                        </div>

                        <!-- Dropdown -->
                        <div x-show="question.type === 'dropdown'">
                             <select class="input-text cursor-pointer">
                                <option value="" disabled selected>Select an option...</option>
                                <template x-for="(option, oIndex) in question.options" :key="oIndex">
                                    <option x-text="option.text || option"></option>
                                </template>
                            </select>
                        </div>

                    </div>
                </template>
            </div>
        </template>

        <!-- Submit Button Mockup -->
        <div class="mt-8 flex justify-center">
            <button class="bg-webropol-primary-600 hover:bg-webropol-primary-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:-translate-y-0.5" onclick="alert('This is a preview mode. Submissions are disabled.')">
                Submit Survey
            </button>
        </div>
        
        <div class="mt-12 text-center text-gray-400 text-sm">
            <p>Preview Mode â€¢ Webropol</p>
        </div>
    </div>

    <script>
        function previewApp() {
            return {
                surveyData: {
                    title: 'Survey Preview',
                    description: 'This is a preview of how respondents will see your survey.',
                    pages: []
                },

                init() {
                    this.loadSurveyData();
                    this.syncQuestionsFromOpener();
                    this.retrySyncQuestionsFromOpener();
                },

                loadSurveyData() {
                    try {
                        const storedData = localStorage.getItem('webropol_survey_preview_data');
                        if (storedData) {
                            this.surveyData = JSON.parse(storedData);
                        } else {
                            this.surveyData.pages = [
                                {
                                    questions: [
                                        { id: 'q1', type: 'text', text: 'This is a sample question (no data found)', required: true }
                                    ]
                                }
                            ];
                        }
                    } catch (e) {
                        console.error('Error loading survey data:', e);
                    }
                },

                getAlpineDataFromElement(openerWindow, element) {
                    try {
                        const rootWithXData = element?.querySelector('[x-data]');
                        if (!rootWithXData || !openerWindow?.Alpine || typeof openerWindow.Alpine.$data !== 'function') {
                            return null;
                        }
                        return openerWindow.Alpine.$data(rootWithXData) || null;
                    } catch (e) {
                        return null;
                    }
                },

                extractQuestionFromElement(openerWindow, element) {
                    const tagName = (element?.tagName || '').toLowerCase();
                    const questionId = element?.getAttribute('question-id') || Math.random().toString(36).substring(2, 12);
                    const data = this.getAlpineDataFromElement(openerWindow, element);

                    if (tagName === 'webropol-contact-form') {
                        return {
                            id: questionId,
                            text: data?.title || 'Please fill in your details.',
                            type: 'contact',
                            required: Boolean(data?.isMandatory),
                            fields: Array.isArray(data?.fields) ? data.fields : []
                        };
                    }

                    if (tagName === 'webropol-autosuggest-text-field') {
                        return {
                            id: questionId,
                            text: data?.title || 'Auto Suggest',
                            type: 'autosuggest',
                            required: Boolean(data?.isMandatory),
                            options: [],
                            placeholder: 'Type to see suggestions...'
                        };
                    }

                    if (tagName === 'webropol-open-ended') {
                        return {
                            id: questionId,
                            text: data?.title || 'What are your thoughts?',
                            type: 'openended',
                            required: Boolean(data?.isMandatory),
                            placeholder: data?.placeholder || 'Please share your thoughts here...'
                        };
                    }

                    if (tagName === 'webropol-nps') {
                        const titleEl = element.querySelector('label.block.text-lg.font-semibold');
                        const questionText = titleEl?.textContent?.trim() || 'How likely are you to recommend our product to a friend or colleague?';
                        let npsAppearance = 'radiobuttons';
                        try {
                            npsAppearance = openerWindow?.localStorage?.getItem('nps-appearance') || 'radiobuttons';
                        } catch (e) {}
                        return {
                            id: questionId,
                            text: questionText.replace(/^\d+\.\s*/, ''),
                            type: 'nps',
                            required: Boolean(data?.isMandatory),
                            options: [],
                            settings: {
                                appearance: npsAppearance
                            }
                        };
                    }

                    if (tagName === 'webropol-numeric-slider') {
                        const settings = data?.settings || {};
                        const texts = data?.texts || {};
                        return {
                            id: questionId,
                            text: texts.title || 'Numeric Slider',
                            type: 'numeric-slider',
                            required: Boolean(data?.isMandatory),
                            options: [],
                            settings: {
                                min: Number(settings.min ?? 0),
                                max: Number(settings.max ?? 10),
                                step: Number(settings.step ?? 1),
                                start: Number(settings.start ?? 0),
                                questionType: data?.questionType || 'slider',
                                direction: settings.direction || 'min-max',
                                showDontKnow: Boolean(settings.showDontKnow),
                                dontKnowLabel: settings.dontKnowLabel || "I don't know",
                                showValue: settings.showValue !== false,
                                quantity: settings.quantity || '',
                                showLabels: settings.showLabels !== false,
                                orientationDesktop: settings.orientationDesktop || 'vertical',
                                orientationMobile: settings.orientationMobile || 'horizontal',
                                showDescription: settings.showDescription !== false,
                                descPlacement: settings.descPlacement || 'below'
                            },
                            texts: {
                                title: texts.title || 'On a scale from 0 to 100, how would you rate your overall health today?',
                                instructions: texts.instructions || '',
                                boxLabel1: texts.boxLabel1 || 'YOUR',
                                boxLabel2: texts.boxLabel2 || 'HEALTH',
                                boxLabel3: texts.boxLabel3 || 'TODAY',
                                bestLabel1: texts.bestLabel1 || 'Best health',
                                bestLabel2: texts.bestLabel2 || 'you can',
                                bestLabel3: texts.bestLabel3 || 'imagine',
                                worstLabel1: texts.worstLabel1 || 'Worst health',
                                worstLabel2: texts.worstLabel2 || 'you can',
                                worstLabel3: texts.worstLabel3 || 'imagine'
                            }
                        };
                    }

                    return null;
                },

                buildOrderedPagesFromOpener() {
                    try {
                        const openerWindow = window.opener;
                        const openerDoc = openerWindow?.document;
                        if (!openerDoc) return null;

                        const pageSections = Array.from(openerDoc.querySelectorAll('section')).filter(section =>
                            section.querySelector('webropol-contact-form, webropol-autosuggest-text-field, webropol-open-ended, webropol-numeric-slider, webropol-nps')
                        );
                        if (!pageSections.length) return null;

                        const pages = [];
                        pageSections.forEach((section, index) => {
                            const questionElements = Array.from(
                                section.querySelectorAll('webropol-contact-form, webropol-autosuggest-text-field, webropol-open-ended, webropol-numeric-slider, webropol-nps')
                            );
                            const questions = questionElements
                                .map(el => this.extractQuestionFromElement(openerWindow, el))
                                .filter(Boolean);

                            if (questions.length) {
                                pages.push({
                                    number: String(index + 1),
                                    name: `PAGE ${index + 1}`,
                                    questions
                                });
                            }
                        });

                        return pages.length ? pages : null;
                    } catch (e) {
                        console.warn('Could not build ordered pages from opener:', e);
                        return null;
                    }
                },

                syncQuestionsFromOpener() {
                    try {
                        const orderedPages = this.buildOrderedPagesFromOpener();
                        if (!orderedPages) return false;
                        this.surveyData.pages = orderedPages;
                        return true;
                    } catch (e) {
                        console.warn('Could not sync questions from opener:', e);
                        return false;
                    }
                },

                retrySyncQuestionsFromOpener() {
                    let attempts = 0;
                    const maxAttempts = 12;
                    const intervalMs = 250;

                    const timer = setInterval(() => {
                        attempts += 1;
                        const synced = this.syncQuestionsFromOpener();
                        if (synced || attempts >= maxAttempts) {
                            clearInterval(timer);
                        }
                    }, intervalMs);
                },

                applyNumericSliderPreview(containerEl, question, questionNumber) {
                    const applyState = () => {
                        try {
                            const sliderEl = containerEl.querySelector('webropol-numeric-slider');
                            if (!sliderEl) return false;

                            const rootWithXData = sliderEl.querySelector('[x-data]');
                            if (!rootWithXData || !window.Alpine || typeof window.Alpine.$data !== 'function') {
                                return false;
                            }

                            const sliderData = window.Alpine.$data(rootWithXData);
                            if (!sliderData) return false;

                            sliderData.mode = 'respond';
                            sliderData.selected = false;
                            sliderData.showSettings = false;
                            sliderData.questionType = question.settings?.questionType || 'slider';
                            sliderData.settings = { ...(sliderData.settings || {}), ...(question.settings || {}) };
                            if (question.texts) {
                                sliderData.texts = { ...(sliderData.texts || {}), ...(question.texts || {}) };
                            }

                            if (!question.texts?.title && question.text) {
                                sliderData.texts = { ...(sliderData.texts || {}), title: `${questionNumber}. ${question.text}` };
                            } else if (sliderData.texts?.title) {
                                sliderData.texts.title = `${questionNumber}. ${sliderData.texts.title.replace(/^\d+\.\s*/, '')}`;
                            }

                            if (sliderData.value === null || sliderData.value === undefined) {
                                sliderData.value = Number(sliderData.settings?.start ?? sliderData.settings?.min ?? 0);
                            }
                            sliderData.dontKnow = false;
                            return true;
                        } catch (error) {
                            console.warn('Failed to apply numeric slider preview state:', error);
                            return true;
                        }
                    };

                    if (applyState()) return;

                    let attempts = 0;
                    const maxAttempts = 16;
                    const timer = setInterval(() => {
                        attempts += 1;
                        if (applyState() || attempts >= maxAttempts) {
                            clearInterval(timer);
                        }
                    }, 150);
                },

                applyNPSPreview(containerEl, question, questionNumber) {
                    const renderNPSAppearance = (npsEl, style) => {
                        const target = npsEl.querySelector('#npsRenderContainer');
                        if (!target) return;

                        const buildRadioScale = () => {
                            const wrap = document.createElement('div');
                            wrap.className = 'flex flex-wrap gap-2';
                            for (let index = 0; index <= 10; index += 1) {
                                const label = document.createElement('label');
                                label.className = 'cursor-pointer';
                                label.innerHTML = `<input type="radio" name="npsScorePreview" value="${index}" class="sr-only peer"><div class='w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow'>${index}</div>`;
                                wrap.appendChild(label);
                            }
                            const legendRow = document.createElement('div');
                            legendRow.className = 'flex justify-between text-xs text-webropol-gray-500 mt-3 px-1 w-full';
                            legendRow.innerHTML = '<span>Not at all likely</span><span>Extremely likely</span>';
                            const fieldset = document.createElement('fieldset');
                            fieldset.appendChild(wrap);
                            fieldset.appendChild(legendRow);
                            return fieldset;
                        };

                        const buildSlider = () => {
                            const fragment = document.createElement('div');
                            fragment.className = 'space-y-3';
                            fragment.innerHTML = `<input id='npsSliderPreview' type='range' min='0' max='10' value='0' class='w-full h-2 rounded-lg appearance-none slider bg-webropol-gray-200'><div class='flex justify-between text-[11px] text-webropol-gray-500'>${Array.from({length:11},(_,i)=>`<span>${i}</span>`).join('')}</div><div class='text-xs text-webropol-primary-700 font-medium'><span id='npsSliderValuePreview'>Selected: 0</span></div>`;
                            const slider = fragment.querySelector('#npsSliderPreview');
                            const output = fragment.querySelector('#npsSliderValuePreview');
                            if (slider && output) {
                                slider.addEventListener('input', () => {
                                    output.textContent = `Selected: ${slider.value}`;
                                });
                            }
                            return fragment;
                        };

                        const buildSmileys = () => {
                            const fragment = document.createElement('div');
                            fragment.innerHTML = `<div class='flex justify-center gap-4' role='radiogroup' aria-label='NPS Smileys'><button type='button' data-nps-smiley='detractor' class='nps-smiley' aria-pressed='false' title='Detractor (0-6)'><i class='fal fa-face-frown'></i></button><button type='button' data-nps-smiley='passive' class='nps-smiley' aria-pressed='false' title='Passive (7-8)'><i class='fal fa-face-meh'></i></button><button type='button' data-nps-smiley='promoter' class='nps-smiley' aria-pressed='false' title='Promoter (9-10)'><i class='fal fa-face-smile'></i></button></div><div class='text-center mt-3 text-xs text-webropol-gray-500' id='npsSmileyHintPreview'>Select a mood</div>`;
                            const hint = fragment.querySelector('#npsSmileyHintPreview');
                            fragment.querySelectorAll('.nps-smiley').forEach((button) => {
                                button.addEventListener('click', () => {
                                    fragment.querySelectorAll('.nps-smiley').forEach(item => item.setAttribute('aria-pressed', 'false'));
                                    button.setAttribute('aria-pressed', 'true');
                                    if (hint) {
                                        const labels = { detractor: 'Detractor (0-6)', passive: 'Passive (7-8)', promoter: 'Promoter (9-10)' };
                                        hint.textContent = labels[button.dataset.npsSmiley] || 'Selected';
                                    }
                                });
                            });
                            return fragment;
                        };

                        target.innerHTML = '';
                        let node;
                        if (style === 'slider') node = buildSlider();
                        else if (style === 'smileys') node = buildSmileys();
                        else node = buildRadioScale();
                        target.appendChild(node);
                    };

                    const applyState = () => {
                        try {
                            const npsEl = containerEl.querySelector('webropol-nps');
                            if (!npsEl) return false;

                            const rootWithXData = npsEl.querySelector('[x-data]');
                            if (!rootWithXData || !window.Alpine || typeof window.Alpine.$data !== 'function') {
                                return false;
                            }

                            const npsData = window.Alpine.$data(rootWithXData);
                            if (!npsData) return false;

                            npsData.mode = 'respond';
                            npsData.selected = false;
                            npsData.isMandatory = Boolean(question.required);

                            const questionText = `${questionNumber}. ${(question.text || '').replace(/^\d+\.\s*/, '')}`;
                            const collapsedLabel = npsEl.querySelector('.question-card-collapsed label.block.text-lg.font-semibold');
                            if (collapsedLabel) {
                                collapsedLabel.textContent = questionText;
                            }

                            const expandedLabel = npsEl.querySelector('.p-6.rounded-b-3xl.bg-white label.block.text-lg.font-semibold');
                            if (expandedLabel) {
                                expandedLabel.textContent = questionText;
                            }

                            const style = question.settings?.appearance || 'radiobuttons';
                            npsEl.setAttribute('data-nps-style', style);
                            renderNPSAppearance(npsEl, style);

                            return true;
                        } catch (error) {
                            console.warn('Failed to apply NPS preview state:', error);
                            return true;
                        }
                    };

                    if (applyState()) return;

                    let attempts = 0;
                    const maxAttempts = 16;
                    const timer = setInterval(() => {
                        attempts += 1;
                        if (applyState() || attempts >= maxAttempts) {
                            clearInterval(timer);
                        }
                    }, 150);
                },

                getQuestionNumber(pageIndex, qIndex) {
                    let count = 1;
                    for (let i = 0; i < pageIndex; i++) {
                        count += this.surveyData.pages[i].questions.length;
                    }
                    return count + qIndex;
                }
            }
        }
    </script>
</body>
</html>
