<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Survey - Translation | Webropol</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/50ef2d3cf8.js" crossorigin="anonymous"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script defer src="../design-system/components/tabs/unified-tabs.js"></script>
  <script src="../design-system/components/forms/Dropdown.js" type="module"></script>
  <script src="../design-system/components/menus/ContextMenu.js" type="module"></script>
  <script src="../design-system/components/interactive/MergePages.js" type="module"></script>
  <script src="../design-system/components/modals/AddQuestionModal.js" type="module"></script>
  <script src="../design-system/components/interactive/SurveyPageItem.js" type="module"></script>
  <script src="../design-system/components/interactive/SurveyQuestionItem.js" type="module"></script>
  <script src="../design-system/components/interactive/PageQuickActions.js" type="module"></script>
  <script src="../design-system/components/interactive/ContentSelector.js" type="module"></script>
  <!-- Removed dynamic survey-name.js; static label used -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'webropol-primary': { 50: '#f0fdff', 100: '#ccf7fe', 200: '#99effd', 300: '#66e0fa', 400: '#22ccf1', 500: '#06b6d4', 600: '#0891b2', 700: '#0e7490', 800: '#155e75', 900: '#164e63' },
            'webropol-gray': { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
            'webropol-primary-': { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
          },
          fontFamily: {
            'sans': ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
            'medium': '0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
            'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="../design-system/styles/animations.css" rel="stylesheet">
  <!-- Design System core tokens and button classes -->
  <link href="../design-system/styles/tokens.css" rel="stylesheet">
  <link href="../design-system/styles/tabs.css" rel="stylesheet">
  <link href="../design-system/styles/button-classes.css" rel="stylesheet">
  <style>
    :root {
      --border-radius-full: 9999px;
      --primary-600: #1d809d;
      --primary-50: #eefbfd;
      --neutral-600: #787f81;
    }

    /* Unified Rounded Edit Tab Styles */
    .webropol-tabs-container {
      display: inline-flex;
      background: var(--primary-50);
      padding: 6px;
      border-radius: 12px;
      gap: 4px;
    }

    .webropol-edit-tab {
      background: transparent;
      color: var(--neutral-600);
      border: none;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      transform-origin: center;
    }

    .webropol-edit-tab.active {
      background: var(--primary-600);
      color: white;
      box-shadow: 0 4px 12px rgba(29, 128, 157, 0.3);
      transform: scale(1.02);
    }

    .webropol-edit-tab:not(.active):hover {
      color: var(--primary-600);
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transform: scale(1.01);
    }

    .webropol-edit-tab:focus-visible {
      outline: 2px solid var(--primary-600);
      outline-offset: 2px;
    }

    [x-cloak] {
      display: none !important;
    }

    body {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f8fafc;
      font-family: 'Inter', sans-serif;
    }

    body::-webkit-scrollbar {
      width: 6px;
    }

    body::-webkit-scrollbar-track {
      background: #f8fafc;
    }

    body::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 6px;
    }

    .glass-effect {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.9);
    }

    .hover-lift {
      transition: all 0.2s ease;
    }

    .hover-lift:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 25px -5px rgba(0, 0, 0, 0.15);
    }
    /* Unified question card styling */
    .question-card{border:1px solid #e2e8f0;border-radius:1.25rem;background:#fff;position:relative;transition:box-shadow .18s ease,border-color .18s ease,background-color .18s ease}
    .question-card:hover{border-color:#d5dde6}
    .question-card.selected{border-color:#06b6d4;background:#f0fdff;box-shadow:0 6px 18px -4px rgba(6,182,212,.25)}
    .question-card-header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid #e2e8f0;background:#f8fafc;border-radius:1.25rem 1.25rem 0 0}
    .question-card.selected .question-card-header{background:#e0f7fb;border-color:#bae8f1}
    .question-card-toolbar button{padding:.35rem .55rem;border-radius:.6rem}
    .question-card-collapsed:hover{background:#f8fafc}
    .question-card-highlighted{border-color:transparent !important;background:#fff !important;background:linear-gradient(#fff,#fff) padding-box,linear-gradient(120deg,#06b6d4,#a855f7,#06b6d4) border-box !important;animation:questionHighlightBorder 1.2s ease-in-out infinite alternate}
    @keyframes questionHighlightBorder{0%{box-shadow:0 0 0 0 rgba(6,182,212,.35)}100%{box-shadow:0 0 0 6px rgba(6,182,212,.05)}}
    
    /* Drag handle styles */
    .drag-handle {
      position: absolute;
      right: -12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 10;
      cursor: move;
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 8px 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .drag-handle:active {
      cursor: move;
    }
    
    .drag-handle:hover {
      background: #f8fafc;
      border-color: #06b6d4;
      cursor: move;
    }
    
    .question-card:hover .drag-handle,
    .question-card.selected .drag-handle {
      opacity: 1;
      right: -16px;
    }
    
    .drag-handle i {
      color: #64748b;
      font-size: 16px;
    }
    
    .drag-handle:hover i {
      color: #06b6d4;
    }
    
    /* Custom range slider styles */
    .slider {
      -webkit-appearance: none;
      appearance: none;
      background: linear-gradient(to right, #06b6d4 0%, #06b6d4 var(--value, 20%), #e2e8f0 var(--value, 20%), #e2e8f0 100%);
      outline: none;
      border-radius: 6px;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #06b6d4;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #06b6d4;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* Survey styles preview effects */
    .survey-preview-container {
      transition: all 0.3s ease;
    }
    
    /* Hide default radio button appearance for custom styled buttons */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* Color picker preview hover effect */
    .color-preview {
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid #d1d5db;
    }
    
    .color-preview:hover {
      border-color: #06b6d4;
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }
    
    /* Survey page background container */
    .survey-page-background {
      pointer-events: none; /* Don't interfere with page interactions */
      overflow: hidden; /* Prevent blur edges from showing */
    }
    
    /* Survey Background Wrapper */
    .survey-background-wrapper {
      /* Background section removed as requested - the wrapper remains for layout only */
      background: transparent; /* no background */
      border-radius: 24px;
      overflow: hidden;
      border: none;
      box-shadow: none;
    }
    
    /* Ensure survey content stays above background */
    main.flex-1 > * {
      position: relative;
    }
    
    /* Color Picker Styles */
    .color-picker-canvas {
      display: flex;
      justify-content: center;
    }
    
    #colorCanvas, #hueCanvas {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
    }
    
    .active-color-type {
      background: linear-gradient(to right, #0891b2, #0e7490) !important;
      color: white !important;
    }
    
    .active-gradient-type {
      background: linear-gradient(to right, #0891b2, #0e7490) !important;
      color: white !important;
    }
    
    .active-radial-shape {
      background: linear-gradient(to right, #0891b2, #0e7490) !important;
      color: white !important;
    }
    
    .gradient-direction-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      color: #6b7280;
      transition: all 0.2s ease;
    }
    
    .gradient-direction-btn:hover {
      border-color: #06b6d4;
      color: #06b6d4;
    }
    
    .gradient-direction-btn.active {
      background: #06b6d4;
      border-color: #06b6d4;
      color: white;
    }
    
    .color-stop {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f9fafb;
    }
    
    .color-stop-preview {
      width: 32px;
      height: 32px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .color-stop-position {
      width: 80px;
    }
    
    .remove-color-stop {
      padding: 4px 8px;
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .remove-color-stop:hover {
      background: #fecaca;
    }
  .survey-action-btn { width:40px; height:40px; flex-shrink:0; }
  </style>
  <script src="../design-system/components/navigation/Sidebar.js" type="module"></script>
  <script src="../design-system/components/navigation/Header.js" type="module"></script>
  <script src="../design-system/components/navigation/Breadcrumbs.js" type="module"></script>
  <script src="../design-system/components/navigation/SurveyActionTabs.js" type="module"></script>
  <script src="../design-system/components/navigation/SurveyHelperToolbar.js" type="module"></script>
  <script src="../design-system/components/navigation/SurveyEditToolbar.js" type="module"></script>
  <script src="../design-system/components/interactive/FloatingButton.js" type="module"></script>
  <script src="../design-system/components/modals/Modal.js" type="module"></script>
  <script src="../design-system/components/modals/SettingsModal.js" type="module"></script>
  <script src="../design-system/components/modals/SurveySettingsModal.js" type="module"></script>
  <script src="../design-system/components/modals/RuleGroupModal.js" type="module"></script>
  <script src="../design-system/components/forms/RadioSpecial.js" type="module"></script>
  <script src="../design-system/components/feedback/Alert.js" type="module"></script>
  <script src="../design-system/utils/theme-manager.js" type="module"></script>
  <script src="../design-system/utils/global-settings-manager.js" type="module"></script>
    
    <!-- Global Analytics Tracker -->
    <script src="../scripts/analytics-global-tracker.js"></script>
</head>
<body x-data="surveyEditApp()">
  <div class="flex h-screen">
    <webropol-sidebar active="surveys" base="../"></webropol-sidebar>
    <div class="flex-1 flex flex-col overflow-hidden">
      <webropol-header username="Ali Al-Zuhairi" show-notifications="true" show-help="true" show-user-menu="true" show-theme-selector="true"></webropol-header>

      <main class="flex-1 overflow-y-auto px-2 py-2 lg:px-1" role="main">
        <div class="w-full mx-auto">
          <!-- Survey Editor Header -->
          <div class="mb-0">
            <!-- Action Tabs -->
            <div class="flex items-center justify-between border-b border-webropol-gray-300">
              <webropol-survey-action-tabs active="edit"></webropol-survey-action-tabs>

              <webropol-survey-helper-toolbar 
                survey-name="Customer Satisfaction Survey" 
                survey-id="Fin348267" 
                active-page="edit" 
                access-level="admin"
                survey-status="draft">
              </webropol-survey-helper-toolbar>
            </div>
          </div>
          <br>

          <!-- Toolbar -->
          <webropol-survey-edit-toolbar></webropol-survey-edit-toolbar>
          <br>

          <!-- Survey Editor Layout -->
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
            <!-- Left Sidebar - Survey Structure -->
            <div class="lg:col-span-1" x-data="surveyStructureApp()">
              <div class="rounded-3xl p-6 shadow-xl border border-white hover-lift">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-webropol-gray-900">Survey structure</h3>
                  <button class="text-webropol-gray-400 hover:text-webropol-gray-600">
                    <i class="fal fa-ellipsis-h"></i>
                  </button>
                </div>
                
                <!-- Structure Tabs with unified styling -->
                <div class="webropol-tabs-unified webropol-tabs-rounded-container mb-4" role="tablist" aria-label="Edit modes">
                  <button 
                    @click="activeTab = 'pages'" 
                    :class="activeTab === 'pages' ? 'webropol-unified-tab webropol-tab-rounded size-md active' : 'webropol-unified-tab webropol-tab-rounded size-md'"
                    role="tab"
                    :aria-selected="activeTab === 'pages'"
                  >
                    <i class="fal fa-file-alt mr-2"></i>
                    <span>Pages</span>
                  </button>
                  <button 
                    @click="activeTab = 'styles'" 
                    :class="activeTab === 'styles' ? 'webropol-unified-tab webropol-tab-rounded size-md active' : 'webropol-unified-tab webropol-tab-rounded size-md'"
                    role="tab"
                    :aria-selected="activeTab === 'styles'"
                  >
                    <i class="fal fa-paint-brush mr-2"></i>
                    <span>Styles</span>
                  </button>
                </div>
                
                <!-- Action Buttons - Show only for Pages tab -->
                <div x-show="activeTab === 'pages'" class="flex flex-wrap gap-2 mb-4">
                  <button class="btn btn-secondary btn-sm">
                    <i class="fal fa-arrows-alt text-xs"></i>
                    <span>Move</span>
                  </button>
                  <button class="btn btn-secondary btn-sm">
                    <i class="fal fa-copy text-xs"></i>
                    <span>Copy</span>
                  </button>
                  <button class="btn btn-secondary btn-sm">
                    <i class="fa-light fa-trash-can text-xs"></i>
                    <span>Delete</span>
                  </button>
                </div>
                
                <!-- Survey Structure Tree - Pages Tab -->
                <div x-show="activeTab === 'pages'" class="space-y-3 mb-6">
                  <!-- Page 1 using new component -->
                  <webropol-survey-page 
                    page-number="1" 
                    page-name="PAGE 1" 
                    question-count="3" 
                    expanded
                    @page-toggle="handlePageToggle"
                    @page-select="handlePageSelect"
                  >
                    <webropol-survey-question 
                      question-id="contactform" 
                      question-text="Please fill in your details" 
                      question-type="contact"
                      @question-settings="openQuestionSettingsModal"
                      @question-delete="handleQuestionDelete"
                    ></webropol-survey-question>
                    
                    <webropol-survey-question 
                      question-id="autosuggest" 
                      question-text="Auto Suggest" 
                      question-type="autosuggest"
                      @question-settings="openQuestionSettingsModal"
                      @question-delete="handleQuestionDelete"
                    ></webropol-survey-question>
                    
                    <webropol-survey-question 
                      question-id="openended" 
                      question-text="What are your thoughts?" 
                      question-type="textarea"
                      @question-settings="openQuestionSettingsModal"
                      @question-delete="handleQuestionDelete"
                    ></webropol-survey-question>
                  </webropol-survey-page>
                  
                  <!-- Page 2 using new component -->
                  <webropol-survey-page 
                    page-number="2" 
                    page-name="PAGE 2" 
                    question-count="1"
                    @page-toggle="handlePageToggle"
                    @page-select="handlePageSelect"
                  >
                    <webropol-survey-question 
                      question-id="nps" 
                      question-text="Net Promoter Score (NPS)" 
                      question-type="nps"
                      @question-settings="openQuestionSettingsModal"
                      @question-delete="handleQuestionDelete"
                    ></webropol-survey-question>
                  </webropol-survey-page>

                  <!-- Thank you page -->
                  <div class="flex items-center space-x-3 p-3 hover:bg-webropol-gray-50 rounded-lg cursor-pointer transition-colors">
                    <i class="fal fa-heart text-green-600"></i>
                    <span class="text-webropol-gray-700">Thank you page</span>
                  </div>
                  
                  <!-- Cancelled Participants -->
                  <div class="flex items-center space-x-3 p-3 hover:bg-webropol-gray-50 rounded-lg cursor-pointer transition-colors">
                    <i class="fal fa-user-times text-red-600"></i>
                    <span class="text-webropol-gray-700">Cancelled Participants</span>
                  </div>
                </div>
                
                                <!-- Styles Tab Content -->
                <div x-show="activeTab === 'styles'" x-data="surveyStylesApp()" class="space-y-6 mb-6">
                  
                  <!-- Survey Pages Section -->
                  <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fal fa-file-alt text-webropol-primary-600"></i>
                      <h4 class="text-webropol-gray-900 font-semibold">Survey Pages</h4>
                    </div>
                    <p class="text-sm text-webropol-gray-500 -mt-3 mb-4">Customize the appearance of your survey page cards</p>
                    
                    <div class="grid grid-cols-2 gap-4">
                      <!-- Color Mode Option -->
                      <label class="relative cursor-pointer group">
                        <input type="radio" name="surveyColorMode" value="color" x-model="surveyColorMode" class="sr-only peer">
                        <div class="p-4 rounded-xl border-2 border-webropol-gray-200 bg-white hover:border-webropol-primary-300 peer-checked:border-webropol-primary-500 peer-checked:ring-1 peer-checked:ring-webropol-primary-500 transition-all h-full">
                          <div class="flex items-center gap-2 mb-2">
                            <div class="w-4 h-4 rounded-full border border-gray-200 shadow-sm" :style="ackground-color: rgba(, , , )"></div>
                            <span class="font-medium text-webropol-gray-900">Color Mode</span>
                          </div>
                          <p class="text-xs text-webropol-gray-500">Apply color with transparency</p>
                        </div>
                        <div class="absolute top-4 right-4 opacity-0 peer-checked:opacity-100 text-webropol-primary-600 transition-opacity">
                          <i class="fas fa-check-circle"></i>
                        </div>
                      </label>
                      
                      <!-- Transparent Option -->
                      <label class="relative cursor-pointer group">
                        <input type="radio" name="surveyColorMode" value="transparent" x-model="surveyColorMode" class="sr-only peer">
                        <div class="p-4 rounded-xl border-2 border-webropol-gray-200 bg-white hover:border-webropol-primary-300 peer-checked:border-webropol-primary-500 peer-checked:ring-1 peer-checked:ring-webropol-primary-500 transition-all h-full">
                          <div class="flex items-center gap-2 mb-2">
                            <div class="w-4 h-4 rounded-full border-2 border-dashed border-gray-300"></div>
                            <span class="font-medium text-webropol-gray-900">Transparent</span>
                          </div>
                          <p class="text-xs text-webropol-gray-500">No background color</p>
                        </div>
                        <div class="absolute top-4 right-4 opacity-0 peer-checked:opacity-100 text-webropol-primary-600 transition-opacity">
                          <i class="fas fa-check-circle"></i>
                        </div>
                      </label>
                    </div>

                    <!-- Color Settings (Conditional) -->
                    <div x-show="surveyColorMode === 'color'" x-transition class="bg-webropol-gray-50 rounded-xl p-5 space-y-5 border border-webropol-gray-100">
                      <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-webropol-gray-700">Color</span>
                        <div class="w-12 h-8 rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:ring-2 hover:ring-webropol-primary-200 transition-all" 
                             :style="ackground-color: rgba(, , , )"
                             @click="openColorPicker('survey')">
                        </div>
                      </div>
                      
                      <div class="space-y-3">
                        <div class="flex items-center justify-between">
                          <span class="text-sm font-medium text-webropol-gray-700">Transparency</span>
                          <div class="flex items-center bg-white rounded-md border border-gray-200 px-2 py-1">
                            <input type="number" x-model="surveyTransparency" min="0" max="100" 
                                   class="w-8 text-right text-sm border-none p-0 focus:ring-0 text-webropol-gray-700">
                            <span class="text-sm text-webropol-gray-400 ml-1">%</span>
                          </div>
                        </div>
                        <input type="range" min="0" max="100" x-model="surveyTransparency" 
                               class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-webropol-primary-600">
                      </div>
                      
                      <label class="flex items-center gap-3 cursor-pointer group">
                        <div class="relative">
                          <input type="checkbox" x-model="surveyBlur" class="sr-only peer">
                          <div class="w-10 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-webropol-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-webropol-primary-600"></div>
                        </div>
                        <span class="text-sm font-medium text-webropol-gray-700 group-hover:text-webropol-primary-700 transition-colors">Apply blur effect</span>
                      </label>
                    </div>
                  </div>

                  <hr class="border-webropol-gray-100">

                  <!-- Survey Background Section -->
                  <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fal fa-image-circle-plus text-webropol-primary-600"></i>
                      <h4 class="text-webropol-gray-900 font-semibold">Survey Background</h4>
                    </div>
                    <p class="text-sm text-webropol-gray-500 -mt-3 mb-4">Set the background color and image behind your survey</p>
                    
                    <div class="bg-white rounded-xl border border-webropol-gray-200 p-1">
                      <div class="flex items-center justify-between p-3">
                        <span class="text-sm font-medium text-webropol-gray-700">Background Color</span>
                        <div class="w-12 h-8 rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:ring-2 hover:ring-webropol-primary-200 transition-all" 
                             :style="ackground-color: rgb(, , )"
                             @click="openColorPicker('page')">
                        </div>
                      </div>
                    </div>
                    
                    <div class="bg-white rounded-xl border border-webropol-gray-200 overflow-hidden">
                      <div class="p-4 border-b border-webropol-gray-100 bg-gray-50/50">
                        <label class="flex items-center gap-3 cursor-pointer group">
                          <div class="relative">
                            <input type="checkbox" x-model="usePageBackground" class="sr-only peer">
                            <div class="w-10 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-webropol-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-webropol-primary-600"></div>
                          </div>
                          <span class="text-sm font-medium text-webropol-gray-700 group-hover:text-webropol-primary-700 transition-colors">Use background image</span>
                        </label>
                      </div>
                      
                      <div x-show="usePageBackground" x-transition class="p-4 space-y-5">
                        <!-- Image Upload -->
                        <button @click="$refs.imageInput.click()" class="w-full py-3 border-2 border-dashed border-webropol-gray-300 rounded-xl text-webropol-gray-500 hover:border-webropol-primary-400 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-all flex flex-col items-center justify-center gap-2 group">
                          <i class="fal fa-cloud-upload text-xl group-hover:scale-110 transition-transform"></i>
                          <span class="text-sm font-medium">Choose Image</span>
                        </button>
                        <input type="file" x-ref="imageInput" accept="image/*" class="hidden" @change="handleImageUpload($event)">
                        
                        <!-- Image Preview & Controls -->
                        <div x-show="selectedImage" class="space-y-4">
                          <div class="relative rounded-xl overflow-hidden border border-gray-200 shadow-sm group">
                            <img :src="selectedImage" class="w-full h-32 object-cover" alt="Background preview">
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                              <button @click="removeSelectedImage()" class="bg-white/90 text-red-600 px-3 py-1.5 rounded-full text-xs font-medium hover:bg-white transition-colors shadow-lg">
                                Remove Image
                              </button>
                            </div>
                          </div>
                          
                          <div class="grid grid-cols-2 gap-6">
                            <!-- Repeat & Scale -->
                            <div class="space-y-4">
                              <div>
                                <label class="text-xs font-semibold text-webropol-gray-500 uppercase tracking-wider mb-2 block">Repeat</label>
                                <div class="grid grid-cols-2 gap-2">
                                  <button @click="backgroundRepeat = 'no-repeat'" :class="backgroundRepeat === 'no-repeat' ? 'bg-webropol-primary-50 text-webropol-primary-700 border-webropol-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'" class="px-2 py-1.5 text-xs border rounded-lg transition-colors">None</button>
                                  <button @click="backgroundRepeat = 'repeat'" :class="backgroundRepeat === 'repeat' ? 'bg-webropol-primary-50 text-webropol-primary-700 border-webropol-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'" class="px-2 py-1.5 text-xs border rounded-lg transition-colors">Both</button>
                                  <button @click="backgroundRepeat = 'repeat-x'" :class="backgroundRepeat === 'repeat-x' ? 'bg-webropol-primary-50 text-webropol-primary-700 border-webropol-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'" class="px-2 py-1.5 text-xs border rounded-lg transition-colors">Horiz.</button>
                                  <button @click="backgroundRepeat = 'repeat-y'" :class="backgroundRepeat === 'repeat-y' ? 'bg-webropol-primary-50 text-webropol-primary-700 border-webropol-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'" class="px-2 py-1.5 text-xs border rounded-lg transition-colors">Vert.</button>
                                </div>
                              </div>
                              
                              <div>
                                <label class="text-xs font-semibold text-webropol-gray-500 uppercase tracking-wider mb-2 block">Scale</label>
                                <div class="space-y-2">
                                  <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="backgroundScale" value="fit-width" x-model="backgroundScale" class="w-4 h-4 text-webropol-primary-600 border-gray-300 focus:ring-webropol-primary-500">
                                    <span class="text-sm text-gray-700">Fit Width</span>
                                  </label>
                                  <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="backgroundScale" value="fixed" x-model="backgroundScale" class="w-4 h-4 text-webropol-primary-600 border-gray-300 focus:ring-webropol-primary-500">
                                    <span class="text-sm text-gray-700">Fixed</span>
                                  </label>
                                  <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="backgroundScale" value="original" x-model="backgroundScale" class="w-4 h-4 text-webropol-primary-600 border-gray-300 focus:ring-webropol-primary-500">
                                    <span class="text-sm text-gray-700">Original</span>
                                  </label>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Position Grid -->
                            <div>
                              <label class="text-xs font-semibold text-webropol-gray-500 uppercase tracking-wider mb-2 block">Position</label>
                              <div class="grid grid-cols-3 gap-1.5 w-fit">
                                <template x-for="v in ['top', 'center', 'bottom']">
                                  <template x-for="h in ['left', 'center', 'right']">
                                    <button @click="setImagePosition(v, h)" 
                                            :class="imagePositionVertical === v && imagePositionHorizontal === h ? 'bg-webropol-primary-600 text-white shadow-md ring-2 ring-webropol-primary-200' : 'bg-white border border-gray-200 text-gray-400 hover:bg-gray-50 hover:text-gray-600'"
                                            class="w-8 h-8 rounded-lg text-[10px] flex items-center justify-center transition-all">
                                      <i class="fas fa-circle text-[4px]"></i>
                                    </button>
                                  </template>
                                </template>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Style Actions Section -->
                  <div class="pt-4 flex gap-3">
                    <button class="flex-1 bg-webropol-primary-600 text-white px-4 py-2.5 rounded-xl font-medium hover:bg-webropol-primary-700 transition-colors shadow-sm hover:shadow flex items-center justify-center gap-2" @click="applySelectedStyle()">
                      <i class="fal fa-check"></i>
                      <span>Apply Changes</span>
                    </button>
                    <button class="px-4 py-2.5 rounded-xl font-medium text-webropol-gray-600 hover:bg-webropol-gray-100 transition-colors border border-transparent hover:border-webropol-gray-200" @click="resetStyles()">
                      <i class="fal fa-undo"></i>
                      <span>Reset</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Main Canvas Area -->
            <div class="lg:col-span-3">
              <!-- Survey Background Wrapper -->
              <div id="surveyBackgroundWrapper" class="survey-background-wrapper min-h-screen relative p-6">
                <!-- Page Background Layer (placed above wrapper background) -->
                <div id="pageBackground" class="absolute inset-0 z-0 pointer-events-none"></div>
                
                <div class="space-y-8 relative z-10">
                <!-- Page Title -->
                <!-- Title moved inside the page card below -->
                
                <!-- Visual Separator for Page 1 -->
                <webropol-merge-pages page-number="1" show-merge="false"></webropol-merge-pages>
                
                <!-- Page container -->
                <section class="relative bg-white rounded-3xl border border-webropol-gray-100/80 p-6 sm:p-8 md:p-10 space-y-4 mb-4">
                  <!-- Page title inside card -->
                  <div class="text-center">
                    <h1 class="text-4xl font-bold text-webropol-gray-900">Customer Satisfaction Survey</h1>
                  </div>

                  <!-- Mandatory Questions Alert -->
                  <webropol-alert-info x-show="showMandatoryInfo">Mandatory questions are marked with an asterisk (<span class="text-red-600 font-bold">*</span>)</webropol-alert-info>

                  <!-- Contact Form Question (Question 1) -->
                     <div x-data="{ selected: false, questionId: 'q1', isMandatory: (function(){ try { const saved = JSON.parse(localStorage.getItem('webropol_survey_mandatory_questions') || '{}'); return saved['q1'] || false; } catch(e) { return false; } })() }" 
                       @click-question.window="if ($event.detail !== questionId) selected = false"
                       class="question-card" :class="selected ? 'selected' : ''"
                       x-init="$watch('isMandatory', (value) => { try { const saved = JSON.parse(localStorage.getItem('webropol_survey_mandatory_questions') || '{}'); saved['q1'] = value; localStorage.setItem('webropol_survey_mandatory_questions', JSON.stringify(saved)); } catch(e) {} $root.updateMandatoryInfo(); })">
                    
                    <!-- Drag handle -->
                    <div class="drag-handle" title="Drag to reorder">
                      <i class="fal fa-arrows-alt"></i>
                    </div>
                    
                    <!-- Expanded header and toolbar (EDIT MODE) -->
                    <div x-show="selected" 
                         x-transition:enter="transition ease-out duration-200" 
                         x-transition:enter-start="opacity-0 -translate-y-2" 
                         x-transition:enter-end="opacity-100 translate-y-0"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100 translate-y-0"
                         x-transition:leave-end="opacity-0 -translate-y-2"
                         class="question-card-header">
                      <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 bg-white px-1 py-1 rounded-lg border border-gray-100">
                          <div class="flex items-center justify-center w-6 h-6 text-orange-600 bg-orange-100 rounded-md">
                            <i class="fal fa-address-card text-xs"></i>
                          </div>
                          <span class="text-xs font-medium text-gray-700">Contact form</span>
                        </div>
                      </div>
                      <div class="flex items-center gap-1 question-card-toolbar">
                        <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Rules and Jumps"><i class="fal fa-shuffle"></i></button>
                        <div class="relative" x-data="{ mandatoryOpen: false }">
                          <button @click="mandatoryOpen = !mandatoryOpen" @click.outside="mandatoryOpen = false" 
                            :class="isMandatory ? 'bg-red-50 text-red-500 hover:bg-red-100' : 'text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50'" 
                            class="transition-colors px-2 py-1 rounded" title="Required field">
                            <i class="fal fa-asterisk"></i>
                          </button>
                          <div x-show="mandatoryOpen" x-transition class="absolute top-full right-0 mt-1 z-50 w-64">
                            <webropol-context-menu
                              items='[{"id": "not-mandatory", "label": "Question is not mandatory", "showRadio": true, "radioGroup": "mandatory", "checked": true}, {"id": "mandatory", "label": "Question is mandatory", "icon": "fas fa-asterisk", "iconClass": "text-red-600", "iconPosition": "right", "showRadio": true, "radioGroup": "mandatory", "bgClass": "hover:bg-red-50"}]'
                              width="auto"
                              @item-click="isMandatory = ($event.detail.id === 'mandatory'); mandatoryOpen = false"
                            ></webropol-context-menu>
                          </div>
                        </div>
                        <div class="relative" x-data="{ open: false }">
                          <button @click="open = !open" @click.outside="open = false" class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Visibility">
                            <i class="fal fa-eye"></i>
                          </button>
                          <div x-show="open" x-transition class="absolute top-full left-0 mt-1 z-50 w-40">
                            <webropol-context-menu
                              items='[{"id": "visible", "label": "Visible", "icon": "fal fa-eye"}, {"id": "hidden", "label": "Hidden", "icon": "fal fa-eye-slash"}, {"id": "disabled", "label": "Disabled", "icon": "fal fa-ban"}]'
                              width="auto"
                              @item-click="open = false"
                            ></webropol-context-menu>
                          </div>
                        </div>
                        <div class="js-copy-btn-container inline-flex items-center" :data-question-id="questionId">
                          <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Copy" @click="copyQuestionNow(questionId)"><i class="fal fa-copy"></i></button>
                        </div>
                        <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Settings"><i class="fal fa-cog"></i></button>
                        <button class="text-red-500 hover:text-red-600 hover:bg-red-50 transition-colors" title="Delete"><i class="fa-light fa-trash-can"></i></button>
                      </div>
                    </div>

                    <!-- Collapsed (unselected) content preview - VIEW MODE -->
                    <div x-show="!selected" 
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0"
                         x-transition:enter-end="opacity-100"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100"
                         x-transition:leave-end="opacity-0"
                         class="p-6 cursor-pointer group question-card-collapsed transition-colors rounded-3xl" 
                         @click="selected = true; $dispatch('click-question', questionId)">
                      <div class="mb-4">
                        <h3 class="text-base font-semibold text-webropol-gray-900 group-hover:text-webropol-primary-700 transition-colors">
                          1. Please fill in your details.
                        </h3>
                      </div>
                      
                      <div class="space-y-3">
                        <div class="flex items-center gap-4">
                          <label class="text-sm text-webropol-gray-700 w-24">First name</label>
                          <input type="text" class="flex-1 px-4 py-2 border border-webropol-gray-300 rounded-lg bg-white" disabled>
                        </div>
                        <div class="flex items-center gap-4">
                          <label class="text-sm text-webropol-gray-700 w-24">Last name</label>
                          <input type="text" class="flex-1 px-4 py-2 border border-webropol-gray-300 rounded-lg bg-white" disabled>
                        </div>
                        <div class="flex items-center gap-4">
                          <label class="text-sm text-webropol-gray-700 w-24">Mobile</label>
                          <input type="tel" class="flex-1 px-4 py-2 border border-webropol-gray-300 rounded-lg bg-white" disabled>
                        </div>
                        <div class="flex items-center gap-4">
                          <label class="text-sm text-webropol-gray-700 w-24">Email</label>
                          <input type="email" class="flex-1 px-4 py-2 border border-webropol-gray-300 rounded-lg bg-white" disabled>
                        </div>
                      </div>
                    </div>

                    <!-- Expanded (selected) content -->
                    <div x-show="selected" class="p-6 rounded-b-3xl bg-white">
                      <div class="mb-6">
                        <label class="block text-lg font-semibold text-webropol-gray-900 mb-4">
                          1. Please fill in your details.
                        </label>

                        <div class="space-y-4">
                          <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-webropol-gray-700 w-24">First name</label>
                            <input type="text" class="flex-1 px-4 py-3 border border-webropol-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-webropol-primary-500/20 focus:border-webropol-primary-500 transition-all" placeholder="Enter first name">
                          </div>
                          <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-webropol-gray-700 w-24">Last name</label>
                            <input type="text" class="flex-1 px-4 py-3 border border-webropol-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-webropol-primary-500/20 focus:border-webropol-primary-500 transition-all" placeholder="Enter last name">
                          </div>
                          <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-webropol-gray-700 w-24">Mobile</label>
                            <input type="tel" class="flex-1 px-4 py-3 border border-webropol-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-webropol-primary-500/20 focus:border-webropol-primary-500 transition-all" placeholder="Enter mobile number">
                          </div>
                          <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-webropol-gray-700 w-24">Email</label>
                            <input type="email" class="flex-1 px-4 py-3 border border-webropol-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-webropol-primary-500/20 focus:border-webropol-primary-500 transition-all" placeholder="Enter email address">
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Drag handle -->
                    <button x-show="selected" title="Drag to reorder"
                            class="hidden sm:flex items-center justify-center cursor-move text-white bg-webropol-primary-700 hover:bg-webropol-primary-800 transition-colors rounded-l-xl w-10 h-14 absolute right-0 top-1/2 -translate-y-1/2 shadow">
                      <i class="fal fa-arrows-alt"></i>
                    </button>
                  </div>

                  <!-- Quick actions -->
                  <webropol-page-quick-actions
                    actions='[
                      {"id":"add-question","label":"Add Question","icon":"fas fa-square-plus","color":"red"},
                      {"id":"add-text","label":"Add Text/Media","icon":"fal fa-block-quote","color":"purple"},
                      {"id":"add-break","label":"Add Page Break","icon":"fal fa-file-dashed-line","color":"orange"}
                    ]'
                  ></webropol-page-quick-actions>

                  <!-- Auto Suggest Question (Question 2) -->
                     <div x-data="{ selected: false, questionId: 'q2', isMandatory: (function(){ try { const saved = JSON.parse(localStorage.getItem('webropol_survey_mandatory_questions') || '{}'); return saved['q2'] || false; } catch(e) { return false; } })() }" 
                       @click-question.window="if ($event.detail !== questionId) selected = false"
                       class="question-card" :class="selected ? 'selected' : ''"
                       x-init="$watch('isMandatory', (value) => { try { const saved = JSON.parse(localStorage.getItem('webropol_survey_mandatory_questions') || '{}'); saved['q2'] = value; localStorage.setItem('webropol_survey_mandatory_questions', JSON.stringify(saved)); } catch(e) {} $root.updateMandatoryInfo(); })">
                    
                    <!-- Drag handle -->
                    <div class="drag-handle" title="Drag to reorder">
                      <i class="fal fa-arrows-alt"></i>
                    </div>
                    
                  <!-- Expanded header and toolbar (EDIT MODE - visible when selected=true) -->
                  <div x-show="selected" 
                       x-transition:enter="transition ease-out duration-200" 
                       x-transition:enter-start="opacity-0 -translate-y-2" 
                       x-transition:enter-end="opacity-100 translate-y-0"
                       x-transition:leave="transition ease-in duration-150"
                       x-transition:leave-start="opacity-100 translate-y-0"
                       x-transition:leave-end="opacity-0 -translate-y-2"
                       class="question-card-header">
                    <div class="flex items-center gap-3">
                      <div class="flex items-center gap-2 bg-white px-1 py-1 rounded-lg border border-gray-100">
                        <div class="flex items-center justify-center w-6 h-6 text-yellow-600 bg-yellow-100 rounded-md">
                          <i class="fal fa-file-alt text-xs"></i>
                        </div>
                        <span class="text-xs font-medium text-gray-700">Autosuggest text field</span>
                      </div>
                    </div>
                    <div class="flex items-center gap-1 question-card-toolbar">
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Rules and Jumps"><i class="fal fa-shuffle"></i></button>
                      <div class="relative" x-data="{ mandatoryOpen: false }">
                        <button @click="mandatoryOpen = !mandatoryOpen" @click.outside="mandatoryOpen = false" 
                          :class="isMandatory ? 'bg-red-50 text-red-500 hover:bg-red-100' : 'text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50'" 
                          class="transition-colors px-2 py-1 rounded" title="Required field">
                          <i class="fal fa-asterisk"></i>
                        </button>
                        <div x-show="mandatoryOpen" x-transition class="absolute top-full right-0 mt-1 z-50 w-64">
                          <webropol-context-menu
                            items='[{"id": "not-mandatory", "label": "Question is not mandatory", "showRadio": true, "radioGroup": "mandatory", "checked": true}, {"id": "mandatory", "label": "Question is mandatory", "icon": "fas fa-asterisk", "iconClass": "text-red-600", "iconPosition": "right", "showRadio": true, "radioGroup": "mandatory", "bgClass": "hover:bg-red-50"}]'
                            width="auto"
                            @item-click="isMandatory = ($event.detail.id === 'mandatory'); mandatoryOpen = false"
                          ></webropol-context-menu>
                        </div>
                      </div>
                      <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" @click.outside="open = false" class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Visibility">
                          <i class="fal fa-eye"></i>
                        </button>
                        <div x-show="open" x-transition class="absolute top-full left-0 mt-1 z-50 w-40">
                          <webropol-context-menu
                            items='[{"id": "visible", "label": "Visible", "icon": "fal fa-eye"}, {"id": "hidden", "label": "Hidden", "icon": "fal fa-eye-slash"}, {"id": "disabled", "label": "Disabled", "icon": "fal fa-ban"}]'
                            width="auto"
                            @item-click="open = false"
                          ></webropol-context-menu>
                        </div>
                      </div>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Add Image"><i class="fal fa-image-circle-plus"></i></button>
                      <div class="js-copy-btn-container inline-flex items-center" :data-question-id="questionId">
                        <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Copy" @click="copyQuestionNow(questionId)"><i class="fal fa-copy"></i></button>
                      </div>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="eTest"><i class="fal fa-graduation-cap"></i></button>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Points"><i class="fal fa-bullseye"></i></button>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Settings" onclick="openQuestionSettingsModal('autosuggest')"><i class="fal fa-cog"></i></button>
                      <button class="text-red-500 hover:text-red-600 hover:bg-red-50 transition-colors" title="Delete"><i class="fa-light fa-trash-can"></i></button>
                    </div>
                  </div>

                  <!-- Collapsed (unselected) content preview - VIEW MODE -->
                  <div x-show="!selected" 
                       x-transition:enter="transition ease-out duration-200"
                       x-transition:enter-start="opacity-0"
                       x-transition:enter-end="opacity-100"
                       x-transition:leave="transition ease-in duration-150"
                       x-transition:leave-start="opacity-100"
                       x-transition:leave-end="opacity-0"
                       class="p-6 cursor-pointer group question-card-collapsed transition-colors rounded-3xl" 
                       @click="selected = true; $dispatch('click-question', questionId)">
                    <!-- Question Title -->
                    <div class="mb-4">
                      <h3 class="text-base font-semibold text-webropol-gray-900 group-hover:text-webropol-primary-700 transition-colors">
                        2. Auto Suggest
                      </h3>
                    </div>
                    
                    <!-- Simple field layout matching design -->
                    <div class="space-y-3">
                      <div class="flex items-start gap-4">
                        <label class="text-sm text-webropol-gray-600 pt-2 min-w-[60px]">Option</label>
                        <div class="flex-1">
                          <input 
                            type="text" 
                            class="w-full px-4 py-2 border border-webropol-gray-300 rounded-lg bg-white text-webropol-gray-400" 
                            disabled 
                            placeholder="Type to see suggestions..."
                          >
                        </div>
                      </div>
                      
                      <!-- Auto-suggest enabled indicator -->
                      <div class="flex items-center gap-2 text-xs text-webropol-gray-500 ml-[76px]">
                        <i class="fal fa-database"></i>
                        <span>Auto-suggest enabled</span>
                      </div>
                    </div>
                  </div>

                  <!-- Expanded (selected) content -->
                  <div x-show="selected" class="p-6 rounded-b-3xl bg-white">
                    <div class="mb-6">
                      <label class="block text-lg font-semibold text-webropol-gray-900 mb-2">
                        2. Auto Suggest
                      </label>

                      <!-- Info Box: Auto Suggest Explanation -->
                      <div id="autosuggestInfo" role="note" aria-label="Auto Suggest information" class="mb-5 p-4 rounded-xl border border-blue-200 bg-blue-50 text-blue-900 flex gap-3">
                        <div class="shrink-0 w-8 h-8 rounded-lg bg-blue-100 text-blue-700 flex items-center justify-center">
                          <i class="fal fa-info-circle"></i>
                        </div>
                        <div class="flex-1">
                          <div class="text-sm leading-relaxed">
                            <p class="font-medium mb-1">Use Autosuggest when you have hundreds or even thousands of possible answers</p>
                            <p class="mb-2">As respondents type, they'll see matching options from the list you set up.</p>
                            <ul class="list-disc ml-5 space-y-1">
                              <li><b></b>Answers are treated as text responses in the Reporting tab.</b> Charts and tables are <b>not</b> generated.</li>
                              <li>Adding Options:
                              <ul class="list-disc ml-5 space-y-1">
                                <li>Upload a <b>CSV file:</b> comma-delimited, one option per row. Use the provided template to avoid formatting errors.</li>
                                <li>You can add columns with <b>additional variables</b> (e.g., codes, categories, metadata) for each option in the CSV. These extra variables do <b>not</b> appear in Reporting, but they are included when you <b>export results to Excel/CSV.</b></li>
                              </ul>
                              </li>
                            </ul>
                          </div>
                          <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-3">
                            <label class="inline-flex items-center gap-2 text-sm select-none">
                              <input id="autosuggestInfoHide" type="checkbox" class="w-4 h-4 rounded border-blue-300 text-blue-600 focus:ring-blue-500">
                              <span>Don't show this again</span>
                            </label>
                            <div class="flex-1"></div>
                            <button id="autosuggestInfoOk" class="btn btn-secondary w-fit self-start sm:self-auto">
                              <i class="fal fa-check text-sm"></i>
                              <span>Understood</span>
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- Option Input -->
                      <div class="mb-4">
                        <label class="block text-sm font-medium text-webropol-gray-700 mb-2">Option</label>
                        <div class="relative">
                          <input 
                            type="text" 
                            class="w-full px-4 py-3 border border-webropol-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-webropol-primary-500/20 focus:border-webropol-primary-500 transition-all"
                            placeholder="Enter option text"
                          >
                          <button class="absolute right-3 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-gradient-to-br from-webropol-primary-500 to-webropol-primary-600 text-white rounded-lg flex items-center justify-center hover:shadow-medium transition-all">
                            <i class="fal fa-plus text-sm"></i>
                          </button>
                        </div>
                      </div>

                      <!-- Add Option Buttons -->
                      <div class="flex flex-col gap-3 mb-6">
                        <div class="flex items-center gap-3">
                          <button class="btn btn-primary w-fit" onclick="openUploadModal()">
                            <i class="fal fa-upload text-sm"></i>
                            <span>Import Auto Suggestions File</span>
                          </button>
                          <span class="tooltip-container">
                            <button type="button" class="tooltip-trigger tooltip-help" aria-label="More info about importing Auto Suggest file" aria-describedby="import-autosuggest-tip">
                              <i class="fal fa-question-circle"></i>
                            </button>
                            <div id="import-autosuggest-tip" role="tooltip" class="tooltip-panel" data-placement="top">
                              When uploading an AutoSuggest file with more than 1,000 options, it will be placed into a processing queue. While processing you won't be able to send out your survey. Once complete, you'll receive an email notification.
                            </div>
                          </span>
                          <span id="questionUploadStatus" class="hidden whitespace-nowrap inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm">
                            <i class="fal fa-spinner fa-spin"></i>
                            <span>Uploading...</span>
                          </span>
                        </div>
                        <button class="btn btn-secondary w-fit">
                          <i class="fal fa-plus text-sm"></i>
                          <span>Add one row</span>
                        </button>
                        <button class="btn btn-secondary w-fit">
                          <i class="fal fa-plus text-sm"></i>
                          <span>Add or edit multiple rows</span>
                        </button>
                      </div>

                      <!-- Additional actions moved outside card -->
                    </div>
                  </div>

                  <!-- Drag handle (visible when selected) -->
                  <button x-show="selected" title="Drag to reorder" role="button"
                          class="hidden sm:flex items-center justify-center cursor-move text-white bg-webropol-primary-700 hover:bg-webropol-primary-800 transition-colors rounded-l-xl w-10 h-14 absolute right-0 top-1/2 -translate-y-1/2 shadow"
                          aria-hidden="false">
                    <i class="fal fa-arrows-alt"></i>
                  </button>
                  </div>

                  <!-- Quick actions -->
                  <webropol-page-quick-actions
                    actions='[
                      {"id":"add-question","label":"Add Question","icon":"fas fa-square-plus","color":"red"},
                      {"id":"add-text","label":"Add Text/Media","icon":"fal fa-block-quote","color":"purple"},
                      {"id":"add-break","label":"Add Page Break","icon":"fal fa-file-dashed-line","color":"orange"}
                    ]'
                  ></webropol-page-quick-actions>

                  <!-- Open-Ended Question (Question 3) -->
                     <div x-data="{ selected: false, questionId: 'q3-openended', isMandatory: (function(){ try { const saved = JSON.parse(localStorage.getItem('webropol_survey_mandatory_questions') || '{}'); return saved['q3-openended'] || false; } catch(e) { return false; } })() }" 
                       @click-question.window="if ($event.detail !== questionId) selected = false"
                       class="question-card" :class="selected ? 'selected' : ''"
                       x-init="$watch('isMandatory', (value) => { try { const saved = JSON.parse(localStorage.getItem('webropol_survey_mandatory_questions') || '{}'); saved['q3-openended'] = value; localStorage.setItem('webropol_survey_mandatory_questions', JSON.stringify(saved)); } catch(e) {} $root.updateMandatoryInfo(); })">
                    
                    <!-- Drag handle -->
                    <div class="drag-handle" title="Drag to reorder">
                      <i class="fal fa-arrows-alt"></i>
                    </div>
                    
                  <!-- Expanded header and toolbar (EDIT MODE) -->
                  <div x-show="selected" 
                       x-transition:enter="transition ease-out duration-200" 
                       x-transition:enter-start="opacity-0 -translate-y-2" 
                       x-transition:enter-end="opacity-100 translate-y-0"
                       x-transition:leave="transition ease-in duration-150"
                       x-transition:leave-start="opacity-100 translate-y-0"
                       x-transition:leave-end="opacity-0 -translate-y-2"
                       class="question-card-header">
                    <div class="flex items-center gap-3">
                      <div class="flex items-center gap-2 bg-white px-1 py-1 rounded-lg border border-gray-100">
                        <div class="flex items-center justify-center w-6 h-6 text-orange-600 bg-orange-100 rounded-md">
                          <i class="fal fa-font-case text-xs"></i>
                        </div>
                        <span class="text-xs font-medium text-gray-700">Open ended</span>
                      </div>
                    </div>
                    <div class="flex items-center gap-1 question-card-toolbar">
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Rules and Jumps"><i class="fal fa-shuffle"></i></button>
                      <div class="relative" x-data="{ mandatoryOpen: false }">
                        <button @click="mandatoryOpen = !mandatoryOpen" @click.outside="mandatoryOpen = false" 
                          :class="isMandatory ? 'bg-red-50 text-red-500 hover:bg-red-100' : 'text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50'" 
                          class="transition-colors px-2 py-1 rounded" title="Required field">
                          <i class="fal fa-asterisk"></i>
                        </button>
                        <div x-show="mandatoryOpen" x-transition class="absolute top-full right-0 mt-1 z-50 w-64">
                          <webropol-context-menu
                            items='[{"id": "not-mandatory", "label": "Question is not mandatory", "showRadio": true, "radioGroup": "mandatory", "checked": true}, {"id": "mandatory", "label": "Question is mandatory", "icon": "fas fa-asterisk", "iconClass": "text-red-600", "iconPosition": "right", "showRadio": true, "radioGroup": "mandatory", "bgClass": "hover:bg-red-50"}]'
                            width="auto"
                            @item-click="isMandatory = ($event.detail.id === 'mandatory'); mandatoryOpen = false"
                          ></webropol-context-menu>
                        </div>
                      </div>
                      <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" @click.outside="open = false" class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Visibility">
                          <i class="fal fa-eye"></i>
                        </button>
                        <div x-show="open" x-transition class="absolute top-full left-0 mt-1 z-50 w-40">
                          <webropol-context-menu
                            items='[{"id": "visible", "label": "Visible", "icon": "fal fa-eye"}, {"id": "hidden", "label": "Hidden", "icon": "fal fa-eye-slash"}, {"id": "disabled", "label": "Disabled", "icon": "fal fa-ban"}]'
                            width="auto"
                            @item-click="open = false"
                          ></webropol-context-menu>
                        </div>
                      </div>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Add Image"><i class="fal fa-image-circle-plus"></i></button>
                      <div class="js-copy-btn-container inline-flex items-center" :data-question-id="questionId">
                        <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Copy" @click="copyQuestionNow(questionId)"><i class="fal fa-copy"></i></button>
                      </div>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Settings"><i class="fal fa-cog"></i></button>
                      <button class="text-red-500 hover:text-red-600 hover:bg-red-50 transition-colors" title="Delete"><i class="fa-light fa-trash-can"></i></button>
                    </div>
                  </div>

                  <!-- Collapsed (unselected) content preview - VIEW MODE -->
                  <div x-show="!selected" 
                       x-transition:enter="transition ease-out duration-200"
                       x-transition:enter-start="opacity-0"
                       x-transition:enter-end="opacity-100"
                       x-transition:leave="transition ease-in duration-150"
                       x-transition:leave-start="opacity-100"
                       x-transition:leave-end="opacity-0"
                       class="p-6 cursor-pointer group question-card-collapsed transition-colors rounded-3xl" 
                       @click="selected = true; $dispatch('click-question', questionId)">
                    <!-- Question Title -->
                    <div class="mb-4">
                      <h3 class="text-base font-semibold text-webropol-gray-900 group-hover:text-webropol-primary-700 transition-colors">
                        3. What are your thoughts?
                      </h3>
                    </div>
                    
                    <!-- Text area preview -->
                    <div class="space-y-3">
                      <textarea 
                        class="w-full px-4 py-3 border border-webropol-gray-300 rounded-lg bg-white text-webropol-gray-400 resize-none" 
                        rows="4"
                        disabled 
                        placeholder="Please share your thoughts here..."
                      ></textarea>
                    </div>
                  </div>

                  <!-- Expanded (selected) content -->
                  <div x-show="selected" class="p-6 rounded-b-3xl bg-white">
                    <div class="mb-6">
                      <label class="block text-lg font-semibold text-webropol-gray-900 mb-4">
                        3. What are your thoughts?
                      </label>

                      <!-- Text area input -->
                      <div class="mb-4">
                        <textarea 
                          class="w-full px-4 py-3 border border-webropol-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-webropol-primary-500/20 focus:border-webropol-primary-500 transition-all resize-none"
                          rows="6"
                          placeholder="Please share your thoughts here..."
                        ></textarea>
                        <p class="text-xs text-webropol-gray-500 mt-2">
                          <i class="fal fa-info-circle"></i>
                          Respondents can provide detailed feedback
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Drag handle -->
                  <button x-show="selected" title="Drag to reorder"
                          class="hidden sm:flex items-center justify-center cursor-move text-white bg-webropol-primary-700 hover:bg-webropol-primary-800 transition-colors rounded-l-xl w-10 h-14 absolute right-0 top-1/2 -translate-y-1/2 shadow">
                    <i class="fal fa-arrows-alt"></i>
                  </button>
                  </div>

                  <!-- Quick actions -->
                  <webropol-page-quick-actions
                    class="add-question-trigger"
                    actions='[
                      {"id":"add-question","label":"Add Question","icon":"fas fa-square-plus","color":"red"},
                      {"id":"add-text","label":"Add Text/Media","icon":"fal fa-block-quote","color":"purple"},
                      {"id":"add-break","label":"Add Page Break","icon":"fal fa-file-dashed-line","color":"orange"}
                    ]'
                  ></webropol-page-quick-actions>
                  <!-- Submit Button -->
                  <div class="mt-8">
                  <button class="px-8 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-full font-semibold hover:shadow-medium transition-all flex items-center space-x-2 mx-auto w-fit hover-lift">
                    <span>Submit</span>
                  </button>
                  <p class="text-sm text-webropol-gray-500 mt-3">Add optional text here</p>
                  </div>
                </section>
                
                <!-- Visual Separator for Page 2 -->
                <webropol-merge-pages page-number="2" show-merge="true" @merge-page="handleMergePage($event)"></webropol-merge-pages>
                
                <!-- PAGE 2 SECTION: NPS Question -->
                <section class="relative bg-white rounded-3xl border border-webropol-gray-100/80 p-6 sm:p-8 md:p-10 space-y-4 mb-4">
                  <!-- Page title inside card -->
                  <div class="text-center">
                    <h2 class="text-3xl sm:text-4xl font-bold text-webropol-gray-900">Customer Satisfaction Survey</h2>
                  </div>

                  <!-- NPS Question Card -->
                     <div x-data="{ selected: false, questionId: 'q3', isMandatory: (function(){ try { const saved = JSON.parse(localStorage.getItem('webropol_survey_mandatory_questions') || '{}'); return saved['q3'] || false; } catch(e) { return false; } })() }" 
                       @click-question.window="if ($event.detail !== questionId) selected = false"
                       class="question-card" :class="selected ? 'selected' : ''"
                       x-init="$watch('isMandatory', (value) => { try { const saved = JSON.parse(localStorage.getItem('webropol_survey_mandatory_questions') || '{}'); saved['q3'] = value; localStorage.setItem('webropol_survey_mandatory_questions', JSON.stringify(saved)); } catch(e) {} $root.updateMandatoryInfo(); })">
                    
                    <!-- Drag handle -->
                    <div class="drag-handle" title="Drag to reorder">
                      <i class="fal fa-arrows-alt"></i>
                    </div>
                    
                  <!-- Expanded header and toolbar (EDIT MODE - visible when selected=true) -->
                  <div x-show="selected" 
                       x-transition:enter="transition ease-out duration-200" 
                       x-transition:enter-start="opacity-0 -translate-y-2" 
                       x-transition:enter-end="opacity-100 translate-y-0"
                       x-transition:leave="transition ease-in duration-150"
                       x-transition:leave-start="opacity-100 translate-y-0"
                       x-transition:leave-end="opacity-0 -translate-y-2"
                       class="question-card-header">
                    <div class="flex items-center gap-3">
                      <div class="flex items-center gap-2 bg-white px-1 py-1 rounded-lg border border-gray-100">
                        <div class="flex items-center justify-center w-6 h-6 text-purple-600 bg-purple-100 rounded-md">
                          <i class="fal fa-tachometer-alt text-xs"></i>
                        </div>
                        <span class="text-xs font-medium text-gray-700">NPS</span>
                      </div>
                    </div>
                    <div class="flex items-center gap-1 question-card-toolbar">
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Rules and Jumps"><i class="fal fa-shuffle"></i></button>
                      <div class="relative" x-data="{ mandatoryOpen: false }">
                        <button @click="mandatoryOpen = !mandatoryOpen" @click.outside="mandatoryOpen = false" 
                          :class="isMandatory ? 'bg-red-50 text-red-500 hover:bg-red-100' : 'text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50'" 
                          class="transition-colors px-2 py-1 rounded" title="Required field">
                          <i class="fal fa-asterisk"></i>
                        </button>
                        <div x-show="mandatoryOpen" x-transition class="absolute top-full right-0 mt-1 z-50 w-64">
                          <webropol-context-menu
                            items='[{"id": "not-mandatory", "label": "Question is not mandatory", "showRadio": true, "radioGroup": "mandatory", "checked": true}, {"id": "mandatory", "label": "Question is mandatory", "icon": "fas fa-asterisk", "iconClass": "text-red-600", "iconPosition": "right", "showRadio": true, "radioGroup": "mandatory", "bgClass": "hover:bg-red-50"}]'
                            width="auto"
                            @item-click="isMandatory = ($event.detail.id === 'mandatory'); mandatoryOpen = false"
                          ></webropol-context-menu>
                        </div>
                      </div>
                      <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" @click.outside="open = false" class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Visibility">
                          <i class="fal fa-eye"></i>
                        </button>
                        <div x-show="open" x-transition class="absolute top-full left-0 mt-1 z-50 w-40">
                          <webropol-context-menu
                            items='[{"id": "visible", "label": "Visible", "icon": "fal fa-eye"}, {"id": "hidden", "label": "Hidden", "icon": "fal fa-eye-slash"}, {"id": "disabled", "label": "Disabled", "icon": "fal fa-ban"}]'
                            width="auto"
                            @item-click="open = false"
                          ></webropol-context-menu>
                        </div>
                      </div>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Add Image"><i class="fal fa-image-circle-plus"></i></button>
                      <div class="js-copy-btn-container inline-flex items-center" :data-question-id="questionId">
                        <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Copy" @click="copyQuestionNow(questionId)"><i class="fal fa-copy"></i></button>
                      </div>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="eTest"><i class="fal fa-graduation-cap"></i></button>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Points"><i class="fal fa-bullseye"></i></button>
                      <button class="text-webropol-gray-500 hover:text-webropol-primary-600 hover:bg-webropol-primary-50 transition-colors" title="Settings" onclick="openQuestionSettingsModal('nps')"><i class="fal fa-cog"></i></button>
                      <button class="text-red-500 hover:text-red-600 hover:bg-red-50 transition-colors" title="Delete"><i class="fa-light fa-trash-can"></i></button>
                    </div>
                  </div>

                  <!-- Collapsed (unselected) content preview -->
                  <div x-show="!selected" class="p-6 cursor-pointer group question-card-collapsed transition-colors rounded-3xl" @click="selected = true; $dispatch('click-question', questionId)">
                    <div class="flex items-start justify-between mb-4">
                      <label class="block text-lg font-semibold text-webropol-gray-900 group-hover:text-webropol-primary-700 transition-colors">
                        3. How likely are you to recommend our product to a friend or colleague?
                      </label>
                      <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded-full font-medium opacity-0 group-hover:opacity-100 transition-opacity">NPS</span>
                        <i class="fal fa-edit text-webropol-primary-600 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                      </div>
                    </div>
                    <p class="text-sm text-webropol-gray-600 mb-4">Please rate on a scale from 0 (Not at all likely) to 10 (Extremely likely).</p>
                    <div>
                      <div class="flex flex-wrap gap-2 items-center" role="radiogroup" aria-label="NPS Scale 0 to 10">
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">0</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">1</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">2</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">3</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">4</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">5</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">6</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">7</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">8</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">9</div></label>
                        <label class="cursor-pointer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white hover:border-webropol-primary-400 transition-all shadow-sm">10</div></label>
                      </div>
                      <div class="flex justify-between text-xs text-webropol-gray-500 mt-3 px-1">
                        <span>Not at all likely</span>
                        <span>Extremely likely</span>
                      </div>
                    </div>
                  </div>

                  <!-- Expanded (selected) content -->
                  <div x-show="selected" class="p-6 rounded-b-3xl bg-white">
                    <div class="mb-6">
                      <label class="block text-lg font-semibold text-webropol-gray-900 mb-2">
                        3. How likely are you to recommend our product to a friend or colleague?
                      </label>
                      <p id="npsQuestionDescription" class="text-sm text-webropol-gray-600 mb-4">Please rate on a scale from 0 (Not at all likely) to 10 (Extremely likely).</p>

                      <!-- Dynamic NPS Render Container -->
                      <div id="npsRenderContainer">
                        <!-- Default radiobuttons appearance - ensures never empty -->
                        <fieldset>
                          <legend class="sr-only">Net Promoter Score Scale</legend>
                          <div class="flex flex-wrap gap-2 items-center" role="radiogroup" aria-label="NPS Scale 0 to 10">
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="0" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">0</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="1" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">1</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="2" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">2</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="3" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">3</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="4" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">4</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="5" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">5</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="6" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">6</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="7" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">7</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="8" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">8</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="9" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">9</div></label>
                            <label class="cursor-pointer"><input type="radio" name="npsScore" value="10" class="sr-only peer"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow">10</div></label>
                          </div>
                          <div class="flex justify-between text-xs text-webropol-gray-500 mt-3 px-1">
                            <span>Not at all likely</span>
                            <span>Extremely likely</span>
                          </div>
                        </fieldset>
                      </div>
                      <script>
                        // EMERGENCY: Ensure NPS container is NEVER empty - immediate initialization
                        (function() {
                          const container = document.getElementById('npsRenderContainer');
                          if (container) {
                            // This runs immediately when HTML is parsed, ensuring container has content
                            const savedStyle = (function(){ try{return localStorage.getItem('nps-appearance')||'radiobuttons';}catch(e){return'radiobuttons';}})();
                            if (savedStyle !== 'radiobuttons' && container.children.length > 0) {
                              // Only replace if we need a different style
                              window.__npsEmergencyRender = function() {
                                if (window.setNPSAppearance) {
                                  window.setNPSAppearance(savedStyle);
                                } else {
                                  // Fallback if main system not ready
                                  setTimeout(() => {
                                    if (window.setNPSAppearance) window.setNPSAppearance(savedStyle);
                                  }, 100);
                                }
                              };
                              // Run when DOM is ready
                              if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', window.__npsEmergencyRender);
                              } else {
                                window.__npsEmergencyRender();
                              }
                            }
                          }
                        })();
                      </script>
                      <template id="npsTemplateRadiobuttons">
                        <fieldset>
                          <legend class="sr-only">Net Promoter Score Scale</legend>
                          <div class="flex flex-wrap gap-2 items-center" role="radiogroup" aria-label="NPS Scale 0 to 10">
                          <script>/* placeholder to preserve order */</script>
                          </div>
                          <div class="flex justify-between text-xs text-webropol-gray-500 mt-3 px-1">
                            <span>Not at all likely</span>
                            <span>Extremely likely</span>
                          </div>
                        </fieldset>
                      </template>
                      <template id="npsTemplateSlider">
                        <div class="space-y-3" aria-label="NPS Slider" role="group">
                          <input id="npsSlider" type="range" min="0" max="10" value="0" class="w-full h-2 rounded-lg appearance-none slider bg-webropol-gray-200">
                          <div class="flex justify-between text-[11px] text-webropol-gray-500">
                            <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
                          </div>
                          <div class="text-xs text-webropol-primary-700 font-medium"><span id="npsSliderValue">Selected: 0</span></div>
                        </div>
                      </template>
                      <template id="npsTemplateSmileys">
                        <div class="flex justify-center gap-4" role="radiogroup" aria-label="NPS Smileys">
                          <button type="button" data-nps-smiley="detractor" class="nps-smiley" aria-pressed="false" title="Detractor (0-6)">??</button>
                          <button type="button" data-nps-smiley="passive" class="nps-smiley" aria-pressed="false" title="Passive (7-8)">??</button>
                          <button type="button" data-nps-smiley="promoter" class="nps-smiley" aria-pressed="false" title="Promoter (9-10)">??</button>
                        </div>
                        <div class="text-center mt-3 text-xs text-webropol-gray-500" id="npsSmileyHint">Select a mood</div>
                      </template>
                    </div>
                    <!-- Follow-up removed per requirement (no text field for NPS) -->
                  </div>

                  <!-- Drag handle (visible when selected) -->
                  <button x-show="selected" title="Drag to reorder" role="button"
                          class="hidden sm:flex items-center justify-center cursor-move text-white bg-webropol-primary-700 hover:bg-webropol-primary-800 transition-colors rounded-l-xl w-10 h-14 absolute right-0 top-1/2 -translate-y-1/2 shadow"
                          aria-hidden="false">
                    <i class="fal fa-arrows-alt"></i>
                  </button>
                  </div>

                  <!-- Quick actions -->
                  <webropol-page-quick-actions
                    class="add-question-trigger"
                    actions='[
                      {"id":"add-question","label":"Add Question","icon":"fas fa-square-plus","color":"red"},
                      {"id":"add-text","label":"Add Text/Media","icon":"fal fa-block-quote","color":"purple"},
                      {"id":"add-break","label":"Add Page Break","icon":"fal fa-file-dashed-line","color":"orange"}
                    ]'
                  ></webropol-page-quick-actions>
                </section>
                

                </div>
                
                <!-- Content Selector Component -->
                <div class="mt-12 mb-12">
                  <webropol-content-selector class="relative block" show-main-actions show-question-types></webropol-content-selector>
                </div>
                
                <!-- Visual Separator for Thank You Page -->
                <div class="mt-16 mb-8 relative">
                  <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t-2 border-webropol-gray-200"></div>
                  </div>
                  <div class="relative flex justify-center">
                    <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-webropol-gray-100 text-webropol-gray-700 text-xs font-medium uppercase tracking-wider rounded-md border border-webropol-gray-200">
                      <i class="fal fa-thumbs-up text-webropol-gray-500"></i>
                        <span>Thank you page | End of Survey</span>
                    </div>
                  </div>
                </div>
                
                <!-- Thank You Page Preview -->
                <div class="mt-8 backdrop-blur-lg rounded-3xl shadow-xl border-2 border-webropol-primary-200 overflow-hidden hover-lift relative z-10">
                  
                  <!-- Settings Button -->
                  <button class="absolute top-4 right-4 p-2.5 text-webropol-gray-400 hover:text-webropol-primary-600 rounded-xl hover:bg-white/80 transition-all duration-300 backdrop-blur-sm z-10">
                    <i class="fal fa-cog text-lg"></i>
                  </button>
                  
                  <!-- Gradient Background Decoration -->
                  <div class="absolute inset-0 bg-gradient-to-br from-webropol-primary-50/30 via-purple-50/20 to-pink-50/30 pointer-events-none"></div>
                  <div class="absolute top-0 left-1/4 w-64 h-64 bg-webropol-primary-200/20 rounded-full blur-3xl"></div>
                  <div class="absolute bottom-0 right-1/4 w-64 h-64 bg-purple-200/20 rounded-full blur-3xl"></div>
                  
                  <!-- Content Container -->
                  <div class="relative mt-8 z-10 p-12 text-center">
                    <!-- Success Icon with Animation -->
                    <div class="mb-8 mt-6 flex justify-center">
                      <div class="relative">
                        <!-- Outer glow ring -->
                        <div class="absolute inset-0 bg-gradient-to-r from-webropol-primary-400 to-green-400 rounded-full blur-xl opacity-30 animate-pulse"></div>
                        <!-- Icon circle -->
                        <div class="relative w-24 h-24 bg-gradient-to-br from-webropol-primary-500 to-green-500 rounded-full flex items-center justify-center shadow-2xl transform hover:scale-110 transition-transform duration-300">
                          <i class="fal fa-thumbs-up text-4xl text-white"></i>
                        </div>
                        <!-- Sparkle elements -->
                        <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full animate-bounce delay-100"></div>
                        <div class="absolute -bottom-1 -left-1 w-4 h-4 bg-pink-400 rounded-full animate-bounce delay-300"></div>
                      </div>
                    </div>
                    
                    <!-- Main Message -->
                    <h2 class="text-4xl font-bold mb-4 bg-gradient-to-r from-webropol-gray-900 via-webropol-primary-800 to-webropol-gray-900 bg-clip-text text-transparent">
                      Thank you for your participation!
                    </h2>
                    
                    <!-- Subtext -->
                    <p class="text-lg text-webropol-gray-600 mb-8 max-w-md mx-auto font-medium">
                      Your feedback is valuable and helps us improve our services.
                    </p>
                    
                    <!-- Decorative Divider -->
                    <div class="flex items-center justify-center mb-8">
                      <div class="h-px w-16 bg-gradient-to-r from-transparent via-webropol-primary-300 to-transparent"></div>
                      <div class="mx-3 w-2 h-2 bg-webropol-primary-400 rounded-full"></div>
                      <div class="h-px w-16 bg-gradient-to-r from-transparent via-webropol-primary-300 to-transparent"></div>
                    </div>
                    
                    <!-- Webropol Logo -->
                    <div class="flex justify-center">
                      <div class="p-4 transition-shadow duration-300">
                        <img src="../img/logo/W-logo-dark.svg" alt="Webropol" class="w-48 h-12 object-contain" />
                      </div>
                    </div>
                    
                    <!-- Survey Powered By Text -->
                    <div class="mt-4 text-center">
                      <p class="text-sm text-webropol-gray-600 mb-1">Survey Powered by Webropol</p>
                      <a href="https://webropol.com" target="_blank" class="text-sm text-webropol-primary-600 hover:text-webropol-primary-700 underline hover:no-underline transition-all duration-200">
                        Click here to read more
                      </a>
                    </div>
                  </div>
                </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Floating Create Button Component -->
  <webropol-floating-button></webropol-floating-button>

  <!-- Survey Status Change Modal -->
  <div id="surveyStatusModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 660px;">
      <div class="modal-header">
        <h2 class="modal-title flex items-center gap-3">
          <div class="w-10 h-10 bg-webropol-primary-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <i class="fal fa-toggle-on text-webropol-primary-600 text-lg"></i>
          </div>
          <span>Change Survey Status (Demo Only)</span>
        </h2>
        <button class="modal-close" onclick="closeSurveyStatusModal()" aria-label="Close modal">
          <i class="fal fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h3 class="section-title">
            <i class="fal fa-list-check"></i>
            <span>Select Status</span>
          </h3>
          <p class="text-sm text-webropol-gray-600 mb-4">Choose the current status for your survey</p>
          
          <div class="space-y-3">
            <!-- Open Status -->
            <label class="flex items-center gap-4 p-4 rounded-xl border-2 cursor-pointer transition-all hover:shadow-md bg-gradient-to-r from-green-50 to-emerald-50 border-green-200" onclick="selectSurveyStatus('Open')">
              <input type="radio" name="surveyStatus" value="Open" class="w-5 h-5 text-green-600 border-green-300 focus:ring-green-500">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="inline-flex w-8 h-8 rounded-full bg-green-100 text-green-700 items-center justify-center">
                    <i class="fal fa-lock-open"></i>
                  </span>
                  <span class="font-semibold text-green-900">Open</span>
                </div>
                <p class="text-xs text-green-700 ml-10">Survey is active and accepting responses</p>
              </div>
            </label>

            <!-- Draft Status -->
            <label class="flex items-center gap-4 p-4 rounded-xl border-2 cursor-pointer transition-all hover:shadow-md bg-gradient-to-r from-orange-50 to-amber-50 border-orange-200" onclick="selectSurveyStatus('Draft')">
              <input type="radio" name="surveyStatus" value="Draft" class="w-5 h-5 text-orange-600 border-orange-300 focus:ring-orange-500">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="inline-flex w-8 h-8 rounded-full bg-orange-100 text-orange-700 items-center justify-center">
                    <i class="fal fa-pen-to-square"></i>
                  </span>
                  <span class="font-semibold text-orange-900">Draft</span>
                </div>
                <p class="text-xs text-orange-700 ml-10">Survey is in progress and not yet published</p>
              </div>
            </label>

            <!-- Close Status -->
            <label class="flex items-center gap-4 p-4 rounded-xl border-2 cursor-pointer transition-all hover:shadow-md bg-gradient-to-r from-gray-50 to-slate-50 border-gray-200" onclick="selectSurveyStatus('Close')">
              <input type="radio" name="surveyStatus" value="Close" class="w-5 h-5 text-gray-600 border-gray-300 focus:ring-gray-500">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="inline-flex w-8 h-8 rounded-full bg-gray-100 text-gray-700 items-center justify-center">
                    <i class="fal fa-lock"></i>
                  </span>
                  <span class="font-semibold text-gray-900">Close</span>
                </div>
                <p class="text-xs text-gray-700 ml-10">Survey is closed and no longer accepting responses</p>
              </div>
            </label>
          </div>

          <!-- Close Options (shown when Close is selected) -->
          <div id="closeOptions" class="mt-6 hidden">
            <!-- Warning Message -->
            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-lg mb-4">
              <div class="flex items-start gap-3">
                <i class="fal fa-exclamation-triangle text-amber-600 text-xl mt-0.5"></i>
                <div>
                  <h4 class="font-semibold text-amber-900 mb-1">Warning</h4>
                  <p class="text-sm text-amber-800">This will unpublish the survey and it will interrupt any responses in progress.</p>
                </div>
              </div>
            </div>

            <!-- Close Options Checkboxes -->
            <div class="space-y-3">
              <h4 class="font-semibold text-webropol-gray-900 mb-3">Select distribution channels to close:</h4>
              
              <label class="flex items-start gap-3 p-3 rounded-lg border border-webropol-gray-200 hover:bg-webropol-gray-50 cursor-pointer transition-colors">
                <input type="checkbox" name="closeChannel" value="email" class="w-5 h-5 text-webropol-primary-600 border-webropol-gray-300 rounded focus:ring-webropol-primary-500 mt-0.5">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <i class="fal fa-envelope text-webropol-primary-600"></i>
                    <span class="font-medium text-webropol-gray-900">Email survey - Private links</span>
                  </div>
                  <p class="text-xs text-webropol-gray-600">Close email invitations with unique private links</p>
                </div>
              </label>

              <label class="flex items-start gap-3 p-3 rounded-lg border border-webropol-gray-200 hover:bg-webropol-gray-50 cursor-pointer transition-colors">
                <input type="checkbox" name="closeChannel" value="weblink" class="w-5 h-5 text-webropol-primary-600 border-webropol-gray-300 rounded focus:ring-webropol-primary-500 mt-0.5">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <i class="fal fa-link text-webropol-primary-600"></i>
                    <span class="font-medium text-webropol-gray-900">Weblink - Public link</span>
                  </div>
                  <p class="text-xs text-webropol-gray-600">Close public web link access to the survey</p>
                </div>
              </label>

              <label class="flex items-start gap-3 p-3 rounded-lg border border-webropol-gray-200 hover:bg-webropol-gray-50 cursor-pointer transition-colors">
                <input type="checkbox" name="closeChannel" value="sms" class="w-5 h-5 text-webropol-primary-600 border-webropol-gray-300 rounded focus:ring-webropol-primary-500 mt-0.5">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <i class="fal fa-sms text-webropol-primary-600"></i>
                    <span class="font-medium text-webropol-gray-900">SMS survey - Private link</span>
                  </div>
                  <p class="text-xs text-webropol-gray-600">Close SMS invitations with unique private links</p>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-actions">
          <button class="btn btn-secondary" onclick="closeSurveyStatusModal()">Cancel</button>
          <button class="btn btn-primary" onclick="applySurveyStatus()">
            <i class="fal fa-check"></i>
            <span>Apply Status</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Auto-Suggest Modal -->
  <div id="uploadModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <div class="modal-title-section">
          <h2 class="modal-title">
            <div class="w-10 h-10 bg-gradient-to-br from-orange-100 to-orange-100 rounded-full flex items-center justify-center">
              <i class="fal fa-upload text-orange-600 text-lg"></i>
            </div>
            Upload Auto-Suggest
          </h2>
        </div>
        <button class="modal-close" onclick="closeUploadModal()" aria-label="Close modal">
          <i class="fal fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h3 class="section-title">
            <span class="step-badge">Step 1</span>
            <i class="fal fa-download"></i>
            <span>Download template</span>
          </h3>
          <button class="btn btn-secondary" onclick="downloadTemplate()">
            <i class="fal fa-download"></i>
            Get template file
          </button>
        </div>
        <hr style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
        <div class="settings-section">
          <h3 class="section-title">
            <span class="step-badge">Step 2</span>
            <i class="fal fa-upload"></i>
            <span>Upload template</span>
          </h3>
          <p style="margin-bottom: 1rem; color: var(--webropol-gray-600);">
            Note: must be in CSV format, comma delimited
          </p>
          <div class="file-upload-section">
            <div class="file-upload-icon">
              <i class="fal fa-cloud-upload"></i>
            </div>
            <p style="margin-bottom: 1rem;">
              <strong>Choose File</strong>
              or drag and drop your CSV file here
            </p>
            <input
              type="file"
              id="csvFile"
              accept=".csv"
              style="display: none;"
            >
            <div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center;">
              <button id="chooseFileBtn" class="px-4 py-2 bg-webropol-gray-100 hover:bg-webropol-gray-200 text-webropol-gray-700 rounded-full font-medium transition-colors flex items-center space-x-2" onclick="document.getElementById('csvFile').click()">
                <i class="fal fa-folder-open"></i>
                <span>Choose File</span>
              </button>
              <button id="uploadBtn" class="px-4 py-2 bg-gradient-to-r from-webropol-primary-500 to-webropol-primary-600 text-white rounded-full font-medium transition-all flex items-center space-x-2" onclick="performUpload()" disabled>
                <i class="fal fa-cloud-upload"></i>
                <span>Upload</span>
              </button>
            </div>
            <div id="fileName" style="margin-top: 1rem; font-weight: 600; color: #06b6d4;"></div>
            <button id="removeFileBtn" class="hidden mt-3 p-2 bg-webropol-gray-50 hover:bg-red-50 text-webropol-gray-500 hover:text-red-600 rounded-full transition-all" onclick="removeSelectedFile()">
              <i class="fa-light fa-trash-can"></i>
            </button>
          </div>
        </div>
        <div class="settings-section">
          <button id="removeStoredBtn" class="px-4 py-2 bg-webropol-gray-100 hover:bg-webropol-gray-200 text-webropol-gray-700 rounded-full font-medium transition-colors flex items-center space-x-2" onclick="removeAutoSuggest()" disabled>
            <i class="fa-light fa-trash-can"></i>
            <span>Remove uploaded auto-suggest list</span>
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-actions">
          <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
          <button id="applyBtn" class="btn btn-primary" onclick="applyAndClose()" disabled>
            Apply
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Question Settings Modal -->
  <div id="questionSettingsModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-orange-100 to-orange-200 rounded-xl flex items-center justify-center">
            <i class="fal fa-cog text-orange-600 text-lg"></i>
          </div>
          <h2 class="text-xl font-bold text-webropol-gray-900 m-0">Question settings</h2>
        </div>
        <button class="modal-close w-8 h-8 flex items-center justify-center text-webropol-gray-400 hover:text-webropol-gray-600 hover:bg-webropol-gray-100 rounded-lg transition-all" onclick="closeQuestionSettingsModal()" aria-label="Close modal">
          <i class="fal fa-times text-lg"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Panel switcher wrappers -->
        <div id="qs-panel-autosuggest" class="qs-panel" data-type="autosuggest">
        <!-- Option Orientation Section -->
        <div class="settings-section">
          <h3 class="section-title">
            Option orientation
          </h3>
          <div class="form-group">
            <div class="radio-group orientation-row" style="flex-direction: row;">
              <label class="radio-item active">
                <input
                  type="radio"
                  name="orientation"
                  value="vertical"
                  class="radio-input"
                  checked
                >
                <div class="radio-content">
                  <div class="radio-title">Vertical</div>
                </div>
              </label>
              <label class="radio-item">
                <input
                  type="radio"
                  name="orientation"
                  value="horizontal"
                  class="radio-input"
                >
                <div class="radio-content">
                  <div class="radio-title">Horizontal</div>
                </div>
              </label>
            </div>
          </div>
        </div>
        <hr style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
        </div> <!-- end autosuggest panel -->

        <!-- NPS PANEL -->
        <div id="qs-panel-nps" class="qs-panel" data-type="nps" style="display:none;">
          <div class="settings-section">
            <h3 class="section-title">Appearance of NPS question</h3>
            <div class="form-group">
              <div class="nps-appearance-grid" id="npsAppearanceChoices">
                <button type="button" data-style="radiobuttons" class="nps-appearance-card active" aria-pressed="true">
                  <div class="nps-appearance-preview">
                    <div class="flex gap-1 flex-wrap justify-center">
                      <span class="nps-mini-pill">0</span>
                      <span class="nps-mini-pill">1</span>
                      <span class="nps-mini-pill">2</span>
                      <span class="nps-mini-pill">?</span>
                      <span class="nps-mini-pill">10</span>
                    </div>
                  </div>
                  <span class="nps-appearance-label">Radiobuttons</span>
                </button>
                <button type="button" data-style="slider" class="nps-appearance-card" aria-pressed="false">
                  <div class="nps-appearance-preview">
                    <div class="w-full h-2 rounded bg-gradient-to-r from-webropol-primary-200 to-webropol-primary-500 relative">
                      <div class="absolute -top-1 -ml-2 left-1/3 h-4 w-4 rounded-full bg-webropol-primary-600 shadow"></div>
                    </div>
                  </div>
                  <span class="nps-appearance-label">Slider</span>
                </button>
                <button type="button" data-style="smileys" class="nps-appearance-card" aria-pressed="false">
                  <div class="nps-appearance-preview">
                    <div class="flex gap-2 justify-center text-lg">
                      <span>??</span><span>??</span><span>??</span>
                    </div>
                  </div>
                  <span class="nps-appearance-label">Smileys</span>
                </button>
              </div>
            </div>
          </div>
          <hr style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
          <div class="settings-section">
            <h3 class="section-title">NPS Scale</h3>
            <div class="form-group">
              <div class="radio-group" style="flex-direction: column; gap:.4rem;">
                <label class="radio-item active"><input type="radio" name="nps-scale-order" value="0-10" class="radio-input" checked><div class="radio-content"><div class="radio-title">0-10</div></div></label>
                <label class="radio-item"><input type="radio" name="nps-scale-order" value="10-0" class="radio-input"><div class="radio-content"><div class="radio-title">10-0</div></div></label>
                <label class="radio-item"><input type="radio" name="nps-scale-order" value="1-10" class="radio-input"><div class="radio-content"><div class="radio-title">1-10</div></div></label>
                <label class="radio-item"><input type="radio" name="nps-scale-order" value="10-1" class="radio-input"><div class="radio-content"><div class="radio-title">10-1</div></div></label>
              </div>
            </div>
          </div>
          <hr style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
          <div class="settings-section">
            <div class="form-group" style="display:flex;align-items:center; gap:1rem;">
              <label class="checkbox-item" style="margin:0;">
                <input type="checkbox" id="nps-show-idk" class="checkbox-input">
                <div class="checkbox-content">
                  <span class="checkbox-title">Show "I don't know" option for respondent</span>
                </div>
              </label>
              <input type="text" id="nps-idk-label" value="I don't know" class="form-input" style="max-width:170px;">
            </div>
          </div>
          <hr style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
          <div class="settings-section">
            <h3 class="section-title">Show question description <span class="info-tooltip" data-tooltip="Provide more context for respondents"><i class="fal fa-question-circle"></i></span></h3>
            <div class="form-group">
              <label class="checkbox-item" style="margin:0;">
                <input type="checkbox" id="nps-show-description" class="checkbox-input">
                <div class="checkbox-content">
                  <span class="checkbox-title">Enable description</span>
                  <div id="nps-description-placement" style="display:none; margin-top:.65rem;">
                    <label class="form-label" style="font-size:.7rem; text-transform:uppercase; letter-spacing:.05em;">Placement:</label>
                    <div class="radio-group" style="flex-direction:column; gap:.35rem; margin-top:.35rem;">
                      <label class="radio-item active" style="margin:0;">
                        <input type="radio" name="nps-desc-placement" value="below" class="radio-input" checked>
                        <div class="radio-content"><div class="radio-title">Show below question title</div></div>
                      </label>
                      <label class="radio-item" style="margin:0;">
                        <input type="radio" name="nps-desc-placement" value="above" class="radio-input">
                        <div class="radio-content"><div class="radio-title">Show above question title</div></div>
                      </label>
                    </div>
                  </div>
                </div>
              </label>
            </div>
          </div>
          <hr style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
          <div class="settings-section visibility-row">
            <h3 class="section-title">Visibility</h3>
            <div class="visibility-options ml-8">
              <label class="visibility-item visibility-visible"><input type="radio" name="nps-visibility" value="visible" checked><div class="visibility-icon"><i class="fal fa-eye"></i></div><span>Visible</span></label>
              <label class="visibility-item visibility-hidden"><input type="radio" name="nps-visibility" value="hidden"><div class="visibility-icon"><i class="fal fa-eye-slash"></i></div><span>Hidden</span></label>
              <label class="visibility-item visibility-disabled"><input type="radio" name="nps-visibility" value="disabled"><div class="visibility-icon"><i class="fal fa-ban"></i></div><span>Disabled</span></label>
            </div>
          </div>
        </div> <!-- end nps panel -->
  <!-- Column Configuration Section (Autosuggest only) -->
  <div class="settings-section qs-autosuggest-only">
          <h3 class="section-title">
            Number of options per column
          </h3>
          <div class="form-group">
            <div class="radio-group">
              <label class="radio-item active">
                <input
                  type="radio"
                  name="columns"
                  value="all"
                  class="radio-input"
                  checked
                >
                <div class="radio-content">
                  <div class="radio-title">All options in same column</div>
                </div>
              </label>
              <label class="radio-item has-input">
                <input
                  type="radio"
                  name="columns"
                  value="custom"
                  class="radio-input"
                >
                <div class="radio-content">
                  <div class="radio-title">Custom options per column</div>
                </div>
                <div class="input-row custom-input-row">
                  <input
                    type="number"
                    class="form-input"
                    value="1"
                    min="1"
                    max="10"
                    style="width: 60px; margin-top: -6px; margin-right: 4px;"
                  >
                  <span class="form-helper" style="margin-top: -8px;">options per column</span>
                </div>
              </label>
            </div>
          </div>
        </div>
  <hr class="qs-autosuggest-only" style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
  <div class="qs-autosuggest-only" style="display: flex; gap: 2rem;">
          <!-- Option Placement Section -->
          <div class="settings-section" style="flex: 1; margin-bottom: 0;">
            <h3 class="section-title">
              Option placement title
            </h3>
            <div class="form-group">
              <label class="form-label">Title position</label>
              <webropol-dropdown
                value="left"
                options='[{"label":"Left","value":"left"},{"label":"Right","value":"right"},{"label":"Center","value":"center"},{"label":"Top","value":"top"},{"label":"Bottom","value":"bottom"}]'
              ></webropol-dropdown>
            </div>
          </div>
          <!-- Text Field Configuration -->
          <div class="settings-section" style="flex: 1; margin-bottom: 0;">
            <h3 class="section-title">
              Text field size
            </h3>
            <div class="form-group">
              <label class="form-label">Width</label>
              <div class="input-row">
                <input
                  type="number"
                  class="form-input"
                  value="40"
                  min="1"
                  max="150"
                  style="width: 100px;"
                >
                <span class="form-helper">characters (range 1-150)</span>
              </div>
            </div>
          </div>
        </div>
  <hr class="qs-autosuggest-only" style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
        <!-- Question Description Section -->
  <div class="settings-section qs-autosuggest-only">
          <h3 class="section-title">
            Question description
            <span class="info-tooltip" data-tooltip="Additional information to help users understand the question">
              <i class="fal fa-question-circle"></i>
            </span>
          </h3>
          <div class="form-group">
            <div class="checkbox-item">
              <input type="checkbox" id="showDescription" class="checkbox-input">
              <div class="checkbox-content">
                <label for="showDescription" class="checkbox-title">Show question description</label>
                <div class="placement-options" id="placementOptions" style="display: none;">
                  <label class="form-label">Placement</label>
                  <div class="placement-radio">
                    <label class="radio-item">
                      <input
                        type="radio"
                        name="description-placement"
                        value="below"
                        class="radio-input"
                        checked
                      >
                      <span>Show below question title</span>
                    </label>
                    <label class="radio-item">
                      <input
                        type="radio"
                        name="description-placement"
                        value="above"
                        class="radio-input"
                      >
                      <span>Show above question title</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
  <hr class="qs-autosuggest-only" style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
        <!-- Auto-Suggest Section -->
  <div class="settings-section qs-autosuggest-only" style="display: none;">
          <h3 class="section-title">
            Auto-suggest File
            <span class="tooltip-container" style="display: inline-flex;">
              <button type="button" class="tooltip-trigger" aria-label="More info about Auto-suggest file" aria-describedby="autosuggest-settings-tip">
                <i class="fal fa-question-circle"></i>
              </button>
              <div id="autosuggest-settings-tip" role="tooltip" class="tooltip-panel" data-placement="top">
                When uploading an AutoSuggest file with more than 1,000 options, it will be placed into a processing queue. While processing you won't be able to send out your survey. Once complete, you'll receive an email notification.
              </div>
            </span>
          </h3>
          <div class="file-upload-section-button">
            <div class="file-actions">
              <button class="btn btn-primary" onclick="openUploadModal()">
                Upload file
              </button>
              <div id="mainUploadStatus" class="upload-status">
                No file uploaded
              </div>
            </div>
            <p class="form-helper" style="margin-top: 1rem;">
              Note: File must be in CSV format, comma delimited. Maximum file size: 10MB
            </p>
          </div>
        </div>
  <hr class="qs-autosuggest-only" style="display: none; border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
        <!-- Visibility Section -->
  <div class="settings-section visibility-row qs-autosuggest-only">
          <h3 class="section-title">
            Visibility
          </h3>
          <div class="visibility-options ml-8">
            <label class="visibility-item visibility-visible">
              <input
                type="radio"
                name="visibility"
                value="visible"
                checked
              >
              <div class="visibility-icon">
                <i class="fal fa-eye"></i>
              </div>
              <span>Visible</span>
            </label>
            <label class="visibility-item visibility-hidden">
              <input type="radio" name="visibility" value="hidden">
              <div class="visibility-icon">
                <i class="fal fa-eye-slash"></i>
              </div>
              <span>Hidden</span>
            </label>
            <label class="visibility-item visibility-disabled">
              <input type="radio" name="visibility" value="disabled">
              <div class="visibility-icon">
                <i class="fal fa-ban"></i>
              </div>
              <span>Disabled</span>
            </label>
          </div>
        </div>
        <hr style="border: none; height: 1px; background: #e2e8f0; margin: 1.5rem 0;">
        <!-- Keywords / Save to library -->
        <div class="settings-section">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
            <button class="btn btn-secondary" style="display:inline-flex; align-items:center; gap:0.5rem;">
              <i class="fal fa-save"></i>
              Save question to library
            </button>
            <div style="display:flex; align-items:center; gap:1rem;">
              <div class="keywords-label">
                <i class="fal fa-tags"></i>
                Keywords
                <span class="keywords-count">0</span>
                <span class="info-tooltip" data-tooltip="Add keywords to help categorize and find this question later">
                  <i class="fal fa-question-circle"></i>
                </span>
              </div>
              <div class="keywords-input" aria-hidden="true">
                <div class="keywords-chips"></div>
                <input type="text" placeholder="Add a keyword">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-actions">
          <button class="btn btn-secondary" onclick="closeQuestionSettingsModal()">Cancel</button>
          <button class="btn btn-primary" onclick="applyQuestionSettings()">
            Apply
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Color Picker Modal -->
  <div id="colorPickerModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <div class="modal-title-section">
          <h2 class="modal-title">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center">
              <i class="fal fa-palette text-blue-600 text-lg"></i>
            </div>
            Color Picker
          </h2>
        </div>
        <button class="modal-close" onclick="closeColorPickerModal()" aria-label="Close modal">
          <i class="fal fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Color Type Selector -->
        <div class="settings-section">
          <div class="flex gap-2 mb-4">
            <button id="solidColorBtn" class="btn btn-primary active-color-type" onclick="setColorType('solid')">
              <i class="fal fa-circle"></i>
              Solid Color
            </button>
            <button id="gradientColorBtn" class="btn btn-secondary" onclick="setColorType('gradient')">
              <i class="fal fa-adjust"></i>
              Gradient
            </button>
          </div>
        </div>
        
        <!-- Solid Color Section -->
        <div id="solidColorSection" class="settings-section">
          <!-- Color Canvas -->
          <div class="color-picker-canvas mb-4">
            <div class="relative">
              <canvas id="colorCanvas" width="300" height="200" class="rounded-lg border border-webropol-gray-300 cursor-crosshair"></canvas>
              <div id="colorMarker" class="absolute w-4 h-4 border-2 border-white rounded-full shadow-md pointer-events-none transform -translate-x-2 -translate-y-2"></div>
            </div>
          </div>
          
          <!-- Hue Slider -->
          <div class="mb-4">
            <label class="form-label mb-2">Hue</label>
            <div class="relative">
              <canvas id="hueCanvas" width="300" height="20" class="rounded cursor-pointer w-full"></canvas>
              <div id="hueMarker" class="absolute w-4 h-6 border-2 border-white rounded shadow-md pointer-events-none transform -translate-x-2"></div>
            </div>
          </div>
          
          <!-- Color Values -->
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="form-label">Hex</label>
              <input type="text" id="hexInput" class="form-input" placeholder="#ffffff" maxlength="7">
            </div>
            <div>
              <label class="form-label">Alpha</label>
              <input type="range" id="alphaSlider" min="0" max="100" value="100" class="slider w-full">
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div>
              <label class="form-label">Red</label>
              <input type="number" id="redInput" class="form-input" min="0" max="255" value="255">
            </div>
            <div>
              <label class="form-label">Green</label>
              <input type="number" id="greenInput" class="form-input" min="0" max="255" value="255">
            </div>
            <div>
              <label class="form-label">Blue</label>
              <input type="number" id="blueInput" class="form-input" min="0" max="255" value="255">
            </div>
          </div>
        </div>
        
        <!-- Gradient Section -->
        <div id="gradientSection" class="settings-section" style="display: none;">
          <!-- Gradient Type -->
          <div class="mb-4">
            <label class="form-label mb-2">Gradient Type</label>
            <div class="flex gap-2">
              <button id="linearBtn" class="btn btn-primary active-gradient-type" onclick="setGradientType('linear')">Linear</button>
              <button id="radialBtn" class="btn btn-secondary" onclick="setGradientType('radial')">Radial</button>
            </div>
          </div>
          
          <!-- Direction/Position (for linear) -->
          <div id="linearControls" class="mb-4">
            <label class="form-label mb-2">Direction</label>
            <div class="grid grid-cols-4 gap-2">
              <button class="gradient-direction-btn" data-direction="to right" onclick="setGradientDirection(this)">?</button>
              <button class="gradient-direction-btn" data-direction="to bottom right" onclick="setGradientDirection(this)">?</button>
              <button class="gradient-direction-btn" data-direction="to bottom" onclick="setGradientDirection(this)">?</button>
              <button class="gradient-direction-btn" data-direction="to bottom left" onclick="setGradientDirection(this)">?</button>
            </div>
            <div class="grid grid-cols-4 gap-2 mt-2">
              <button class="gradient-direction-btn" data-direction="to left" onclick="setGradientDirection(this)">?</button>
              <button class="gradient-direction-btn" data-direction="to top left" onclick="setGradientDirection(this)">?</button>
              <button class="gradient-direction-btn" data-direction="to top" onclick="setGradientDirection(this)">?</button>
              <button class="gradient-direction-btn active" data-direction="to top right" onclick="setGradientDirection(this)">?</button>
            </div>
          </div>
          
          <!-- Radial Controls -->
          <div id="radialControls" class="mb-4" style="display: none;">
            <label class="form-label mb-2">Shape</label>
            <div class="flex gap-2">
              <button id="circleBtn" class="btn btn-primary active-radial-shape" onclick="setRadialShape('circle')">Circle</button>
              <button id="ellipseBtn" class="btn btn-secondary" onclick="setRadialShape('ellipse')">Ellipse</button>
            </div>
          </div>
          
          <!-- Gradient Preview -->
          <div class="mb-4">
            <label class="form-label mb-2">Preview</label>
            <div id="gradientPreview" class="w-full h-20 rounded-lg border border-webropol-gray-300"></div>
          </div>
          
          <!-- Color Stops -->
          <div class="mb-4">
            <label class="form-label mb-2">Color Stops</label>
            <div id="colorStops" class="space-y-2">
              <!-- Color stops will be added dynamically -->
            </div>
            <button id="addColorStop" class="btn btn-secondary w-full mt-2" onclick="addColorStop()">
              <i class="fal fa-plus"></i>
              Add Color Stop
            </button>
          </div>
        </div>
        
        <!-- Color Preview -->
        <div class="settings-section">
          <label class="form-label mb-2">Preview</label>
          <div class="flex gap-4">
            <div id="colorPreview" class="w-16 h-16 rounded-lg border-2 border-webropol-gray-300 bg-white"></div>
            <div id="colorInfo" class="flex-1 text-sm text-webropol-gray-600">
              <div>Current Color</div>
              <div id="colorCode">#ffffff</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-actions">
          <button class="btn btn-secondary" onclick="closeColorPickerModal()">Cancel</button>
          <button class="btn btn-primary" onclick="applyColor()">
            Apply Color
          </button>
        </div>
      </div>
    </div>
  </div>



  <script>
    // Modal utility for this page (legacy bespoke modals).
    (function(){
      const MODAL_IDS = ['uploadModal','questionSettingsModal','colorPickerModal','questionModeModal','surveyStatusModal'];
      function portal(el){
        if(!el) return; 
        // Always keep at end of body to outrank siblings with higher stacking contexts.
        document.body.appendChild(el);
      }
      function refreshBodyState(){
        const anyActive = MODAL_IDS.some(id => {
          const m = document.getElementById(id); return m && m.classList.contains('active');
        });
        document.body.classList.toggle('modal-open', anyActive);
        if(anyActive){ document.body.style.overflow='hidden'; } else { document.body.style.overflow=''; }
      }
      function openModal(id){
        console.log('Opening modal:', id);
        const m = document.getElementById(id); 
        if(!m) {
          console.error('Modal not found:', id);
          return;
        }
        portal(m);
        requestAnimationFrame(()=>{ 
          m.classList.add('active'); 
          console.log('Modal activated:', id, 'has active class:', m.classList.contains('active'));
          refreshBodyState(); 
        });
      }
      function closeModal(id){
        const m = document.getElementById(id); if(!m) return; m.classList.remove('active'); refreshBodyState(); }
      // Expose specific functions already referenced inline
      window.openUploadModal = () => openModal('uploadModal');
      window.closeUploadModal = () => closeModal('uploadModal');
      window.openQuestionSettingsModal = () => openModal('questionSettingsModal');
      window.closeQuestionSettingsModal = () => closeModal('questionSettingsModal');
      window.openColorPickerModal = () => openModal('colorPickerModal');
      window.closeColorPickerModal = () => closeModal('colorPickerModal');
      window.openQuestionModeModal = () => openModal('questionModeModal');
      window.closeQuestionModeModal = () => closeModal('questionModeModal');
      window.openSurveyStatusModal = () => openModal('surveyStatusModal');
      window.closeSurveyStatusModal = () => closeModal('surveyStatusModal');
      // Initial portal (in case HTML loaded before script runs)
      MODAL_IDS.forEach(id => { const el = document.getElementById(id); if(el) portal(el); });
      // Close when clicking outside content
      document.addEventListener('click', (e)=>{
        const overlay = e.target.closest('.modal-overlay.active');
        if(overlay && !e.target.closest('.modal-content')){
          overlay.classList.remove('active'); refreshBodyState();
        }
      });
    })();

    // Survey Status Management
    let selectedStatus = null;
    let selectedCloseChannels = [];
    
    window.selectSurveyStatus = function(status) {
      selectedStatus = status;
      // Update radio button
      const radios = document.querySelectorAll('input[name="surveyStatus"]');
      radios.forEach(radio => {
        radio.checked = radio.value === status;
      });
      
      // Show/hide close options
      const closeOptions = document.getElementById('closeOptions');
      if (closeOptions) {
        if (status === 'Close') {
          closeOptions.classList.remove('hidden');
        } else {
          closeOptions.classList.add('hidden');
          // Clear selected channels when not closing
          selectedCloseChannels = [];
          const checkboxes = document.querySelectorAll('input[name="closeChannel"]');
          checkboxes.forEach(cb => cb.checked = false);
        }
      }
    };
    
    window.applySurveyStatus = function() {
      if (selectedStatus) {
        try {
          // If closing, get selected channels
          if (selectedStatus === 'Close') {
            const checkboxes = document.querySelectorAll('input[name="closeChannel"]:checked');
            selectedCloseChannels = Array.from(checkboxes).map(cb => cb.value);
          }
          
          localStorage.setItem('webropol_survey_status', selectedStatus);
          
          // Store close channels if applicable
          if (selectedStatus === 'Close' && selectedCloseChannels.length > 0) {
            localStorage.setItem('webropol_survey_close_channels', JSON.stringify(selectedCloseChannels));
          }
          
          // Trigger Alpine.js update if available
          if (window.Alpine) {
            window.dispatchEvent(new CustomEvent('survey-status-changed', { 
              detail: { 
                status: selectedStatus,
                closeChannels: selectedCloseChannels
              } 
            }));
          }
          window.closeSurveyStatusModal();
        } catch (e) {
          console.error('Error saving survey status:', e);
        }
      }
    };
  </script>

  <!-- Question Mode Modal -->
  <div id="questionModeModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 660px;">
      <div class="modal-header question-mode-header">
        <div class="modal-title-section question-mode-title">
          <div class="question-mode-icon-badge">
            <i class="fal fa-plus-circle"></i>
          </div>
          <div class="question-mode-text">
            <h2 class="modal-title">Question Mode</h2>
            <p class="modal-subtitle">Choose where to insert the new question (this will be applied to the copy function only)</p>
          </div>
        </div>
        <button class="modal-close" onclick="closeQuestionModeModal()" aria-label="Close modal">
          <i class="fal fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h3 class="section-title">
            <i class="fal fa-location-arrow"></i>
            Insertion Point
          </h3>
          <div class="form-group">
            <!-- Page-level options -->
            <div style="margin-bottom: 1.25rem;">
              <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.06em; font-weight: 600; color: #94a3b8; margin-bottom: 0.5rem;">
                Page position
              </div>
              <div class="radio-group" style="flex-direction: column; gap: 0.75rem;">
                <label class="radio-item" style="cursor: pointer; transition: all 0.2s ease;" onclick="setQuestionInsertionPoint('top')">
                  <input
                    type="radio"
                    name="insertionPoint"
                    value="top"
                    class="radio-input"
                    id="insertTop"
                  >
                  <div class="radio-content" style="flex: 1;">
                    <div class="radio-title" style="font-size: 0.95rem; margin-bottom: 0.2rem;">
                      <i class="fal fa-arrow-up mr-2 text-webropol-primary-600"></i>
                      Insert at top of page
                    </div>
                  </div>
                </label>
                <label class="radio-item" style="cursor: pointer; transition: all 0.2s ease;" onclick="setQuestionInsertionPoint('bottom')">
                  <input
                    type="radio"
                    name="insertionPoint"
                    value="bottom"
                    class="radio-input"
                    id="insertBottom"
                    checked
                  >
                  <div class="radio-content" style="flex: 1;">
                    <div class="radio-title" style="font-size: 0.95rem; margin-bottom: 0.2rem;">
                      <i class="fal fa-arrow-down mr-2 text-webropol-primary-600"></i>
                      Insert at bottom of page (default)
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <!-- Question-level options -->
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.06em; font-weight: 600; color: #94a3b8; margin-bottom: 0.5rem;">
                Relative to selected question
              </div>
              <div class="radio-group" style="flex-direction: column; gap: 0.75rem;">
                <label class="radio-item" style="cursor: pointer; transition: all 0.2s ease;" onclick="setQuestionInsertionPoint('above')">
                  <input
                    type="radio"
                    name="insertionPoint"
                    value="above"
                    class="radio-input"
                    id="insertAbove"
                  >
                  <div class="radio-content" style="flex: 1;">
                    <div class="radio-title" style="font-size: 0.95rem; margin-bottom: 0.2rem;">
                      <i class="fal fa-level-up-alt mr-2 text-webropol-primary-600"></i>
                      Insert above current question
                    </div>
                  </div>
                </label>
                <label class="radio-item" style="cursor: pointer; transition: all 0.2s ease;" onclick="setQuestionInsertionPoint('after')">
                  <input
                    type="radio"
                    name="insertionPoint"
                    value="after"
                    class="radio-input"
                    id="insertAfter"
                  >
                  <div class="radio-content" style="flex: 1;">
                    <div class="radio-title" style="font-size: 0.95rem; margin-bottom: 0.2rem;">
                      <i class="fal fa-level-down-alt mr-2 text-webropol-primary-600"></i>
                      Insert after current question
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex items-center justify-between w-full">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="rememberInsertionChoice" class="w-4 h-4 text-webropol-primary-600 border-webropol-gray-300 rounded focus:ring-webropol-primary-500">
            <span class="text-sm text-webropol-gray-700">Remember my choice</span>
          </label>
          <div class="footer-actions">
            <button class="btn btn-secondary" onclick="closeQuestionModeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmQuestionMode()">
              <i class="fal fa-check"></i>
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Copy Question Modal removed: Copy now duplicates immediately on click -->

  <style>
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      /* Use CSS variable with fallback so we can centrally tune layering. */
      z-index: var(--webropol-page-modal-z, 16000) !important;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      padding: 1rem;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Force all modal overlays to appear above everything */
    #uploadModal.modal-overlay,
    #questionSettingsModal.modal-overlay,
    #colorPickerModal.modal-overlay,
    #questionModeModal.modal-overlay,
    #surveyStatusModal.modal-overlay {
      z-index: 99999 !important;
    }

    /* Ensure header stays behind modals when they're active */
    /* Primary (modern) :has selector */
    body:has(.modal-overlay.active) webropol-header { z-index: 10 !important; }
    /* Fallback when JS toggles .modal-open on body */
    body.modal-open webropol-header { z-index: 10 !important; }

    /* Ensure Upload modal can appear above Question Settings modal */
    #uploadModal {
      z-index: 99999 !important;
    }

    #uploadModal.above-settings {
      z-index: 100000 !important;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Ensure Upload modal can appear above Question Settings modal */
    #uploadModal {
      z-index: 9999;
    }

    #uploadModal.above-settings {
      z-index: 10000;
    }

    /* Button Styles from auto-suggest.html */
    .btn {
      padding: 0.625rem 1.5rem;
      border: 1px solid transparent; /* keep outlined variants working */
      border-radius: 9999px !important;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .btn.w-full {
      width: 100%;
      justify-content: center;
    }

  .btn-primary {
      background: #0891b2;
      color: white;
    }

    .btn-primary:hover {
      background: #0e7490;
      transform: translateY(-1px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

  /* .btn-secondary styles now come from design-system/button-classes.css */

  .btn:disabled,
  .btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-primary:disabled,
    .btn-primary[disabled] {
      background: #d1d5db;
      color: #6b7280;
    }

  /* .btn-secondary disabled handled by design-system */

    /* Match Apply button's disabled style for specific modal actions */
    #uploadBtn:disabled,
    #removeStoredBtn:disabled {
      background: #d1d5db !important; /* same as .btn-primary:disabled */
      color: #6b7280 !important;
      border-color: #d1d5db !important;
    }

    .delete-btn:hover i {
      color: #dc2626 !important;
    }

    .btn i {
      font-size: 1.125rem;
    }

    .btn i.fal {
      color: #0891b2;
    }

    .modal-content {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      transform: scale(0.9) translateY(20px);
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      padding: 1.25rem 1.5rem;
      background: #ffffff;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .modal-title-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0.25rem;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #334155;
      margin: 0;
    }

    .modal-subtitle {
      font-size: 0.875rem;
      color: #64748b;
    }

    /* Question Mode header overrides */
    .question-mode-header {
      align-items: center;
    }

    .question-mode-title {
      flex-direction: row;
      align-items: center;
      gap: 0.75rem;
    }

    .question-mode-icon-badge {
      width: 40px;
      height: 40px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #d97706;
      box-shadow: 0 2px 6px rgba(217, 119, 6, 0.12);
      font-size: 18px;
      flex-shrink: 0;
    }

    .question-mode-text {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.15rem;
    }

    .modal-close {
      width: 2.5rem;
      height: 2.5rem;
      border: none;
      background: #f1f5f9;
      border-radius: 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      transition: all 0.15s ease;
    }

    .modal-close:hover {
      background: #e2e8f0;
      color: #334155;
    }

    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .settings-section {
      margin-bottom: 2rem;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Step badge to emphasize sequential steps in modal */
    .step-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      gap: 0.375rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      line-height: 1rem;
      font-weight: 700;
      letter-spacing: 0.02em;
  background: #fff7ed; /* orange-50 */
  color: #c2410c; /* orange-700 */
  border: 1px solid #fed7aa; /* orange-200 */
    }

    /* Accessible tooltip component */
    .tooltip-container {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tooltip-trigger {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      transition: all 0.15s ease;
    }

    /* Import Auto Suggestions help icon: remove border/hover effects, show help cursor */
    .tooltip-trigger.tooltip-help {
      border: none;
      background: transparent;
      box-shadow: none;
      cursor: help;
      color: #374151; /* keep default icon color */
    }
    .tooltip-trigger.tooltip-help:hover,
    .tooltip-trigger.tooltip-help:focus-visible {
      background: transparent;
      border-color: transparent;
      color: #374151;
      outline: none;
      box-shadow: none;
    }
    .tooltip-trigger.tooltip-help i {
      font-size: 18px; /* make the question mark icon slightly bigger */
    }

    .tooltip-trigger:hover,
    .tooltip-trigger:focus-visible {
      background: #f3f4f6;
      border-color: #fed7aa;
      color: #ea580c;
      outline: none;
      box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.2);
    }

    .tooltip-panel {
      position: absolute;
      z-index: 10001;
      max-width: 320px;
      width: max-content;
      background: #111827;
      color: #f9fafb;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
      line-height: 1.25rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.2);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 120ms ease, transform 120ms ease, visibility 120ms ease;
    }

    .tooltip-container:hover .tooltip-panel,
    .tooltip-container:focus-within .tooltip-panel {
      opacity: 1;
      visibility: visible;
    }

    .tooltip-panel[data-placement="top"] {
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%) translateY(4px);
    }
    .tooltip-container:hover .tooltip-panel[data-placement="top"],
    .tooltip-container:focus-within .tooltip-panel[data-placement="top"] {
      transform: translateX(-50%) translateY(0);
    }
    .tooltip-panel[data-placement="top"]::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -6px;
      border-width: 6px 6px 0 6px;
      border-style: solid;
      border-color: #111827 transparent transparent transparent;
    }

    .tooltip-panel[data-placement="bottom"] {
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%) translateY(-4px);
    }
    .tooltip-container:hover .tooltip-panel[data-placement="bottom"],
    .tooltip-container:focus-within .tooltip-panel[data-placement="bottom"] {
      transform: translateX(-50%) translateY(0);
    }
    .tooltip-panel[data-placement="bottom"]::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: -6px;
      border-width: 0 6px 6px 6px;
      border-style: solid;
      border-color: transparent transparent #111827 transparent;
    }

    @media (max-width: 640px) {
      .tooltip-panel[data-placement="top"] {
        top: calc(100% + 8px);
        bottom: auto;
        transform: translateX(-50%) translateY(-4px);
      }
      .tooltip-container:hover .tooltip-panel[data-placement="top"],
      .tooltip-container:focus-within .tooltip-panel[data-placement="top"] {
        transform: translateX(-50%) translateY(0);
      }
      .tooltip-panel[data-placement="top"]::after {
        top: -6px;
        bottom: auto;
        border-width: 0 6px 6px 6px;
        border-color: transparent transparent #111827 transparent;
      }
    }

    .file-upload-section {
      background: #f8fafc;
      border: 2px dashed #cbd5e1;
      border-radius: 0.5rem;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .file-upload-icon {
      width: 3rem;
      height: 3rem;
      background: #ccf7fe;
      color: #06b6d4;
      border-radius: 0.5rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      font-size: 1.25rem;
    }

    .modal-footer {
      padding: 1.5rem;
      background: #ffffff;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .footer-actions {
      display: flex;
      gap: 0.75rem;
      margin-left: auto;
    }

    .btn {
      padding: 0.625rem 1.5rem;
      border: 1px solid transparent; /* keep outlined variants working */
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

  /* .btn-secondary styles now come from design-system/button-classes.css */

    .btn-primary {
      background: linear-gradient(to right, #0891b2, #0e7490);
      color: white;
      border: none;
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(to right, #0e7490, #164e63);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
    }

  /* Ensure icons inside primary buttons are visible (white) */
  .btn-primary i { color: #ffffff !important; }

    /* Utility classes */
    .w-10 { width: 2.5rem; }
    .h-10 { height: 2.5rem; }
    .from-orange-100 { --tw-gradient-from: #fed7aa; }
    .to-orange-100 { --tw-gradient-to: #fed7aa; }
    .rounded-full { border-radius: 9999px; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .text-orange-600 { color: #ea580c; }
    .text-lg { font-size: 1.125rem; }
    .hidden { display: none !important; }
    .mt-3 { margin-top: 0.75rem; }

    /* Question Settings Modal Additional Styles */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .radio-group.orientation-row {
      gap: 1.75rem;
    }

    .radio-item.has-input .radio-content {
      flex: 0 1 auto;
      margin-right: 0.5rem;
    }

    .radio-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
    }

    .radio-group .radio-item.has-input {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .radio-input {
      width: 1.25rem;
      height: 1.25rem;
      accent-color: #0891b2;
    }

    .radio-content {
      flex: 1;
    }

    .radio-title {
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .custom-input-row {
      margin-top: 0.4rem;
      gap: 0.4rem;
    }

    .form-input {
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: all 0.15s ease;
      background: white;
    }

    .form-input:focus {
      outline: none;
      border-color: #0891b2;
      box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
    }

    .form-select {
      padding: 0.75rem 1rem;
      padding-right: 2.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      background: white;
      cursor: pointer;
      min-width: 150px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 512'%3E%3Cpath fill='%23333' d='M31 192h258c28.4 0 42.8 34.5 22.6 54.6l-129 129c-12.5 12.5-32.8 12.5-45.3 0l-129-129C-11.8 226.5 4.6 192 31 192z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px 12px;
    }

    .form-select:focus {
      outline: none;
      border-color: #0891b2;
      box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
    }

    .form-helper {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      transition: all 0.15s ease;
    }

    .checkbox-input {
      width: 1.25rem;
      height: 1.25rem;
      accent-color: #0891b2;
      margin-top: 0.125rem;
    }

    .checkbox-content {
      flex: 1;
    }

    .checkbox-title {
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .placement-options {
      margin-left: 1.75rem;
      margin-top: 0.75rem;
    }

    .placement-radio {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .placement-radio .radio-item {
      margin: 0;
    }

    .file-upload-section-button {
      text-align: center;
      margin-bottom: 1rem;
    }

    .file-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin-top: 1rem;
    }

    .file-actions > * {
      display: inline-flex;
      align-items: center;
    }

    .upload-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #ffffff;
      color: #111827;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
      margin: 0;
    }

    .visibility-section {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
    }

    .settings-section.visibility-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .settings-section.visibility-row .section-title {
      margin-bottom: 0;
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .settings-section.visibility-row .visibility-options {
      display: flex;
      gap: 1.25rem;
      align-items: center;
      justify-content: flex-start;
      flex: 1 1 auto;
    }

    .visibility-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .visibility-icon {
      width: 1.5rem;
      height: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }

    .visibility-visible .visibility-icon {
      background: #dcfce7;
      color: #16a34a;
    }

    .visibility-hidden .visibility-icon {
      background: #fef3c7;
      color: #d97706;
    }

    .visibility-disabled .visibility-icon {
      background: #e5e7eb;
      color: #6b7280;
    }

    .keywords-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .keywords-label {
      font-size: 0.875rem;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .keywords-count {
      background: #e5e7eb;
      color: #374151;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .keywords-input {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #ffffff;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }

    .keywords-input input[type="text"] {
      border: none;
      outline: none;
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      background: transparent;
      min-width: 160px;
    }

    .keywords-chips {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Add Question Modal Styles */
    .question-category {
      margin-bottom: 2rem;
    }

    .question-category:last-child {
      margin-bottom: 0;
    }

    .category-title {
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 1rem;
      text-transform: none;
    }

    .question-types-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .question-type-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      background: #ffffff;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      width: 100%;
      min-height: 60px;
    }

    .question-type-item:hover {
      border-color: #0891b2;
      background: #f0fdff;
      box-shadow: 0 2px 8px rgba(8, 145, 178, 0.1);
    }

    .question-type-item:focus {
      outline: none;
      border-color: #0891b2;
      box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
    }

    .question-type-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      flex-shrink: 0;
    }

    .question-type-content {
      flex: 1;
      display: flex;
      align-items: center;
    }

    .question-type-name {
      font-weight: 500;
      color: #1f2937;
      font-size: 0.9375rem;
    }

    .question-type-info {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 50%;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
      flex-shrink: 0;
      font-size: 0.75rem;
      margin-left: auto;
    }

    .question-type-info:hover {
      border-color: #0891b2;
      color: #0891b2;
      background: #f0fdff;
    }

    .question-type-info:focus {
      outline: none;
      border-color: #0891b2;
      box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.2);
    }

    /* Search input styling */
    #questionTypeSearch::placeholder {
      color: #9ca3af;
    }

    /* Hide categories and questions during search */
    .question-category.hidden {
      display: none;
    }

    .question-type-item.hidden {
      display: none;
    }

    /* Redesigned Add Question Modal */
    .add-question-modal-redesign {
      max-width: 1000px;
      border-radius: 20px;
      overflow: hidden;
    }

    .add-question-modal-header {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-bottom: 1px solid #e2e8f0;
      padding: 1.25rem 1.75rem;
    }

    .add-question-header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      flex-wrap: nowrap;
    }

    .modal-title-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-shrink: 0;
    }

    .add-question-icon-badge {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #d97706;
      box-shadow: 0 2px 6px rgba(217, 119, 6, 0.12);
    }

    .modal-title {
      font-size: 1.375rem;
      font-weight: 600;
      color: #0f172a;
      margin: 0;
      letter-spacing: -0.01em;
    }

    .modal-title i {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 11px;
      font-size: 18px;
      color: #d97706;
      box-shadow: 0 2px 6px rgba(217, 119, 6, 0.12);
      margin-right: 0.75rem;
    }

    .header-right-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-shrink: 0;
    }

    .add-question-search-wrapper {
      position: relative;
      width: 320px;
    }

    .add-question-search-input {
      width: 100%;
      padding: 0.625rem 2.5rem 0.625rem 2.5rem;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.875rem;
      color: #1e293b;
      background: #ffffff;
      transition: all 0.2s ease;
    }

    .add-question-search-input:focus {
      outline: none;
      border-color: #06b6d4;
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.08);
    }

    .add-question-search-input::placeholder {
      color: #94a3b8;
    }

    .search-icon {
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      font-size: 0.9375rem;
      pointer-events: none;
    }

    .search-clear-btn {
      position: absolute;
      right: 0.625rem;
      top: 50%;
      transform: translateY(-50%);
      width: 26px;
      height: 26px;
      border-radius: 7px;
      background: transparent;
      border: none;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }

    .search-clear-btn:hover {
      background: #f1f5f9;
      color: #334155;
    }

    .modal-close-btn {
      width: 36px;
      height: 36px;
      border-radius: 9px;
      background: transparent;
      border: 1.5px solid #e2e8f0;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .modal-close-btn:hover {
      background: #fef2f2;
      border-color: #fca5a5;
      color: #dc2626;
    }

    .add-question-modal-body {
      padding: 1.75rem;
      max-height: calc(80vh - 180px);
      overflow-y: auto;
      background: #fafbfc;
    }

    .add-question-modal-body::-webkit-scrollbar {
      width: 10px;
    }

    .add-question-modal-body::-webkit-scrollbar-track {
      background: transparent;
    }

    .add-question-modal-body::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 5px;
      border: 2px solid #fafbfc;
    }

    .add-question-modal-body::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .redesigned-question-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 2rem;
    }

    .question-category-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .category-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      padding-bottom: 0.375rem;
      border-bottom: 1.5px solid #e2e8f0;
    }

    .category-title-text {
      font-size: 0.8125rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0;
    }

    .question-cards-grid {
      display: grid;
      gap: 0.5rem;
    }

    .add-question-type-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: #ffffff;
      border: 1.5px solid #e2e8f0;
      border-radius: 12px;
      padding: 0.875rem 1rem;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: left;
      width: 100%;
    }

    .add-question-type-card:hover {
      background: linear-gradient(135deg, #f0fdff 0%, #ffffff 100%);
      border-color: #06b6d4;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px -4px rgba(6, 182, 212, 0.18), 0 2px 6px rgba(6, 182, 212, 0.08);
    }

    .add-question-type-card:active {
      transform: translateY(0);
    }

    .add-question-type-card:focus-visible {
      outline: 2px solid rgba(6, 182, 212, 0.4);
      outline-offset: 2px;
    }

    .add-question-type-card-icon {
      width: 36px;
      height: 36px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
    }

    .add-question-type-card:hover .add-question-type-card-icon {
      transform: scale(1.03);
    }

    .text-category-icon {
      background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
      color: #ea580c;
    }

    .selection-category-icon {
      background: linear-gradient(135deg, #eff6ff 0%, #bfdbfe 100%);
      color: #1d4ed8;
    }

    .matrix-category-icon {
      background: linear-gradient(135deg, #ecfdf5 0%, #a7f3d0 100%);
      color: #047857;
    }

    .experience-category-icon {
      background: linear-gradient(135deg, #f5f3ff 0%, #ddd6fe 100%);
      color: #7c3aed;
    }

    .other-category-icon {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #475569;
    }

    .add-question-type-card-label {
      font-size: 0.8125rem;
      font-weight: 500;
      color: #1e293b;
      line-height: 1.3;
    }

    .no-results-state {
      text-align: center;
      padding: 3.5rem 2rem;
    }

    .no-results-icon {
      width: 56px;
      height: 56px;
      margin: 0 auto 1rem;
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #94a3b8;
    }

    .no-results-title {
      font-size: 1rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: 0.375rem;
    }

    .no-results-subtitle {
      font-size: 0.875rem;
      color: #64748b;
    }

    .add-question-modal-footer {
      padding: 1rem 1.75rem;
      border-top: 1px solid #e2e8f0;
      background: #ffffff;
      display: flex;
      justify-content: flex-end;
    }

    .close-modal-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1.25rem;
      background: transparent;
      border: 1.5px solid #e2e8f0;
      border-radius: 9px;
      color: #475569;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .close-modal-btn:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
      color: #1e293b;
    }

    .close-modal-btn i {
      font-size: 0.9375rem;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .redesigned-question-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.75rem;
      }
    }

    @media (max-width: 768px) {
      .add-question-modal-redesign {
        max-width: calc(100% - 2rem);
        margin: 1rem;
      }

      .add-question-search-wrapper {
        width: 240px;
      }

      .modal-title {
        font-size: 1.125rem;
      }

      .modal-title i {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }

      .add-question-modal-body {
        padding: 1.25rem;
        max-height: calc(80vh - 200px);
      }

      .redesigned-question-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .add-question-type-card {
        padding: 0.75rem 0.875rem;
      }

      .add-question-type-card-icon {
        width: 34px;
        height: 34px;
        font-size: 0.9375rem;
      }
    }

    @media (max-width: 480px) {
      .add-question-header-content {
        flex-wrap: wrap;
      }

      .modal-title-section {
        flex: 1;
        min-width: 0;
      }

      .header-right-section {
        flex: 1 1 100%;
        order: 3;
      }

      .add-question-search-wrapper {
        width: 100%;
      }

      .modal-title i {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      .modal-title {
        font-size: 1rem;
      }

      .add-question-modal-body {
        padding: 1rem;
      }

      .add-question-type-card-label {
        font-size: 0.75rem;
      }
    }

    /* Legacy styles cleanup */
    .add-question-modal-header { padding-bottom: .25rem; }
    .add-question-search input { background: #fff; }
    .question-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(230px,1fr));
      gap: 2.25rem 2rem; /* row gap larger to separate category blocks */
      align-items: start;
    }
    
    /* Legacy question types grid - kept for backward compatibility */
    .question-types-grid .question-category { margin:0; display:flex; flex-direction:column; gap:.75rem; }
    .question-types-grid .category-title { font-size:.85rem; letter-spacing:.02em; text-transform:none; font-weight:600; padding-left:.25rem; color:#0f172a; display:flex; align-items:center; gap:.4rem; }
    .question-types-grid .category-title:before { content:""; width:6px; height:6px; border-radius:50%; background:linear-gradient(to bottom right,#06b6d4,#0e7490); box-shadow:0 0 0 3px #f0fdff; }
    .question-types-grid .question-types-list { gap:.4rem; }

    .question-type-item { position:relative; border-radius:14px; border:1px solid #e2e8f0; padding:.75rem .75rem .75rem .75rem; min-height:64px; background:linear-gradient(#ffffff,#ffffff); box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .question-type-item:hover { background:linear-gradient(#f8feff,#f0fdff); border-color:#0ea5e9; box-shadow:0 4px 14px -4px rgba(14,165,233,.35),0 2px 4px rgba(14,165,233,.15); transform:translateY(-2px); }
    .question-type-item:active { transform:translateY(0); }
    .question-type-item:focus-visible { outline:3px solid rgba(6,182,212,.4); outline-offset:2px; }
    .question-type-item .question-type-icon { width:44px; height:44px; font-size:18px; border-radius:12px; box-shadow:inset 0 0 0 1px rgba(0,0,0,.04); }
    .question-type-item .question-type-name { font-size:.8rem; font-weight:600; color:#0f172a; line-height:1.2; }
    .question-type-item .question-type-info { position:absolute; top:6px; right:6px; width:22px; height:22px; border-radius:8px; border:1px solid #dbe3ea; font-size:11px; background:#fff; display:flex; align-items:center; justify-content:center; transition:.18s; }
    .question-type-item .question-type-info:hover { background:#f0fdff; border-color:#0ea5e9; color:#0e7490; }
    .question-type-item .question-type-info:focus-visible { outline:2px solid #06b6d4; outline-offset:2px; }
    .question-type-content { align-items:flex-start; }
    .question-type-content span { display:block; }
    /* Category color grouping indicators (optional subtle background) */
    .question-category[data-category="text"]   .question-type-icon { background:#fff7ed; color:#ea580c; }
    .question-category[data-category="selection"] .question-type-icon { background:#eff6ff; color:#0d74d4; }
    .question-category[data-category="matrix"] .question-type-icon { background:#ecfdf5; color:#059669; }
    .question-category[data-category="experience"] .question-type-icon { background:#f5f3ff; color:#7c3aed; }
    .question-category[data-category="other"] .question-type-icon { background:#f1f5f9; color:#334155; }



    @media (max-width: 900px){
      .question-types-grid { grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap:1.5rem 1rem; }
      .question-type-item { min-height:60px; }
      .question-type-item .question-type-icon { width:40px; height:40px; }
    }

    @media (max-width:640px){
      .add-question-modal-header { flex-direction:column; align-items:flex-start; }
      .add-question-search { width:100%; max-width:none; }
      .question-types-grid { grid-template-columns: repeat(auto-fill,minmax(150px,1fr)); }
    }



    /* Responsive adjustments */
    @media (max-width: 768px) {
      .question-type-item {
        padding: 0.75rem;
        min-height: 56px;
      }

      .question-type-icon {
        width: 2.25rem;
        height: 2.25rem;
        font-size: 1rem;
      }
    }

    .keyword-chip {
      background: #f3f4f6;
      color: #1f2937;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
    }

    .info-tooltip {
      position: relative;
      cursor: help;
    }

    .info-tooltip i {
      color: #1e293b;
      margin-left: 0.5rem;
      font-size: 1.125rem;
      line-height: 1;
      vertical-align: middle;
    }

    .ml-1 { margin-left: 0.25rem; }
    .ml-2 { margin-left: 0.5rem; }
    .ml-3 { margin-left: 0.75rem; }
    .ml-4 { margin-left: 1rem; }
    .ml-8 { margin-left: 2rem; }

    @media (max-width: 768px) {
      .modal-content {
        margin: 1rem;
        max-height: calc(100vh - 2rem);
      }

      .modal-subtitle {
        margin-left: 0;
      }

      .footer-actions {
        flex-direction: column;
        width: 100%;
      }

      .btn {
        justify-content: center;
      }
    }
  </style>
  <style>
    /* NPS appearance selection */
    .nps-appearance-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.75rem;margin-top:.5rem}
    .nps-appearance-card{position:relative;display:flex;flex-direction:column;align-items:center;gap:.6rem;padding:.85rem .9rem;border:2px solid #e2e8f0;background:#fff;border-radius:1rem;cursor:pointer;transition:.18s background,.18s border-color,.18s box-shadow;font-size:.75rem;line-height:1.1}
    .nps-appearance-card:hover{border-color:#cbd5e1;background:#f8fafc}
    .nps-appearance-card.active{border-color:#06b6d4;background:#f0fdff;box-shadow:0 4px 16px -4px rgba(6,182,212,.25)}
    .nps-appearance-preview{width:100%;min-height:42px;display:flex;align-items:center;justify-content:center}
    .nps-mini-pill{display:inline-flex;align-items:center;justify-content:center;padding:2px 6px;font-size:10px;font-weight:600;border-radius:.5rem;background:#fff;border:1px solid #cbd5e1;color:#334155;min-width:22px}
    .nps-smiley{font-size:2.1rem;line-height:1;background:transparent;transition:transform .15s,border-color .15s,background-color .15s;cursor:pointer;border:2px solid transparent;border-radius:1rem;padding:.25rem .45rem}
    .nps-smiley[aria-pressed="true"],.nps-smiley:hover{transform:scale(1.1);background:#f0fdff;border-color:#06b6d4}
  </style>

  <script>
    // Alpine.js store for managing question editor state
    document.addEventListener('alpine:init', () => {
      Alpine.store('questionEditor', {
        activeQuestion: null,
        
        setActive(questionId) {
          this.activeQuestion = questionId;
          window.dispatchEvent(new CustomEvent('question-close'));
        }
      });
    });
    
    // Survey Status Badge Data
    function surveyStatusData() {
      return {
        surveyStatus: (function(){ 
          try { 
            return localStorage.getItem('webropol_survey_status') || 'Open'; 
          } catch(e) { 
            return 'Open'; 
          } 
        })(),
        
        init() {
          // Listen for status changes
          window.addEventListener('survey-status-changed', (e) => {
            this.surveyStatus = e.detail.status;
          });
          
          // Listen for content selector events
          document.addEventListener('content-type-selected', (e) => {
            console.log('Content type selected:', e.detail);
            this.handleContentSelection(e.detail);
          });
        },
        
        handleContentSelection(detail) {
          const { type, category } = detail;
          
          if (category === 'main-action') {
            switch(type) {
              case 'add-question':
                console.log('Opening add question modal...');
                // Trigger existing add question modal if available
                const addQuestionBtn = document.querySelector('[data-action="add-question"]');
                if (addQuestionBtn) {
                  addQuestionBtn.click();
                }
                break;
              case 'import-library':
                console.log('Opening library import...');
                // Add library import functionality
                alert('Import from Library feature coming soon!');
                break;
              case 'free-text-media':
                console.log('Opening free text & media editor...');
                // Add free text/media functionality
                alert('Free Text & Media feature coming soon!');
                break;
            }
          } else if (category === 'question-type') {
            console.log(`Adding ${type} question...`);
            // Add specific question type
            alert(`Adding ${type} question - Feature in development`);
          }
        },
        
        openStatusModal() {
          console.log('Opening status modal, current status:', this.surveyStatus);
          // Pre-select current status in modal
          const radios = document.querySelectorAll('input[name="surveyStatus"]');
          radios.forEach(radio => {
            radio.checked = radio.value === this.surveyStatus;
          });
          window.selectedStatus = this.surveyStatus;
          window.openSurveyStatusModal();
        },
        
        getStatusClasses() {
          const baseClasses = 'bg-gradient-to-r';
          switch(this.surveyStatus) {
            case 'Open':
              return baseClasses + ' from-green-50 to-emerald-50 border-green-200';
            case 'Draft':
              return baseClasses + ' from-orange-50 to-amber-50 border-orange-200';
            case 'Close':
              return baseClasses + ' from-gray-50 to-slate-50 border-gray-200';
            default:
              return baseClasses + ' from-webropol-primary-50 to-white border-webropol-primary-200';
          }
        },
        
        getIconClasses() {
          switch(this.surveyStatus) {
            case 'Open':
              return 'bg-green-100 text-green-700';
            case 'Draft':
              return 'bg-orange-100 text-orange-700';
            case 'Close':
              return 'bg-gray-100 text-gray-700';
            default:
              return 'bg-webropol-primary-100 text-webropol-primary-700';
          }
        },
        
        getStatusTextClasses() {
          switch(this.surveyStatus) {
            case 'Open':
              return 'text-green-600';
            case 'Draft':
              return 'text-orange-600';
            case 'Close':
              return 'text-gray-600';
            default:
              return 'text-webropol-primary-600';
          }
        }
      };
    }
    
    function surveyEditApp() {
      return {
        // Survey editor specific logic here
        autoSave: true,
        showMandatoryInfo: false,
        
        // Check if any questions are marked as mandatory
        hasMandatoryQuestions() {
          return this.showMandatoryInfo;
        },
        
        // Update mandatory info visibility
        updateMandatoryInfo() {
          const questionCards = document.querySelectorAll('[x-data*="isMandatory"]');
          let hasMandatory = false;
          for (let card of questionCards) {
            try {
              const alpineData = Alpine.$data(card);
              if (alpineData && alpineData.isMandatory) {
                hasMandatory = true;
                break;
              }
            } catch (e) {
              // Skip if Alpine data not available yet
            }
          }
          this.showMandatoryInfo = hasMandatory;
        },
        
        init() {
          console.log('Survey Editor initialized');
          
          // Auto-save functionality
          if (this.autoSave) {
            setInterval(() => {
              this.performAutoSave();
            }, 30000); // Auto-save every 30 seconds
          }
          
          // Add Question Modal event listeners - use nextTick to ensure DOM is ready
          this.$nextTick(() => {
            setTimeout(() => {
              const addQuestionModal = document.getElementById('addQuestionModal');
              const addQuestionBtns = document.querySelectorAll('.add-question-trigger');
              
              console.log('Modal element:', addQuestionModal);
              console.log('Add Question buttons found:', addQuestionBtns.length);
              
              if (addQuestionModal) {
                // Bind all Add Question buttons to open the modal
                addQuestionBtns.forEach(btn => {
                  btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Add Question button clicked');
                    addQuestionModal.open();
                  });
                });
                
                // Handle question selection
                addQuestionModal.addEventListener('question-added', (e) => {
                  console.log('Question added event:', e.detail);
                  this.addQuestion(e.detail.type);
                });
              } else {
                console.error('Add Question Modal not found');
              }
            }, 200);
          });
          
          // Set up interval to check for mandatory questions
          setInterval(() => {
            this.updateMandatoryInfo();
          }, 500);
        },
        
        performAutoSave() {
          console.log('Auto-saving survey...');
          // Implementation for auto-saving
        },
        
        addQuestion(type) {
          console.log('Adding question of type:', type);
          // Implementation for adding questions
        },
        
        deleteQuestion(id) {
          console.log('Deleting question:', id);
          // Implementation for deleting questions
        },
        
        previewSurvey() {
          console.log('Previewing survey...');
          // Implementation for previewing survey
        },
        
        saveSurvey() {
          console.log('Saving survey...');
          // Implementation for saving survey
        },
        
        handleMergePage(event) {
          const { pageNumber, targetPage } = event.detail;
          console.log(`Merging page ${pageNumber} into page ${targetPage}...`);
          
          // Show confirmation dialog
          if (confirm(`Are you sure you want to merge Page ${pageNumber} into Page ${targetPage}?\n\nAll questions from Page ${pageNumber} will be moved to Page ${targetPage}, and Page ${pageNumber} will be removed.`)) {
            // Implementation for merging pages
            // 1. Get all questions from pageNumber
            // 2. Move them to targetPage
            // 3. Remove pageNumber section
            // 4. Renumber subsequent pages
            // 5. Update localStorage/backend
            
            console.log('Pages merged successfully');
            // Dispatch event to update the UI
            this.$dispatch('pages-merged', { from: pageNumber, to: targetPage });
          }
        }
      }
    }

    function surveyStructureApp() {
      return {
        activeTab: (function(){ try{ return localStorage.getItem('edit-left-activeTab') || 'pages'; }catch(e){ return 'pages'; } })(),
        selectedStyle: null,
        
        init() {
          console.log('Survey Structure initialized');
          // Persist tab changes
          this.$watch('activeTab', (v) => {
            try { localStorage.setItem('edit-left-activeTab', v); } catch(e) {}
          });
          
          // Set up event listeners for web components
          this.setupComponentListeners();
        },
        
        setupComponentListeners() {
          // Listen for page toggle events
          document.addEventListener('page-toggle', (e) => {
            console.log('Page toggled:', e.detail);
          });
          
          // Listen for page selection events
          document.addEventListener('page-select', (e) => {
            console.log('Page selected:', e.detail);
          });
          
          // Listen for question selection events
          document.addEventListener('question-select', (e) => {
            console.log('Question selected:', e.detail);
          });
          
          // Listen for question settings events
          document.addEventListener('question-settings', (e) => {
            this.openQuestionSettingsModal(e.detail.questionId);
          });
          
          // Listen for question delete events
          document.addEventListener('question-delete', (e) => {
            this.handleQuestionDelete(e.detail.questionId);
          });
        },
        
        handlePageToggle(event) {
          console.log('Page toggle handler:', event.detail);
        },
        
        handlePageSelect(event) {
          console.log('Page select handler:', event.detail);
        },
        
        openQuestionSettingsModal(questionId) {
          console.log('Opening settings for question:', questionId);
          // Trigger the AddQuestionModal with edit mode
          const modal = document.querySelector('webropol-add-question-modal');
          if (modal) {
            modal.setAttribute('mode', 'edit');
            modal.setAttribute('question-id', questionId);
            modal.setAttribute('open', 'true');
          }
        },
        
        handleQuestionDelete(questionId) {
          console.log('Delete question:', questionId);
          if (confirm('Are you sure you want to delete this question?')) {
            // Implement delete logic here
            console.log('Question deleted:', questionId);
          }
        },
        
        applySelectedStyle() {
          if (this.selectedStyle) {
            console.log('Applying style:', this.selectedStyle);
            // Implementation for applying selected style
            // You could emit an event or call a method to update the main canvas
            this.$dispatch('style-applied', { style: this.selectedStyle });
          } else {
            console.log('Applying current style changes');
            // Apply any current style changes
            this.$dispatch('styles-applied');
          }
        },
        
        resetStyles() {
          console.log('Resetting styles to default');
          this.selectedStyle = null;
          // Dispatch event so style panel instance can listen (optional)
          this.$dispatch('styles-reset');
          // If surveyStylesApp is mounted, invoke its internal reset
          if (window.__surveyStyles && typeof window.__surveyStyles.resetToDefaults === 'function') {
            window.__surveyStyles.resetToDefaults();
          }
        },
        
        previewStyle() {
          console.log('Previewing current style changes');
          // Implementation for previewing selected style
          this.$dispatch('style-preview', { style: this.selectedStyle });
        }
      }
    }
    
        function surveyStylesApp() {
          return {
      // Survey Pages (colour & transparency) - Load from localStorage or use defaults
      surveyColorMode: (function(){ try{ return localStorage.getItem('survey-colorMode') || 'color'; }catch(e){ return 'color'; } })(),
      surveyColor: (function(){ 
        try{ 
          const saved = localStorage.getItem('survey-color');
          return saved ? JSON.parse(saved) : { r: 255, g: 255, b: 255 };
        }catch(e){ 
          return { r: 255, g: 255, b: 255 }; 
        } 
      })(),
      surveyTransparency: (function(){ try{ return parseInt(localStorage.getItem('survey-transparency')) || 20; }catch(e){ return 20; } })(),
      surveyBlur: (function(){ try{ return localStorage.getItem('survey-blur') === 'true'; }catch(e){ return false; } })(),
        
        // Page Background - Load from localStorage or use defaults
        pageColor: (function(){ 
          try{ 
            const saved = localStorage.getItem('page-color');
            return saved ? JSON.parse(saved) : { r: 235, g: 244, b: 247 };
          }catch(e){ 
            return { r: 235, g: 244, b: 247 }; 
          } 
        })(),
        // Default: false (do not apply page background) unless explicitly enabled in localStorage
        usePageBackground: (function(){ try{ return localStorage.getItem('use-page-background') === 'true'; }catch(e){ return false; } })(),
        selectedImage: (function(){ try{ return localStorage.getItem('selected-image') || null; }catch(e){ return null; } })(),        // Background Image Properties - Load from localStorage or use defaults
        backgroundRepeat: (function(){ try{ return localStorage.getItem('background-repeat') || 'no-repeat'; }catch(e){ return 'no-repeat'; } })(),
        backgroundScale: (function(){ try{ return localStorage.getItem('background-scale') || 'fit-width'; }catch(e){ return 'fit-width'; } })(),
        imagePositionVertical: (function(){ try{ return localStorage.getItem('image-position-vertical') || 'center'; }catch(e){ return 'center'; } })(),
        imagePositionHorizontal: (function(){ try{ return localStorage.getItem('image-position-horizontal') || 'center'; }catch(e){ return 'center'; } })(),
        
        init() {
          console.log('Survey Styles initialized');
          // Expose instance for external helpers (color picker)
          try { window.__surveyStyles = this; } catch(e) {}
          
          // Set up watchers for automatic style application AND persistence
          this.$watch('surveyColorMode', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('survey-colorMode', v); } catch(e) {}
          });
          this.$watch('surveyTransparency', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('survey-transparency', v); } catch(e) {}
          });
          this.$watch('surveyBlur', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('survey-blur', v); } catch(e) {}
          });
          this.$watch('surveyColor', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('survey-color', JSON.stringify(v)); } catch(e) {}
          });
          this.$watch('pageColor', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('page-color', JSON.stringify(v)); } catch(e) {}
          });
          this.$watch('usePageBackground', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('use-page-background', v); } catch(e) {}
          });
          this.$watch('selectedImage', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('selected-image', v || ''); } catch(e) {}
          });
          this.$watch('backgroundRepeat', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('background-repeat', v); } catch(e) {}
          });
          this.$watch('backgroundScale', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('background-scale', v); } catch(e) {}
          });
          this.$watch('imagePositionVertical', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('image-position-vertical', v); } catch(e) {}
          });
          this.$watch('imagePositionHorizontal', (v) => { 
            this.applyStyles(); 
            try { localStorage.setItem('image-position-horizontal', v); } catch(e) {}
          });
          
          // Apply initial styles
          this.applyStyles();
        },
        
        openColorPicker(target) {
          console.log('Opening color picker for:', target);
          window.colorPickerTarget = target;
          const modal = document.getElementById('colorPickerModal');
          modal.classList.add('active');
          document.body.style.overflow = 'hidden';
          
          // Initialize color picker components
          setTimeout(() => {
            initColorPicker();
          }, 100);
        },
        
        openImageGallery() {
          console.log('Opening local device file picker');
          // Trigger the hidden file input
          const fileInput = document.querySelector('input[x-ref="imageInput"]');
          if (fileInput) {
            fileInput.click();
          }
        },
        
        handleImageUpload(event) {
          const fileInput = (event && event.target) ? event.target : this.$refs.imageInput;
          const file = fileInput.files[0];
          if (!file) return;
          
          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file');
            return;
          }
          
          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB');
            return;
          }
          
          // Create URL for preview
          const reader = new FileReader();
          reader.onload = (e) => {
            this.selectedImage = e.target.result;
            console.log('Image uploaded successfully');
            this.applyStyles();
          };
          reader.readAsDataURL(file);
        },
        
        removeSelectedImage() {
          this.selectedImage = null;
          // Clear the file input
          const fileInput = document.querySelector('input[x-ref="imageInput"]');
          if (fileInput) {
            fileInput.value = '';
          }
          // Clean up only survey background layer
          const pageBackground = document.getElementById('pageBackground');
          
          if (pageBackground) {
            pageBackground.style.backgroundImage = 'none';
            pageBackground.style.filter = 'none';
            pageBackground.style.transform = 'none';
            pageBackground.style.backgroundAttachment = 'initial';
          }
          
          this.applyStyles();
          console.log('Image removed');
        },
        
        setImagePosition(vertical, horizontal) {
          this.imagePositionVertical = vertical;
          this.imagePositionHorizontal = horizontal;
          console.log('Image position set to:', vertical, horizontal);
          this.applyStyles();
        },
        
        applyStyles() {
          // Apply the styles to the actual survey preview
          this.applySurveyStyles();
          this.applyPageStyles();
          this.applyBackgroundStyles();
        },
        
        applySurveyStyles() {
          // Apply to individual survey pages (white cards)
          const pages = document.querySelectorAll('section.relative.bg-white');
          pages.forEach(page => {
            if (this.surveyColorMode === 'color') {
              const alpha = (100 - this.surveyTransparency) / 100;
              page.style.backgroundColor = `rgba(${this.surveyColor.r}, ${this.surveyColor.g}, ${this.surveyColor.b}, ${alpha})`;
              // Apply blur if requested (only when color is used)
              page.style.backdropFilter = this.surveyBlur ? 'blur(10px)' : 'none';
              page.style.webkitBackdropFilter = this.surveyBlur ? 'blur(10px)' : 'none';
            } else {
              page.style.backgroundColor = 'transparent';
              page.style.backdropFilter = 'none';
              page.style.webkitBackdropFilter = 'none';
            }
            // Pages do not receive background image or blur from this section
            page.style.backgroundImage = 'none';
            page.style.filter = 'none';
          });
          
          // Apply same styling to thank you page
          const thankYouPage = document.querySelector('.bg-white\\/90.backdrop-blur-lg.rounded-3xl');
          if (thankYouPage) {
            if (this.surveyColorMode === 'color') {
              const alpha = (100 - this.surveyTransparency) / 100;
              thankYouPage.style.backgroundColor = `rgba(${this.surveyColor.r}, ${this.surveyColor.g}, ${this.surveyColor.b}, ${alpha})`;
              // Apply blur if requested (only when color is used)
              thankYouPage.style.backdropFilter = this.surveyBlur ? 'blur(10px)' : 'none';
              thankYouPage.style.webkitBackdropFilter = this.surveyBlur ? 'blur(10px)' : 'none';
            } else {
              thankYouPage.style.backgroundColor = 'rgba(255, 255, 255, 0.9)'; // Restore original bg-white/90
              thankYouPage.style.backdropFilter = 'blur(16px)'; // Restore original backdrop-blur-lg
              thankYouPage.style.webkitBackdropFilter = 'blur(16px)';
            }
            // Thank you page does not receive background image
            thankYouPage.style.backgroundImage = 'none';
            thankYouPage.style.filter = 'none';
          }
        },
        
        applyPageStyles() {
          // Apply to the page background layer (behind survey)
          const pageBackground = document.getElementById('pageBackground');
          
          if (!pageBackground) return;
          
          // Always apply background color independently of image
          pageBackground.style.backgroundColor = `rgb(${this.pageColor.r}, ${this.pageColor.g}, ${this.pageColor.b})`;
          
          // Apply survey background image if selected (background behind pages)
          if (this.usePageBackground && this.selectedImage) {
            pageBackground.style.backgroundImage = `url(${this.selectedImage})`;
            pageBackground.style.backgroundRepeat = this.backgroundRepeat;
            pageBackground.style.backgroundPosition = `${this.imagePositionHorizontal} ${this.imagePositionVertical}`;
            
            // Handle scale
            if (this.backgroundScale === 'fit-width') {
               pageBackground.style.backgroundSize = '100% auto';
               pageBackground.style.backgroundAttachment = 'scroll';
            } else if (this.backgroundScale === 'fixed') {
               pageBackground.style.backgroundSize = 'cover';
               pageBackground.style.backgroundAttachment = 'fixed';
            } else { // original
               pageBackground.style.backgroundSize = 'auto';
               pageBackground.style.backgroundAttachment = 'scroll';
            }
            
            pageBackground.style.filter = 'none';
            pageBackground.style.transform = 'none';
          } else {
            pageBackground.style.backgroundImage = 'none';
            pageBackground.style.filter = 'none';
            pageBackground.style.transform = 'none';
            pageBackground.style.backgroundAttachment = 'initial';
            // Ensure any background override from gradient is cleared
            pageBackground.style.backgroundSize = '';
            pageBackground.style.backgroundPosition = '';
          }
        },
        
        applyBackgroundStyles() {
          // This method can be used to apply additional background styling
          console.log('Applying background styles', {
            repeat: this.backgroundRepeat,
            scale: this.backgroundScale,
            position: `${this.imagePositionVertical} ${this.imagePositionHorizontal}`
          });
        },

        // Hard reset to original defaults and clear persistence
        resetToDefaults() {
          console.log('surveyStylesApp.resetToDefaults invoked');
          // Define defaults (single source of truth)
          const defaults = {
            surveyColorMode: 'color',
            surveyColor: { r: 255, g: 255, b: 255 },
            surveyTransparency: 20,
            surveyBlur: false,
            pageColor: { r: 235, g: 244, b: 247 },
            usePageBackground: true,
            selectedImage: null,
            backgroundRepeat: 'no-repeat',
            backgroundScale: 'fit-width',
            imagePositionVertical: 'center',
            imagePositionHorizontal: 'center'
          };

          // Assign Alpine reactive props
          this.surveyColorMode = defaults.surveyColorMode;
          this.surveyColor = defaults.surveyColor;
            try { localStorage.setItem('survey-color', JSON.stringify(this.surveyColor)); } catch(e) {}
          this.surveyTransparency = defaults.surveyTransparency;
          this.surveyBlur = defaults.surveyBlur;
          this.pageColor = defaults.pageColor;
            try { localStorage.setItem('page-color', JSON.stringify(this.pageColor)); } catch(e) {}
          this.usePageBackground = defaults.usePageBackground;
          this.selectedImage = defaults.selectedImage;
          this.backgroundRepeat = defaults.backgroundRepeat;
          this.backgroundScale = defaults.backgroundScale;
          this.imagePositionVertical = defaults.imagePositionVertical;
          this.imagePositionHorizontal = defaults.imagePositionHorizontal;

          // Clear related localStorage keys to avoid stale future loads
          const keys = [
            'survey-colorMode','survey-color','survey-transparency','survey-blur',
            'page-color','use-page-background','selected-image','background-repeat',
            'background-scale','image-position-vertical','image-position-horizontal'
          ];
          keys.forEach(k => { try { localStorage.removeItem(k); } catch(e) {} });

          // Remove any applied background image or gradient
          const pageBackground = document.getElementById('pageBackground');
          if (pageBackground) {
            pageBackground.style.backgroundImage = 'none';
            pageBackground.style.background = '';
            pageBackground.style.filter = 'none';
            pageBackground.style.transform = 'none';
            pageBackground.style.backgroundAttachment = 'initial';
          }

          // Reset slider visual fill if present
          const slider = document.querySelector('.slider');
          if (slider) slider.style.setProperty('--value', defaults.surveyTransparency + '%');

          // Re-apply styles using defaults
          this.$nextTick(() => this.applyStyles());
        }
      }
    }
    
    // Initialize slider styling on page load
    document.addEventListener('alpine:init', () => {
      // Set up slider initial state
      setTimeout(() => {
        const slider = document.querySelector('.slider');
        if (slider) {
          slider.style.setProperty('--value', '20%');
        }
      }, 100);
    });

    // Keep slider fill in sync when user drags it
    document.addEventListener('input', (e) => {
      if (e.target && e.target.classList && e.target.classList.contains('slider')) {
        const v = (parseInt(e.target.value, 10) || 0) + '%';
        e.target.style.setProperty('--value', v);
      }
    });

    // Color Picker Functionality
    let colorPickerState = {
      currentColor: { r: 255, g: 255, b: 255, a: 1 },
      colorType: 'solid',
      gradientType: 'linear',
      gradientDirection: 'to top right',
      radialShape: 'circle',
      colorStops: [
        { color: { r: 255, g: 0, b: 0, a: 1 }, position: 0 },
        { color: { r: 0, g: 0, b: 255, a: 1 }, position: 100 }
      ]
    };

    function initColorPicker() {
      drawColorCanvas();
      drawHueCanvas();
      updateColorInputs();
      updateGradientPreview();
    }

    function drawColorCanvas() {
      const canvas = document.getElementById('colorCanvas');
      const ctx = canvas.getContext('2d');
      
      // Create saturation/lightness gradient
      const gradient1 = ctx.createLinearGradient(0, 0, canvas.width, 0);
      gradient1.addColorStop(0, 'rgba(255, 255, 255, 1)');
      gradient1.addColorStop(1, 'rgba(255, 255, 255, 0)');
      
      const gradient2 = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient2.addColorStop(0, 'rgba(0, 0, 0, 0)');
      gradient2.addColorStop(1, 'rgba(0, 0, 0, 1)');
      
      ctx.fillStyle = `hsl(${colorPickerState.currentHue || 0}, 100%, 50%)`;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.fillStyle = gradient1;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.fillStyle = gradient2;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Add click handler
      canvas.onclick = (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const saturation = (x / canvas.width) * 100;
        const lightness = 100 - (y / canvas.height) * 100;
        const hue = colorPickerState.currentHue || 0;
        
        colorPickerState.currentColor = hslToRgb(hue, saturation, lightness);
        updateColorInputs();
        updateColorPreview();
      };
    }

    function drawHueCanvas() {
      const canvas = document.getElementById('hueCanvas');
      const ctx = canvas.getContext('2d');
      
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
      for (let i = 0; i <= 360; i += 60) {
        gradient.addColorStop(i / 360, `hsl(${i}, 100%, 50%)`);
      }
      
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Add click handler
      canvas.onclick = (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        colorPickerState.currentHue = (x / canvas.width) * 360;
        drawColorCanvas();
        updateColorPreview();
      };
    }

    function hslToRgb(h, s, l) {
      h /= 360;
      s /= 100;
      l /= 100;
      
      const a = s * Math.min(l, 1 - l);
      const f = n => {
        const k = (n + h * 12) % 12;
        return l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
      };
      
      return {
        r: Math.round(f(0) * 255),
        g: Math.round(f(8) * 255),
        b: Math.round(f(4) * 255),
        a: 1
      };
    }

    function updateColorInputs() {
      const color = colorPickerState.currentColor;
      document.getElementById('redInput').value = color.r;
      document.getElementById('greenInput').value = color.g;
      document.getElementById('blueInput').value = color.b;
      document.getElementById('hexInput').value = rgbToHex(color.r, color.g, color.b);
      document.getElementById('alphaSlider').value = color.a * 100;
      updateColorPreview();
    }

    function updateColorPreview() {
      const color = colorPickerState.currentColor;
      const preview = document.getElementById('colorPreview');
      const info = document.getElementById('colorCode');
      
      if (colorPickerState.colorType === 'solid') {
        const rgba = `rgba(${color.r}, ${color.g}, ${color.b}, ${color.a})`;
        preview.style.background = rgba;
        info.textContent = document.getElementById('hexInput').value;
      } else {
        const gradient = generateGradientCSS();
        preview.style.background = gradient;
        info.textContent = 'Custom Gradient';
      }
    }

    function rgbToHex(r, g, b) {
      return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    function setColorType(type) {
      colorPickerState.colorType = type;
      
      // Update button states
      document.getElementById('solidColorBtn').className = type === 'solid' ? 'btn btn-primary active-color-type' : 'btn btn-secondary';
      document.getElementById('gradientColorBtn').className = type === 'gradient' ? 'btn btn-primary active-color-type' : 'btn btn-secondary';
      
      // Show/hide sections
      document.getElementById('solidColorSection').style.display = type === 'solid' ? 'block' : 'none';
      document.getElementById('gradientSection').style.display = type === 'gradient' ? 'block' : 'none';
      
      if (type === 'gradient') {
        updateGradientPreview();
      }
      updateColorPreview();
    }

    function setGradientType(type) {
      colorPickerState.gradientType = type;
      
      // Update button states
      document.getElementById('linearBtn').className = type === 'linear' ? 'btn btn-primary active-gradient-type' : 'btn btn-secondary';
      document.getElementById('radialBtn').className = type === 'radial' ? 'btn btn-primary active-gradient-type' : 'btn btn-secondary';
      
      // Show/hide controls
      document.getElementById('linearControls').style.display = type === 'linear' ? 'block' : 'none';
      document.getElementById('radialControls').style.display = type === 'radial' ? 'block' : 'none';
      
      updateGradientPreview();
    }

    function setGradientDirection(btn) {
      // Remove active class from all direction buttons
      document.querySelectorAll('.gradient-direction-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      colorPickerState.gradientDirection = btn.dataset.direction;
      updateGradientPreview();
    }

    function setRadialShape(shape) {
      colorPickerState.radialShape = shape;
      
      // Update button states
      document.getElementById('circleBtn').className = shape === 'circle' ? 'btn btn-primary active-radial-shape' : 'btn btn-secondary';
      document.getElementById('ellipseBtn').className = shape === 'ellipse' ? 'btn btn-primary active-radial-shape' : 'btn btn-secondary';
      
      updateGradientPreview();
    }

    function generateGradientCSS() {
      const stops = colorPickerState.colorStops.map(stop => 
        `rgba(${stop.color.r}, ${stop.color.g}, ${stop.color.b}, ${stop.color.a}) ${stop.position}%`
      ).join(', ');
      
      if (colorPickerState.gradientType === 'linear') {
        return `linear-gradient(${colorPickerState.gradientDirection}, ${stops})`;
      } else {
        return `radial-gradient(${colorPickerState.radialShape}, ${stops})`;
      }
    }

    function updateGradientPreview() {
      const preview = document.getElementById('gradientPreview');
      if (preview) {
        preview.style.background = generateGradientCSS();
      }
      updateColorPreview();
    }

    function addColorStop() {
      const newStop = {
        color: { ...colorPickerState.currentColor },
        position: 50
      };
      
      colorPickerState.colorStops.push(newStop);
      renderColorStops();
      updateGradientPreview();
    }

    function renderColorStops() {
      const container = document.getElementById('colorStops');
      container.innerHTML = '';
      
      colorPickerState.colorStops.forEach((stop, index) => {
        const stopEl = document.createElement('div');
        stopEl.className = 'color-stop';
        stopEl.innerHTML = `
          <div class="color-stop-preview" style="background: rgba(${stop.color.r}, ${stop.color.g}, ${stop.color.b}, ${stop.color.a})" onclick="editColorStop(${index})"></div>
          <input type="range" min="0" max="100" value="${stop.position}" class="flex-1" onchange="updateColorStopPosition(${index}, this.value)">
          <input type="number" min="0" max="100" value="${stop.position}" class="color-stop-position form-input" onchange="updateColorStopPosition(${index}, this.value)">
          <span>%</span>
          ${colorPickerState.colorStops.length > 2 ? `<button class="remove-color-stop" onclick="removeColorStop(${index})">?</button>` : ''}
        `;
        container.appendChild(stopEl);
      });
    }

    function editColorStop(index) {
      colorPickerState.currentColor = { ...colorPickerState.colorStops[index].color };
      colorPickerState.currentStopIndex = index;
      updateColorInputs();
      
      // Switch to solid color mode to edit the color
      setColorType('solid');
    }

    function updateColorStopPosition(index, value) {
      colorPickerState.colorStops[index].position = parseInt(value);
      updateGradientPreview();
    }

    function removeColorStop(index) {
      colorPickerState.colorStops.splice(index, 1);
      renderColorStops();
      updateGradientPreview();
    }

    function closeColorPickerModal() {
      const modal = document.getElementById('colorPickerModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }

    function applyColor() {
      const target = window.colorPickerTarget;
      const api = window.__surveyStyles;
      if (!target || !api) { closeColorPickerModal(); return; }

      if (colorPickerState.colorType === 'solid') {
        const { r, g, b } = colorPickerState.currentColor;
        if (target === 'survey') {
          api.surveyColor = { r, g, b };
        } else if (target === 'page') {
          api.pageColor = { r, g, b };
        }
      } else {
        // Optional: gradient to survey background layer
        const gradientCSS = generateGradientCSS();
        const pageBackground = document.getElementById('pageBackground');
        if (target === 'page' && pageBackground) {
          pageBackground.style.background = gradientCSS;
        }
      }
      // Re-apply after change
      try { api.applyStyles(); } catch(e) {}
      closeColorPickerModal();
    }

    // Add event listeners for color input changes
    document.addEventListener('DOMContentLoaded', () => {
      // RGB inputs
      ['redInput', 'greenInput', 'blueInput'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('input', () => {
            colorPickerState.currentColor.r = parseInt(document.getElementById('redInput').value) || 0;
            colorPickerState.currentColor.g = parseInt(document.getElementById('greenInput').value) || 0;
            colorPickerState.currentColor.b = parseInt(document.getElementById('blueInput').value) || 0;
            updateColorPreview();
          });
        }
      });
      
      // Hex input
      const hexInput = document.getElementById('hexInput');
      if (hexInput) {
        hexInput.addEventListener('input', () => {
          const hex = hexInput.value;
          if (/^#[0-9A-F]{6}$/i.test(hex)) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            colorPickerState.currentColor = { r, g, b, a: colorPickerState.currentColor.a };
            updateColorInputs();
          }
        });
      }
      
      // Alpha slider
      const alphaSlider = document.getElementById('alphaSlider');
      if (alphaSlider) {
        alphaSlider.addEventListener('input', () => {
          colorPickerState.currentColor.a = alphaSlider.value / 100;
          updateColorPreview();
        });
      }
    });

    // Modal functionality
    function openUploadModal() {
      const modal = document.getElementById('uploadModal');
      const questionSettingsModal = document.getElementById('questionSettingsModal');
      
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      document.body.classList.add('modal-open');
      
      // If Question Settings modal is open, make Upload modal appear above it
      if (questionSettingsModal && questionSettingsModal.classList.contains('active')) {
        modal.classList.add('above-settings');
      } else {
        modal.classList.remove('above-settings');
      }

  // Ensure statuses are synced when opening
  syncAutoSuggestUI();
    }

    function closeUploadModal() {
      const modal = document.getElementById('uploadModal');
      const questionSettingsModal = document.getElementById('questionSettingsModal');
      
      modal.classList.remove('active');
      modal.classList.remove('above-settings'); // Reset z-index class
      
      // Only restore body overflow and remove class if Question Settings modal is not open
      if (!questionSettingsModal || !questionSettingsModal.classList.contains('active')) {
        document.body.style.overflow = '';
        document.body.classList.remove('modal-open');
      }
      
      // Reset modal state
      resetModalState();
    }

    function resetModalState() {
      document.getElementById('csvFile').value = '';
      document.getElementById('fileName').textContent = '';
      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('applyBtn').disabled = true;
      document.getElementById('removeFileBtn').classList.add('hidden');
    }

    function downloadTemplate() {
      const csvContent = 'Answer Option\n"Option 1"\n"Option 2"\n"Option 3"';
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'auto-suggest-template.csv';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function performUpload() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a CSV file');
        return;
      }

      if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a valid CSV file');
        return;
      }

      // Show uploading in-question status
      setUploadingIndicator(true);

      // Simulate upload process
      const uploadBtn = document.getElementById('uploadBtn');
      const originalText = uploadBtn.innerHTML;
      uploadBtn.innerHTML = '<i class="fal fa-spinner fa-spin"></i> <span>Uploading...</span>';
      uploadBtn.disabled = true;

      setTimeout(() => {
        uploadBtn.innerHTML = '<i class="fal fa-check"></i> <span>Uploaded</span>';
        document.getElementById('applyBtn').disabled = false;
        document.getElementById('removeStoredBtn').disabled = false;

        // Persist file name and update both UIs
        try { localStorage.setItem('autosuggestUploadedFileName', file.name); } catch(e) {}
        syncAutoSuggestUI();
        
        setTimeout(() => {
          uploadBtn.innerHTML = originalText;
          uploadBtn.disabled = false;
          // Hide uploading indicator after UI settles
          setUploadingIndicator(false);
        }, 2000);
      }, 1500);
    }

    function removeSelectedFile() {
      document.getElementById('csvFile').value = '';
      document.getElementById('fileName').textContent = '';
      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('removeFileBtn').classList.add('hidden');
    }

    function removeAutoSuggest() {
      if (confirm('Are you sure you want to remove the uploaded auto-suggest list?')) {
        document.getElementById('removeStoredBtn').disabled = true;
        document.getElementById('applyBtn').disabled = true;
  // Remove persisted file and sync
  try { localStorage.removeItem('autosuggestUploadedFileName'); } catch(e) {}
  syncAutoSuggestUI();
      }
    }

    function applyAndClose() {
      // Add logic to apply the uploaded suggestions
      const questionSettingsModal = document.getElementById('questionSettingsModal');
      
      closeUploadModal();
      
      // If Question Settings modal is still open, ensure it stays visible
      if (questionSettingsModal && questionSettingsModal.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      }
    }

    // Question Settings Modal functionality
    function openQuestionSettingsModal(type) {
      const modal = document.getElementById('questionSettingsModal');
      if(!modal) return;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      document.body.classList.add('modal-open');
      // Panel switching
      const panels = modal.querySelectorAll('.qs-panel');
      panels.forEach(p => { p.style.display = (p.dataset.type === type) ? '' : 'none'; });
      // Default fallback to autosuggest if unknown
      if(![...panels].some(p=>p.dataset.type===type)){
        const autoPanel = modal.querySelector('#qs-panel-autosuggest');
        if(autoPanel) autoPanel.style.display='';
      }
      // Toggle autosuggest-only sections outside panels
      const autoOnly = modal.querySelectorAll('.qs-autosuggest-only');
      autoOnly.forEach(el => { el.style.display = (type === 'autosuggest') ? (el.tagName === 'HR' ? 'block' : '') : 'none'; });
      if(type === 'nps') { 
        initNPSAppearance();
        // Sync modal appearance cards with current question state
        if(window.__npsAppearanceBound && window.syncNPSModal) {
          window.syncNPSModal();
        }
      }
    }

    // Apply question settings and close modal
    function applyQuestionSettings() {
      // Settings are already applied in real-time, just close modal
      closeQuestionSettingsModal();
    }

    function closeQuestionSettingsModal() {
      const modal = document.getElementById('questionSettingsModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
      document.body.classList.remove('modal-open');
    }

    // File input change handler and modal event listeners (SPA-friendly init)
    (function() {
      // Prevent double-binding across SPA navigations
      if (window.__surveyEditBindingsBound) return;
      window.__surveyEditBindingsBound = true;

      function bindOnce() {
        const fileInput = document.getElementById('csvFile');
        if (fileInput) {
          fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              document.getElementById('fileName').textContent = file.name;
              document.getElementById('uploadBtn').disabled = false;
              document.getElementById('removeFileBtn').classList.remove('hidden');
            }
          });
        }

        // Close modal when clicking outside
        const uploadModal = document.getElementById('uploadModal');
        if (uploadModal) {
          uploadModal.addEventListener('click', function(e) {
            if (e.target === this) {
              closeUploadModal();
            }
          });
        }

        // Add Question Modal event listeners
        const addQuestionModal = document.getElementById('addQuestionModal');
        if (addQuestionModal) {
          addQuestionModal.addEventListener('click', function(e) {
            if (e.target === this) {
              closeAddQuestionModal();
            }
          });
        }

        // Question Settings Modal event listeners
        const questionSettingsModal = document.getElementById('questionSettingsModal');
        if (questionSettingsModal) {
          questionSettingsModal.addEventListener('click', function(e) {
            if (e.target === this) {
              closeQuestionSettingsModal();
            }
          });
          // Delegate radio-item active state inside modal (works for dynamic panels)
          questionSettingsModal.addEventListener('click', function(e){
            const item = e.target.closest('.radio-item');
            if(item && item.querySelector('input[type="radio"]')){
              const group = item.closest('.radio-group');
              if(group){
                group.querySelectorAll('.radio-item').forEach(r=>r.classList.remove('active'));
              }
              item.classList.add('active');
              const input = item.querySelector('input[type="radio"]');
              if(input) input.checked = true;
            }
          });
          // NPS description toggle
          questionSettingsModal.addEventListener('change', function(e){
            if(e.target && e.target.id === 'nps-show-description'){
              const box = questionSettingsModal.querySelector('#nps-description-placement');
              if(box) box.style.display = e.target.checked ? 'block' : 'none';
            }
          });
        }

        // Radio button interactions for question settings
        document.querySelectorAll('#questionSettingsModal .radio-item').forEach(item => {
          item.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
              // Remove active class from siblings
              const siblings = this.closest('.radio-group').querySelectorAll('.radio-item');
              siblings.forEach(sibling => sibling.classList.remove('active'));

              // Add active class to clicked item
              this.classList.add('active');
              radio.checked = true;
            }
          });
        });

        // Checkbox interaction for question description
        const showDescriptionCheckbox = document.getElementById('showDescription');
        if (showDescriptionCheckbox) {
          showDescriptionCheckbox.addEventListener('change', function() {
            const placementOptions = document.getElementById('placementOptions');
            if (placementOptions) {
              placementOptions.style.display = this.checked ? 'block' : 'none';
            }
          });
        }

        // Keywords functionality (simplified version)
        const keywordsInput = document.querySelector('#questionSettingsModal .keywords-input input[type="text"]');
        const keywordsChips = document.querySelector('#questionSettingsModal .keywords-chips');
        const keywordsCount = document.querySelector('#questionSettingsModal .keywords-count');
        let keywords = [];

        function updateKeywordsCount() {
          if (keywordsCount) keywordsCount.textContent = keywords.length;
        }

        function renderKeywordsChips() {
          if (!keywordsChips) return;
          keywordsChips.innerHTML = '';
          keywords.forEach(keyword => {
            const chip = document.createElement('span');
            chip.className = 'keyword-chip';
            chip.textContent = keyword;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.style.marginLeft = '0.4rem';
            removeBtn.style.background = 'transparent';
            removeBtn.style.border = 'none';
            removeBtn.style.cursor = 'pointer';
            removeBtn.innerHTML = '<i class="fal fa-times"></i>';
            removeBtn.addEventListener('click', function(e) {
              e.stopPropagation();
              keywords = keywords.filter(k => k !== keyword);
              renderKeywordsChips();
              updateKeywordsCount();
            });
            
            chip.appendChild(removeBtn);
            keywordsChips.appendChild(chip);
          });
          updateKeywordsCount();
        }

        if (keywordsInput) {
          keywordsInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
              e.preventDefault();
              const value = this.value.trim();
              if (value && !keywords.includes(value) && keywords.length < 20) {
                keywords.push(value);
                renderKeywordsChips();
                this.value = '';
              }
            }
          });
        }

        // Floating tooltips via event delegation (works with SPA)
        if (!window.__surveyEditTooltipDelegated) {
          window.__surveyEditTooltipDelegated = true;
          let tipEl = null;
          let currentTarget = null;

          function ensureTip() {
            if (!tipEl) {
              tipEl = document.createElement('div');
              tipEl.className = 'floating-tooltip';
              tipEl.style.cssText = `
                position: fixed;
                background: #1f2937;
                color: white;
                padding: 0.75rem;
                border-radius: 0.375rem;
                font-size: 0.75rem;
                line-height: 1.3;
                max-width: 320px;
                box-shadow: 0 8px 26px rgba(0, 0, 0, 0.18);
                z-index: 99999;
                word-wrap: break-word;
                text-align: left;
                pointer-events: none;
                opacity: 0;
                transition: opacity 150ms ease;
              `;
              document.body.appendChild(tipEl);
            }
          }

          function showTip(target) {
            const text = target.getAttribute('data-tooltip');
            if (!text) return;
            ensureTip();
            tipEl.innerText = text;
            tipEl.style.opacity = '1';

            const rect = target.getBoundingClientRect();
            const tipRect = tipEl.getBoundingClientRect();
            const spaceAbove = rect.top;
            const spaceBelow = window.innerHeight - rect.bottom;
            let top = rect.top - tipRect.height - 10;
            let left = rect.left + (rect.width / 2) - (tipRect.width / 2);
            if (spaceAbove < tipRect.height + 12 && spaceBelow > spaceAbove) {
              top = rect.bottom + 10;
            }
            left = Math.max(8, Math.min(left, window.innerWidth - tipRect.width - 8));
            top = Math.max(8, Math.min(top, window.innerHeight - tipRect.height - 8));
            tipEl.style.left = left + 'px';
            tipEl.style.top = top + 'px';
          }

          function hideTip() {
            if (tipEl) tipEl.style.opacity = '0';
          }

          document.addEventListener('mouseover', (e) => {
            const t = e.target.closest && e.target.closest('.info-tooltip');
            if (t) {
              currentTarget = t;
              showTip(t);
            }
          });
          document.addEventListener('mouseout', (e) => {
            if (currentTarget && (!e.relatedTarget || !e.relatedTarget.closest('.info-tooltip'))) {
              hideTip();
              currentTarget = null;
            }
          });
          document.addEventListener('focusin', (e) => {
            const t = e.target.closest && e.target.closest('.info-tooltip');
            if (t) {
              currentTarget = t;
              showTip(t);
            }
          });
          document.addEventListener('focusout', (e) => {
            if (currentTarget && (!e.relatedTarget || !e.relatedTarget.closest('.info-tooltip'))) {
              hideTip();
              currentTarget = null;
            }
          });

          window.addEventListener('resize', hideTip);
          window.addEventListener('scroll', hideTip, true);
          
          // Add keyboard shortcuts
          document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Q to open Add Question modal
            if ((e.ctrlKey || e.metaKey) && e.key === 'q') {
              e.preventDefault();
              openAddQuestionModal();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
              const addQuestionModal = document.getElementById('addQuestionModal');
              const questionSettingsModal = document.getElementById('questionSettingsModal');
              const uploadModal = document.getElementById('uploadModal');
              const colorPickerModal = document.getElementById('colorPickerModal');
              const questionModeModal = document.getElementById('questionModeModal');
              
              if (questionSettingsModal && questionSettingsModal.classList.contains('active')) {
                closeQuestionSettingsModal();
              } else if (uploadModal && uploadModal.classList.contains('active')) {
                closeUploadModal();
              } else if (colorPickerModal && colorPickerModal.classList.contains('active')) {
                closeColorPickerModal();
              } else if (questionModeModal && questionModeModal.classList.contains('active')) {
                closeQuestionModeModal();
              }
            }
          });
        }

        // Listen for theme changes
        document.addEventListener('theme-changed', function(e) {
          console.log('Theme changed to:', e.detail.theme);
        });
        
        // Update slider background on input
        document.addEventListener('input', function(e) {
          if (e.target.classList.contains('slider')) {
            const value = e.target.value;
            e.target.style.setProperty('--value', value + '%');
          }
        });
      }

      function initPerLoad() {
        // Sync autosuggest UI state when this route is loaded
        try { syncAutoSuggestUI(); } catch (e) {}
        // Ensure tooltips are keyboard-focusable
        try {
          document.querySelectorAll('.info-tooltip').forEach(el => {
            if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex', '0');
            el.setAttribute('aria-describedby', '');
          });
        } catch (e) {}

        // Handle info box visibility/dismissal with persistence
        try {
          const INFO_KEY = 'autosuggestInfoDismissed';
          const infoEl = document.getElementById('autosuggestInfo');
          const okBtn = document.getElementById('autosuggestInfoOk');
          const hideCb = document.getElementById('autosuggestInfoHide');

          if (infoEl) {
            const dismissed = (function(){ try { return localStorage.getItem(INFO_KEY) === '1'; } catch(e){ return false; } })();
            if (dismissed) {
              infoEl.style.display = 'none';
            } else {
              infoEl.style.display = '';
            }
          }

          if (okBtn) {
            okBtn.addEventListener('click', function() {
              const checked = !!(hideCb && hideCb.checked);
              if (checked) {
                try { localStorage.setItem(INFO_KEY, '1'); } catch(e) {}
              }
              const el = document.getElementById('autosuggestInfo');
              if (el) el.style.display = 'none';
            });
          }
        } catch(e) {}
      }

      // Initialize now if DOM is ready, else on DOMContentLoaded
      if (document.readyState !== 'loading') {
        bindOnce();
        initPerLoad();
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          bindOnce();
          initPerLoad();
        });
      }

      // Re-init per route navigation within SPA
      window.addEventListener('spa-route-change', (e) => {
        const p = (e && e.detail && e.detail.path) || '';
        if (p.startsWith('/surveys/edit')) {
          initPerLoad();
        }
      });
    })();

    // ---- Auto-suggest UI sync helpers ----
    function syncAutoSuggestUI() {
      const statusMain = document.getElementById('mainUploadStatus');
      const removeStoredBtn = document.getElementById('removeStoredBtn');
      const questionStatus = document.getElementById('questionUploadStatus');

      let fileName = null;
      try { fileName = localStorage.getItem('autosuggestUploadedFileName'); } catch(e) {}

      if (fileName) {
        if (statusMain) statusMain.textContent = `Uploaded: ${fileName}`;
        if (removeStoredBtn) removeStoredBtn.disabled = false;
        if (questionStatus) {
          questionStatus.classList.remove('hidden');
          questionStatus.innerHTML = `<i class="fal fa-check"></i><span>Uploaded: ${fileName}</span>`;
        }
      } else {
        if (statusMain) statusMain.textContent = 'No file uploaded';
        if (removeStoredBtn) removeStoredBtn.disabled = true;
        if (questionStatus) {
          questionStatus.classList.add('hidden');
          questionStatus.innerHTML = `<i class="fal fa-spinner fa-spin"></i><span>Uploading...</span>`; // default text
        }
      }
    }

    function setUploadingIndicator(isUploading) {
      const questionStatus = document.getElementById('questionUploadStatus');
      if (!questionStatus) return;
      if (isUploading) {
        questionStatus.classList.remove('hidden');
        questionStatus.innerHTML = '<i class="fal fa-spinner fa-spin"></i><span>Uploading...</span>';
      } else {
        // Leave visibility to sync function after upload completes
      }
    }

    // ---- Add Question Modal Functions ----
    // REMOVED: Add Question functionality has been completely removed

    // ---------- NPS Dynamic Rendering ----------
    function initNPSAppearance(){
      // Avoid duplicate binding
      if(window.__npsAppearanceBound) return; window.__npsAppearanceBound = true;
      const container = document.getElementById('npsAppearanceChoices');
      if(!container) return;
      const questionCard = document.getElementById('npsQuestionCard');
      const renderTarget = document.getElementById('npsRenderContainer');
      const stored = (function(){ try{return localStorage.getItem('nps-appearance')||'radiobuttons';}catch(e){return'radiobuttons';}})();
      function setActive(style){
        container.querySelectorAll('.nps-appearance-card').forEach(btn=>{
          const active = btn.dataset.style===style;
          btn.classList.toggle('active', active);
          btn.setAttribute('aria-pressed', active?'true':'false');
        });
        questionCard && questionCard.setAttribute('data-nps-style', style);
        render(style);
        try{localStorage.setItem('nps-appearance', style);}catch(e){}
        // Dispatch a custom event for other modules to hook into
        document.dispatchEvent(new CustomEvent('nps-appearance-changed',{detail:{style}}));
      }
      function syncModalWithCurrent(){
        // Sync modal cards with current question state
        const currentStyle = (function(){ try{return localStorage.getItem('nps-appearance')||'radiobuttons';}catch(e){return'radiobuttons';}})();
        setActive(currentStyle);
      }
      function buildRadioScale(){
        const wrap = document.createElement('div');
        wrap.className = 'flex flex-wrap gap-2';
        for(let i=0;i<=10;i++){
          const label = document.createElement('label');
          label.className='cursor-pointer';
          label.innerHTML=`<input type="radio" name="npsScore" value="${i}" class="sr-only peer"><div class='w-10 h-10 rounded-xl flex items-center justify-center text-sm font-semibold border border-webropol-gray-300 text-webropol-gray-700 bg-white peer-checked:bg-gradient-to-br peer-checked:from-webropol-primary-500 peer-checked:to-webropol-primary-600 peer-checked:text-white peer-checked:border-webropol-primary-600 hover:border-webropol-primary-400 transition-all shadow-sm hover:shadow'>${i}</div>`;
          wrap.appendChild(label);
        }
        const legendRow = document.createElement('div');
        legendRow.className='flex justify-between text-xs text-webropol-gray-500 mt-3 px-1 w-full';
        legendRow.innerHTML='<span>Not at all likely</span><span>Extremely likely</span>';
        const fieldset = document.createElement('fieldset');
        fieldset.appendChild(wrap);
        fieldset.appendChild(legendRow);
        return fieldset;
      }
      function buildSlider(){
        const frag = document.createElement('div');
        frag.className='space-y-3';
        frag.innerHTML=`<input id='npsSlider' type='range' min='0' max='10' value='0' class='w-full h-2 rounded-lg appearance-none slider bg-webropol-gray-200'><div class='flex justify-between text-[11px] text-webropol-gray-500'>${Array.from({length:11},(_,i)=>`<span>${i}</span>`).join('')}</div><div class='text-xs text-webropol-primary-700 font-medium'><span id='npsSliderValue'>Selected: 0</span></div>`;
        return frag;
      }
      function buildSmileys(){
        const frag = document.createElement('div');
        frag.innerHTML=`<div class='flex justify-center gap-4' role='radiogroup' aria-label='NPS Smileys'><button type='button' data-nps-smiley='detractor' class='nps-smiley' aria-pressed='false' title='Detractor (0-6)'>??</button><button type='button' data-nps-smiley='passive' class='nps-smiley' aria-pressed='false' title='Passive (7-8)'>??</button><button type='button' data-nps-smiley='promoter' class='nps-smiley' aria-pressed='false' title='Promoter (9-10)'>??</button></div><div class='text-center mt-3 text-xs text-webropol-gray-500' id='npsSmileyHint'>Select a mood</div>`;
        return frag;
      }
      function render(style){
        if(!renderTarget) return; renderTarget.innerHTML='';
        let node;
        if(style==='radiobuttons') node = buildRadioScale();
        else if(style==='slider') node = buildSlider();
        else node = buildSmileys();
        renderTarget.appendChild(node);
        // Follow-up appears only for radiobuttons & slider (example logic)
        // Follow-up intentionally removed; no text field for NPS.
        // Add handlers
        const slider = document.getElementById('npsSlider');
        if(slider){ slider.addEventListener('input', ()=>{ const v=slider.value; const out=document.getElementById('npsSliderValue'); if(out) out.textContent='Selected: '+v; }); }
        renderTarget.querySelectorAll('.nps-smiley').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            renderTarget.querySelectorAll('.nps-smiley').forEach(b=>b.setAttribute('aria-pressed','false'));
            btn.setAttribute('aria-pressed','true');
            const hint=document.getElementById('npsSmileyHint'); if(hint){
              const map={detractor:'Detractor (0-6)',passive:'Passive (7-8)',promoter:'Promoter (9-10)'}; hint.textContent=map[btn.dataset.npsSmiley]||'Selected';
            }
          });
        });
      }
      container.addEventListener('click', (e)=>{
        const btn = e.target.closest('.nps-appearance-card');
        if(!btn) return; setActive(btn.dataset.style);
      });
      // Expose global setter for programmatic changes and modal sync
      window.setNPSAppearance = setActive;
      window.syncNPSModal = syncModalWithCurrent;
      setActive(stored);
      
      // BULLETPROOF FALLBACKS: Multiple layers to ensure NPS container is NEVER empty
      
      // Fallback #1: Immediate check
      setTimeout(()=>{
        if(renderTarget && (!renderTarget.children.length || renderTarget.innerHTML.trim() === '')){
          console.warn('NPS container empty - applying emergency fallback #1');
          setActive('radiobuttons');
        }
      }, 10);
      
      // Fallback #2: Short delay check  
      setTimeout(()=>{
        if(renderTarget && (!renderTarget.children.length || renderTarget.innerHTML.trim() === '')){
          console.warn('NPS container empty - applying emergency fallback #2');
          setActive('radiobuttons');
        }
      }, 50);
      
      // Fallback #3: Medium delay check
      setTimeout(()=>{
        if(renderTarget && (!renderTarget.children.length || renderTarget.innerHTML.trim() === '')){
          console.warn('NPS container empty - applying emergency fallback #3');
          setActive('radiobuttons');
        }
      }, 200);
      
      // Fallback #4: Long delay check
      setTimeout(()=>{
        if(renderTarget && (!renderTarget.children.length || renderTarget.innerHTML.trim() === '')){
          console.warn('NPS container empty - applying emergency fallback #4 (FINAL)');
          setActive('radiobuttons');
        }
      }, 1000);
    }
    // Render NPS appearance on first load so question reflects saved style
    document.addEventListener('DOMContentLoaded', ()=>{ try { initNPSAppearance(); } catch(e) { console.warn('NPS init failed', e); } });

    // REMOVED: closeAddQuestionModal() function has been removed

    // Copy Question: immediate duplicate to end + scroll + highlight
    let currentQuestionIdForCopy = null;

    function copyQuestionNow(questionId) {
      currentQuestionIdForCopy = questionId || null;

      const allQuestions = Array.from(document.querySelectorAll('.question-card'));
      if (!allQuestions.length) return;

      const sourceQuestion = currentQuestionIdForCopy
        ? document.querySelector(`.js-copy-btn-container[data-question-id="${currentQuestionIdForCopy}"]`)?.closest('.question-card')
        : allQuestions[allQuestions.length - 1];

      if (!sourceQuestion) return;

      // Ensure all questions except the new copy are not in edit mode
      try {
        allQuestions.forEach(card => {
          if (card.__x && card.__x.$data && typeof card.__x.$data.selected !== 'undefined') {
            card.__x.$data.selected = false;
          }
          // Also clear the visual selected class in case Alpine is not initialised
          card.classList.remove('selected');
        });
      } catch (e) {}

      const cloned = sourceQuestion.cloneNode(true);

      // Assign a brand new unique question id for the clone so Click-Question semantics keep unique
      const safeBase = (currentQuestionIdForCopy || 'q').replace(/[^a-zA-Z0-9-_]/g, '');
      const newQuestionId = `${safeBase}-copy-${Date.now()}`;

      // Update the cloned element's x-data attribute to set its own questionId
      try {
        cloned.setAttribute('x-data', `{ selected: false, questionId: '${newQuestionId}' }`);
      } catch (e) {}

      // Update any data-question-id inside the cloned DOM (eg. copy button container)
      try {
        const copyContainer = cloned.querySelector('.js-copy-btn-container');
        if (copyContainer) copyContainer.setAttribute('data-question-id', newQuestionId);
      } catch (e) {}

      // Ensure cloned question has no lingering highlight class
      cloned.classList.remove('question-card-highlighted');

      // Append clone after the last question card
      const lastQuestion = allQuestions[allQuestions.length - 1];
      if (lastQuestion && lastQuestion.parentNode) {
        lastQuestion.parentNode.insertBefore(cloned, lastQuestion.nextSibling);
      } else if (sourceQuestion.parentNode) {
        sourceQuestion.parentNode.appendChild(cloned);
      }

      // Initialize Alpine on the clone (so it receives reactivity and event handlers)
      if (window.Alpine && typeof window.Alpine.initTree === 'function'){
        try { window.Alpine.initTree(cloned); } catch(e) {}
      }

      // First broadcast to collapse any existing questions listening globally
      window.dispatchEvent(new CustomEvent('click-question', { detail: newQuestionId }));

      // Then, once Alpine has initialized on the cloned card, set selected to true and add CSS class
      setTimeout(() => {
        try {
          if (cloned.__x && cloned.__x.$data && typeof cloned.__x.$data.selected !== 'undefined') {
            cloned.__x.$data.selected = true;
          }
        } catch (e) {}
        // As a fallback apply the class so visual state is consistent
        cloned.classList.add('selected');
      }, 50);

      // Smooth scroll into view
      setTimeout(() => {
        cloned.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 50);

      // Temporary animated gradient border highlight
      cloned.classList.add('question-card-highlighted');
      setTimeout(() => {
        cloned.classList.remove('question-card-highlighted');
        // Ensure white background is restored after animation
        cloned.style.background = '#fff';
        // Reset border to default question card border color
        cloned.style.borderColor = '#e5e7eb';
        // Reset shadow to default question card shadow
        cloned.style.boxShadow = '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)';
      }, 5000);
    }


    // Question Mode Modal Functions

    function openQuestionModeModal(questionId = null) {
      currentQuestionIdForCopy = questionId;
      const modal = document.getElementById('questionModeModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      document.body.classList.add('modal-open');
      
      // Load saved preference
      const savedPosition = localStorage.getItem('questionInsertionPoint') || 'bottom';
      const rememberChoice = localStorage.getItem('rememberInsertionChoice') === 'true';
      
      // Get all radio buttons
      const topRadio = document.getElementById('insertTop');
      const afterRadio = document.getElementById('insertAfter');
      const aboveRadio = document.getElementById('insertAbove');
      const bottomRadio = document.getElementById('insertBottom');
      const rememberCheckbox = document.getElementById('rememberInsertionChoice');
      
      // Set remember checkbox
      if (rememberCheckbox) {
        rememberCheckbox.checked = rememberChoice;
      }
      
      // Clear all selections first
      [topRadio, afterRadio, aboveRadio, bottomRadio].forEach(radio => {
        if (radio) radio.checked = false;
      });
      
      // Set the saved selection
      if (savedPosition === 'top' && topRadio) {
        topRadio.checked = true;
      } else if (savedPosition === 'after' && afterRadio) {
        afterRadio.checked = true;
      } else if (savedPosition === 'above' && aboveRadio) {
        aboveRadio.checked = true;
      } else if (bottomRadio) {
        bottomRadio.checked = true;
      }
    }

    function closeQuestionModeModal() {
      const modal = document.getElementById('questionModeModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
      document.body.classList.remove('modal-open');
    }

    function setQuestionInsertionPoint(position) {
      const topRadio = document.getElementById('insertTop');
      const afterRadio = document.getElementById('insertAfter');
      const aboveRadio = document.getElementById('insertAbove');
      const bottomRadio = document.getElementById('insertBottom');
      
      // Clear all
      [topRadio, afterRadio, aboveRadio, bottomRadio].forEach(radio => {
        if (radio) radio.checked = false;
      });
      
      // Set selected
      if (position === 'top' && topRadio) {
        topRadio.checked = true;
      } else if (position === 'after' && afterRadio) {
        afterRadio.checked = true;
      } else if (position === 'above' && aboveRadio) {
        aboveRadio.checked = true;
      } else if (bottomRadio) {
        bottomRadio.checked = true;
      }
    }

    function confirmQuestionMode() {
      const topRadio = document.getElementById('insertTop');
      const afterRadio = document.getElementById('insertAfter');
      const aboveRadio = document.getElementById('insertAbove');
      const bottomRadio = document.getElementById('insertBottom');
      const rememberCheckbox = document.getElementById('rememberInsertionChoice');
      
      let selectedPosition = 'bottom';
      if (topRadio && topRadio.checked) selectedPosition = 'top';
      else if (afterRadio && afterRadio.checked) selectedPosition = 'after';
      else if (aboveRadio && aboveRadio.checked) selectedPosition = 'above';
      else if (bottomRadio && bottomRadio.checked) selectedPosition = 'bottom';
      
      const rememberChoice = rememberCheckbox ? rememberCheckbox.checked : false;
      
      // Save preferences to localStorage
      try {
        localStorage.setItem('questionInsertionPoint', selectedPosition);
        localStorage.setItem('rememberInsertionChoice', rememberChoice.toString());
      } catch (e) {
        console.warn('Could not save insertion point preference:', e);
      }
      
      // Close modal
      closeQuestionModeModal();
      
      // Show confirmation feedback
      const positionLabels = {
        'top': 'Top of page',
        'after': 'After current question',
        'above': 'Above current question',
        'bottom': 'Bottom of page'
      };
      
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9998] transition-all transform translate-x-full';
      notification.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fal fa-check-circle"></i>
          <span>Insertion point saved: ${positionLabels[selectedPosition] || 'Bottom of page'}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);
      
      // Animate out and remove
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // REMOVED: handleQuestionCopy() function has been removed
    // REMOVED: performQuestionCopy() function has been removed

    // REMOVED: selectQuestionType() function has been removed

    // REMOVED: showQuestionAddedFeedback() function has been removed

    // REMOVED: filterQuestionTypes() function has been removed

    // REMOVED: clearSearch() function has been removed

    // REMOVED: showQuestionInfo() function has been removed
      
    // Survey Settings Modal Functions
    function openSurveySettingsModal() {
      const modal = document.querySelector('webropol-survey-settings-modal');
      if (modal) {
        modal.open({
          surveyId: 'survey-12345',
          surveyName: 'Survey Name',
          settings: {
            surveyNotifications: {
              notificationEmails: false,
              limitRespondents: false,
              answerMode: 'once',
              saveContinueLater: false,
              summaryPage: false,
              mandatorySurvey: false,
              moveForwardOnly: false,
              voiceAnswering: false,
            },
            groupsActions: {
              questionGroups: null,
              forwarding: false,
              randomization: false,
              hierarchy: false,
              questionCategories: false,
              checkAnswers: false,
              ruleGroups: false,
              exportTags: false,
            },
            securityRules: {
              retentionTime: null,
              anonymity: false,
              suomiMessages: false,
              pinCode: false,
              strongAuth: false,
              ipRestrictions: false,
              caseManagement: false,
            }
          },
          onSave: (settings) => {
            console.log('Survey settings saved:', settings);
          }
        });
      }
    }
  </script>

  <!-- Survey Settings Modal -->
  <webropol-survey-settings-modal></webropol-survey-settings-modal>
  
  <!-- Add Question Modal -->
  <webropol-add-question-modal id="addQuestionModal"></webropol-add-question-modal>
</body>
</html>

